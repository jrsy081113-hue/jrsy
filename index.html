<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buttplug.js 纯净测试</title>
    <!-- 1. 引入 Buttplug.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/buttplug@3.0.3/dist/web/buttplug.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        button { font-size: 18px; padding: 10px 20px; cursor: pointer; }
        #status { margin-top: 20px; color: #555; }
        #devices { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px; }
        .device { padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; cursor: pointer; }
        .device.selected { background-color: #e0ffe0; border-color: #4CAF50;}
    </style>
</head>
<body>

    <h1>Buttplug.js 纯净环境测试</h1>
    <p>专门用于在 Bluefy 浏览器中测试 WebBluetooth</p>

    <button id="connect-btn">连接并扫描设备</button>

    <div id="status">尚未连接</div>
    <div id="devices"></div>
    <div id="controls" style="display: none; margin-top: 20px;">
        <label for="vibration-slider">振动强度:</label>
        <input type="range" id="vibration-slider" min="0" max="100" value="0">
        <button id="stop-btn">停止</button>
    </div>

    <script>
        // --- 纯净环境下的 JavaScript ---

        let buttplugClient = null;
        let connectedDevice = null;

        const connectBtn = document.getElementById('connect-btn');
        const statusDiv = document.getElementById('status');
        const devicesDiv = document.getElementById('devices');
        const controlsDiv = document.getElementById('controls');
        const slider = document.getElementById('vibration-slider');
        const stopBtn = document.getElementById('stop-btn');

        function initializeButtplug() {
            if (buttplugClient) return;
            try {
                buttplugClient = new Buttplug.ButtplugClient("Pure Test App");
                buttplugClient.on("deviceadded", updateDeviceList);
                buttplugClient.on("deviceremoved", updateDeviceList);
                console.log("客户端实例已创建");
            } catch (e) {
                console.error("创建客户端实例失败:", e);
                statusDiv.textContent = "错误: 库初始化失败!";
            }
        }

        async function connect() {
            if (!buttplugClient) {
                initializeButtplug();
            }
            if (!buttplugClient) {
                statusDiv.textContent = "初始化失败，无法连接。";
                return;
            }

            statusDiv.textContent = "正在请求蓝牙权限...";
            try {
                if (buttplugClient.connected) {
                    await buttplugClient.disconnect();
                }
                statusDiv.textContent = "请在弹出的窗口中选择设备...";
                await buttplugClient.connect();
                statusDiv.textContent = "连接成功！";
            } catch (e) {
                statusDiv.textContent = `连接失败: ${e.message}`;
                console.error("连接失败:", e);
            }
        }
        
        function updateDeviceList() {
            devicesDiv.innerHTML = '<h4>可用设备:</h4>';
            if (buttplugClient.devices.length === 0) {
                devicesDiv.innerHTML += '<p>未发现设备</p>';
                controlsDiv.style.display = 'none';
            } else {
                buttplugClient.devices.forEach(device => {
                    const isSelected = connectedDevice && connectedDevice.index === device.index;
                    devicesDiv.innerHTML += `<div class="device ${isSelected ? 'selected' : ''}" onclick="selectDevice(${device.index})">${device.name}</div>`;
                });
            }
        }
        
        function selectDevice(deviceIndex) {
            const device = buttplugClient.devices.find(d => d.index === deviceIndex);
            if (device) {
                connectedDevice = device;
                if (device.vibrateAttributes.length > 0) {
                    controlsDiv.style.display = 'block';
                    slider.value = 0;
                } else {
                    controlsDiv.style.display = 'none';
                    alert('该设备不支持振动。');
                }
                updateDeviceList();
            }
        }

        async function setVibration(value) {
            if (!connectedDevice) return;
            const speed = parseInt(value, 10) / 100.0;
            try {
                await connectedDevice.vibrate(speed);
            } catch (e) { console.error("振动失败:", e); }
        }
        
        async function stopVibration() {
            if (connectedDevice) {
                try {
                    await connectedDevice.vibrate(0);
                    slider.value = 0;
                } catch (e) { console.error("停止失败:", e); }
            }
        }

        // --- 事件绑定 ---
        connectBtn.addEventListener('click', connect);
        slider.addEventListener('input', (e) => setVibration(e.target.value));
        stopBtn.addEventListener('click', stopVibration);
        
        // 页面加载时立即初始化
        initializeButtplug();
    </script>
</body>
</html>
