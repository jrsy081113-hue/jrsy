<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <title>jrsy</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://jrsy081113-hue.github.io/jrsy/star-icon.png">
    <link rel="apple-touch-icon-precomposed" href="https://jrsy081113-hue.github.io/jrsy/star-icon.png">
    <style id="customBubblePreviewStyle"></style>
    <style id="customBubbleStyle"></style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

html {
    height: 100%;
    overflow: hidden;
    position: fixed;
    width: 100%;
}

       body {
    font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
    background: #000;
    touch-action: manipulation;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    transition: all 0.3s ease;
    color: var(--text-color, #000);
    /* 【关键】这里不要有任何padding-top或padding-bottom */
}

        .phone {
    width: 100vw;
    /* 【默认】PWA模式使用vh */
    height: 100vh;
    /* 其他样式保持不变... */
    background: var(--theme-bg, #f7f7f7);
    position: relative;
    overflow: hidden;
    touch-action: manipulation; 
    border-radius: var(--phone-radius, 0px);
    transition: all 0.3s ease;
}

/* 【关键】只在非PWA模式（浏览器模式）下使用dvh */
@media not all and (display-mode: standalone) {
    .phone {
        height: 100dvh;
    }
}

        .screen {
            width: 100%;
            height: 100%;
            background: var(--theme-bg, #f7f7f7);
            position: relative;
            overflow: hidden;
            border-radius: var(--screen-radius, 0px);
            transition: all 0.3s ease;
        }

        /* --- MODIFIED: Status Bar Styles --- */
        /* --- 步骤 3.1: 精确重构状态栏 --- */

.status-bar {
    height: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    font-size: var(--font-size, 14px);
    font-weight: 600;
    color: var(--text-color, #000);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    border-radius: var(--status-radius, 0px);
    transition: background-color 0.3s ease;
    background-color: var(--nav-bg, #f8f8f8); 
}

        
        /* New classes for JS to control transparency */
        .phone.home-screen-active .status-bar,
        .phone.listen-together-active .status-bar {
            background-color: transparent;
        }
        
        .phone.home-screen-active .status-bar {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .wechat-dark-mode.home-screen-active .status-bar {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .phone.listen-together-active .status-bar {
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        /* [NEW] Voice call status bar color */
        .phone.voice-call-active .status-bar {
             color: #fff;
             background-color: transparent;
             text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }


        .status-left {
            display: flex;
            align-items: center;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 1px;
        }

        .signal-icon {
            width: 18px;
            height: 12px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }

        .signal-bar {
            width: 3px;
            background: var(--text-color, #000);
            border-radius: 1px;
        }
        
        .phone.listen-together-active .signal-bar,
        .phone.voice-call-active .signal-bar {
             background: #fff;
        }

        .signal-bar:nth-child(1) { height: 3px; }
        .signal-bar:nth-child(2) { height: 6px; }
        .signal-bar:nth-child(3) { height: 9px; }
        .signal-bar:nth-child(4) { height: 12px; }

        .network-icon {
            width: 28px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color, #000);
            margin: 0 2px;
        }
        
        .phone.listen-together-active .network-icon,
        .phone.voice-call-active .network-icon {
            color: #fff;
        }

        .network-icon svg {
            width: 100%;
            height: 100%;
        }

        .battery-icon {
            width: 24px;
            height: 12px;
            border: 1px solid var(--text-color, #000);
            border-radius: var(--small-radius, 2px);
            position: relative;
            background: transparent;
            transition: all 0.3s ease;
        }
        
        .phone.listen-together-active .battery-icon,
        .phone.voice-call-active .battery-icon {
            border-color: #fff;
        }

        .battery-level {
            height: 100%;
            background: var(--text-color, #000);
            width: 80%;
            border-radius: var(--small-radius, 1px);
            transition: all 0.3s ease;
        }
        
        .phone.listen-together-active .battery-level,
        .phone.voice-call-active .battery-level {
             background: #fff;
        }

        .battery-tip {
            position: absolute;
            right: -3px;
            top: 3px;
            width: 2px;
            height: 6px;
            background: var(--text-color, #000);
            border-radius: 0 var(--small-radius, 1px) var(--small-radius, 1px) 0;
            transition: all 0.3s ease;
        }

        .phone.listen-together-active .battery-tip,
        .phone.voice-call-active .battery-tip {
             background: #fff;
        }

        .home-screen {
            height: 100%;
            background-size: cover;
            background-position: center;
            padding: 0;
            display: flex;
            flex-direction: column;
            margin-top: 0;
            position: relative;
            overflow-y: auto; 
            padding-bottom: 120px; /* Space for the bottom dock */
        }
        
        /* --- NEW: Profile Widget Container --- */
        /* --- 【最终版】请替换为这段代码 --- */

.profile-widget-container {
    width: 85%;
    max-width: 340px;
    /* 改为简单固定的边距 */
    margin: 70px auto 20px; 
    background-color: var(--bg-primary, white);
    border-radius: var(--app-radius, 14px);
    padding: 20px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

        .profile-widget-container.transparent-bg {
            background-color: transparent;
            box-shadow: none;
        }
        .profile-widget-container .profile-widget {
            margin: 0 auto; /* Override its own margin */
            padding: 0;
            width: 100%;
        }


       

        .profile-avatar-widget {
            width: 80px;
            height: 80px;
            border-radius: var(--avatar-radius, 50%);
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(240,248,255,0.8) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #4a90e2;
            border: 3px solid rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 auto 15px;
        }

        .widget-info-section {
            background: transparent;
            padding: 0 20px;
            text-align: center;
        }

        .profile-name-widget {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-color, #333333);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            margin-bottom: 8px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .profile-signature-widget {
            font-size: 14px;
            color: var(--text-color, #555555);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            font-style: italic;
            cursor: pointer;
            transition: color 0.2s ease;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .profile-location {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: var(--text-color, #666666);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .location-icon {
            width: 14px;
            height: 14px;
            margin-right: 4px;
            fill: currentColor;
        }
        
        .home-widgets-container {
            display: flex;
            gap: 15px;
            padding: 0 20px;
            width: 100%;
            max-width: 340px;
            margin: 30px auto 0;
            align-items: flex-start;
        }
        
        .new-widget {
            flex: 1;
            aspect-ratio: 1 / 1;
            background-color: var(--bg-primary, white);
            border-radius: var(--app-radius, 14px);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* --- NEW: Small widget transparent style --- */
        .new-widget.transparent-bg {
            background-color: transparent;
            box-shadow: none;
        }

        .widget-header-text {
            font-size: 12px;
            font-family: monospace;
            cursor: pointer;
            color: var(--text-color, #333);
        }

        .widget-bubble {
            background-color: var(--bg-hover, #f5f5f5);
            border-radius: 20px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 500;
             color: var(--text-color, #333);
        }
        .widget-bubble span {
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        .widget-bubble img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            object-fit: cover;
            background-color: #ccc;
        }
        .wechat-dark-mode .widget-bubble {
            background-color: #3a3a3c;
        }


        .app-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            aspect-ratio: 1 / 1;
            justify-items: center;
            align-content: space-between;
        }

        .app {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .app-icon-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: var(--app-radius, 14px);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.8);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
        }
        
        .app-icon-container .app-icon {
            width: 45%;
            height: 45%;
        }


        .app-icon {
            width: 32px;
            height: 32px;
            fill: #000;
            filter: none;
        }
        
        .app.wechat .app-icon { 
            fill: #000; 
        }

        .app-label {
            margin-top: 6px;
            color: #333; 
            font-size: 10px;
            font-weight: 600;
        }

        /* --- MODIFIED: Bottom Dock Styles --- */
    /* --- 用这个最终版代码替换你原来的 .bottom-dock --- */
.bottom-dock {
    position: absolute;
    /* 
     * 【决定性修复】
     * 删除了 "+ env(safe-area-inset-bottom, 0px)"
     * 因为父容器 .phone 的高度已经通过JS精确计算好了，
     * 我们不再需要在这里重复计算安全距离。
     */
    bottom: 20px; 
    
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 30px);
    max-width: 380px;
    height: 95px; 
    background: rgba(240, 240, 240, 0.7); 
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 40px; 
    padding: 10px 20px;
    display: flex;
    gap: 15px;
    justify-content: center;
    align-items: center;
    z-index: 50;
}
        .wechat-dark-mode .bottom-dock {
            background: rgba(44, 44, 46, 0.7); /* MODIFIED: Frosted glass effect for dark mode */
        }
        .bottom-dock .app {
            width: 100%;
            flex: 1;
        }
        .bottom-dock .app-icon-container {
            width: 75%; 
            max-width: 55px;
            margin: 0 auto;
        }
        .bottom-dock .app-label {
            margin-top: 5px; 
            font-size: 10px; 
            font-weight: 600;
            color: var(--text-color);
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--theme-bg, #f7f7f7);
            display: none;
            flex-direction: column;
            padding-top: 0;
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }

        .page.active {
            display: flex;
            transform: translateX(0);
        }

        #homeScreen {
            transform: translateX(0);
        }

        
        #homeScreen.inactive {
            transform: translateX(-100%);
        }
        
        .page:not(.active) {
            transform: translateX(100%);
        }

        /* MODIFIED: Top Navigation Bar for Centering Title */
        /* 替换为下面的新代码 */

/* --- 步骤 3.2: 精确重构导航栏 --- */
.nav-bar {
    height: 44px;
    background: var(--nav-bg, #f8f8f8);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 8px;
    flex-shrink: 0;
    position: absolute;
    /* 【关键】它的顶部位置，精确地等于状态栏的高度 */
    top: calc(30px + env(safe-area-inset-top, 0px)); 
    left: 0;
    right: 0;
    z-index: 10;
}

        /* 替换为下面的新代码 */
.nav-title {
    position: absolute;   /* 魔法1：让标题"漂浮"起来 */
    left: 50%;            /* 魔法2：把它推到中线位置 */
    top: 50%;
    transform: translate(-50%,-50%); /* 魔法3：再把它往回拉自己的一半，实现完美居中 */
    
    /* 以下是保留的样式 */
    text-align: center;
    font-size: var(--nav-font-size, 17px);
    font-weight: 600;
    color: var(--text-color, #000);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%; /* 添加一个最大宽度，防止标题太长和两边按钮重叠 */
}

        
     .page > .wechat-content,
.page > .settings-content,
.page > .discover-content,
.page > .profile-content,
.page > .chat-settings-content,
.page > .diary-content-view,
#phoneApp > .phone-app-container {
    padding-top: 74px; /* <--- 修改为 74px */
    height: 100%;
    overflow-y: auto;
}

        /* 修复BUG：为微信主界面的内容容器添加顶部内边距 */
        /* 修复BUG：为微信主界面的内容容器添加顶部内边距 */
#wechatApp > .wechat-content {
    padding-top: 74px; 
}
        /* 修复BUG：移除子元素的无效顶部内边距，防止双重边距 */
        #wechatApp .discover-content, #wechatApp .profile-content {
            padding-top: 0;
        }

        .nav-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-color, #000);
            cursor: pointer;
            padding: 4px 12px;
            border-radius: var(--btn-radius, 6px);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        /* --- 步骤 2.4: 替换 .wechat-bottom-nav 样式，正确处理安全区 --- */
.wechat-bottom-nav {
    /* 【决定性修复】让导航栏的总高度动态增加，以填满底部安全区 */
    height: calc(49px + env(safe-area-inset-bottom, 0px));
    
    background: var(--nav-bg, #f7f7f7);
    border-top: 1px solid var(--border-color, #e0e0e0);
    display: flex;
    position: absolute;
    
    /* 【决定性修复】让它紧贴容器的物理底部 */
    bottom: 0;
    
    width: 100%;
    z-index: 100;
    
    /* 【新增】确保内边距不会影响高度计算 */
    box-sizing: border-box;
    /* 【新增】只在底部增加内边距来把 *图标和文字* 推上去，而不是整个元素上移 */
    padding-bottom: env(safe-area-inset-bottom, 0px);
}

        .wechat-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #999;
            font-size: var(--small-font-size, 10px);
        }

        .wechat-tab.active {
            color: #07c160;
        }

        .wechat-tab-icon {
            font-size: 18px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-chat, .icon-discover, .icon-profile {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        /* --- 步骤 2.5: 替换 .wechat-content 样式，适配新的导航栏高度 --- */
.wechat-content {
    flex: 1;
    overflow-y: auto;
    /* 【决定性修复】使用和导航栏同样的方式动态计算底部间距 */
    padding-bottom: calc(49px + env(safe-area-inset-bottom, 0px));
    
    background: var(--theme-bg, #f7f7f7);
    transition: padding-bottom 0.3s ease;
}

        .friend-list {
            padding: 0;
            background: var(--theme-bg, #f7f7f7);
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
            cursor: pointer;
            background: var(--bg-primary, white);
            position: relative;
        }

        .friend-item:hover {
            background: var(--bg-hover, #f5f5f5);
        }

        .friend-item.pinned {
            background: var(--bg-hover, #f5f5f5);
        }

        .friend-item.pinned + .friend-item:not(.pinned) {
            margin-top: 8px;
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: var(--friend-avatar-radius, 8px);
            background: var(--bg-primary, white);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color, #333);
            font-weight: bold;
            margin-right: 12px;
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border-color, #e0e0e0);
            transition: all 0.3s ease;
            flex-shrink: 0; 
        }

        .friend-info {
            flex: 1;
            min-width: 0; 
        }

        .friend-name {
            font-size: var(--font-size, 16px);
            color: var(--text-color, #333);
            margin-bottom: 2px;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .friend-message {
            font-size: var(--small-font-size, 13px);
            color: var(--text-secondary, #999);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* --- [BUG FIX] White Module Fix START --- */
        #chatScreen .wechat-content {
            padding-top: 74px;
            padding-bottom: 0; /* Remove padding from container */
            background: transparent; /* Make container transparent */
            height: 100%;
            overflow: hidden; /* Prevent double scrollbars */
        }
        
        .chat-messages {
            height: 100%;
            padding: 15px 15px 50px 15px; /* Add default bottom padding here */
            overflow-y: auto;
            background-size: cover;
            background-position: center;
            position: relative;
            transition: padding-bottom 0.3s ease;
        }
        /* --- [BUG FIX] White Module Fix END --- */

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start; /* MODIFIED: Set to flex-start for downward growth */
            max-width: 100%;
            position: relative;
        }

        .message.sent {
            justify-content: flex-end;
        }
        
        .message-sender-name {
            font-size: 12px;
            color: var(--text-secondary, #888);
            margin-bottom: 4px;
            padding: 0 4px;
        }

        .message .message-body {
            display: flex;
            flex-direction: column;
            min-width: 0; /* 修复Flexbox压缩问题 */
            flex: 1; /* 新增：确保消息主体占据可用空间 */
            position: relative; /* For blocked icon */
            max-width: calc(100% - 55px); /* [FIX] Prevent content from overlapping avatar */
        }

        .message.received .message-body {
            align-items: flex-start;
        }

        .message.sent .message-body {
            align-items: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 10px 14px;
            font-size: var(--font-size, 15px);
            line-height: 1.4;
            word-wrap: break-word;
            word-break: break-word;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            cursor: pointer;
            position: relative;
            border-radius: var(--message-radius, 18px);
            color: var(--text-color, #000000);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            -webkit-user-select: text; /* Allow text selection */
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* --- Bubble tails DISABLED --- */
        .message-content:not(.has-image):not(.has-emoji)::before {
            display: none;
        }
        .message.received .message-content:not(.has-image):not(.has-emoji)::before {
            display: none;
        }
        .message.sent .message-content:not(.has-image):not(.has-emoji)::before {
            display: none;
        }

        .message-content img {
            max-width: 180px;
            max-height: 180px;
            border-radius: 6px;
            display: block;
            cursor: pointer;
        }

        /* MODIFIED: Don't use bubble for images/emojis */
        .message-content.has-image,
        .message-content.has-emoji,
        .message-content.has-location {
            padding: 0;
            background-color: transparent;
            box-shadow: none;
            max-width: 250px; /* [FIX] Give location card a max-width */
        }
        
        /* MODIFIED: Emoji size adjustment */
        .message-content.has-emoji img {
            max-width: 100px;
            max-height: 100px;
        }

        .message.received .message-content {
            background-color: var(--message-received-bg, #E6F2FF);
        }

        .message.sent .message-content {
            background-color: var(--message-sent-bg, #FFEEF6);
        }
        
        .message.recalled .message-content,
        .message.pat_pat .message-content {
            background: transparent;
            color: var(--text-secondary, #999);
            font-style: italic;
            padding: 6px 0;
            font-size: var(--small-font-size, 13px);
            text-align: center;
            box-shadow: none;
            border-radius: 0;
            margin: 0 auto;
            max-width: 200px;
        }
        
        .message.recalled .message-content::before,
        .message.pat_pat .message-content::before {
            display: none;
        }

        .quoted-message {
            background: rgba(0,0,0,0.05);
            padding: 8px 10px;
            border-left: 3px solid #07c160;
            margin-bottom: 8px;
            border-radius: var(--small-radius, 4px);
            font-size: var(--small-font-size, 13px);
            color: var(--text-secondary, #666);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .message.sent .quoted-message {
            border-left-color: var(--sent-quote-border-color, #d9b8c7);
        }
        .message.received .quoted-message {
            border-left-color: var(--received-quote-border-color, #c0d9ff);
        }
        .wechat-dark-mode .message.sent .quoted-message {
             border-left-color: var(--sent-quote-border-color, #0056b3);
             background: rgba(255,255,255,0.1);
        }
        .wechat-dark-mode .message.received .quoted-message {
            border-left-color: var(--received-quote-border-color, #555);
            background: rgba(255,255,255,0.1);
        }

        .chat-input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex; /* FIX */
            flex-direction: column; /* FIX */
        }
        
        /* 这是修改后的代码 */
.chat-input {
    background: var(--nav-bg, #f7f7f7);
    border-top: 1px solid var(--border-color, #e0e0e0);
    display: flex;
    align-items: flex-end; 
    padding: 12px 8px;      /* 修改了这里：增加了上下留白 */
    gap: 8px;
    position: relative;
    z-index: 100;
    transition: min-height 0.2s ease;
    min-height: 60px;       /* 修改了这里：增加了整体最小高度 */
}

        .chat-input textarea {
            flex: 1;
            min-height: 35px;
            max-height: 120px; /* Limit max height */
            border: 1px solid var(--border-color, #d1d1d6);
            border-radius: var(--input-radius, 17px);
            padding: 8px 15px;
            font-size: var(--font-size, 15px);
            outline: none;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            transition: all 0.3s ease;
            background: var(--bg-primary, white);
            color: var(--text-color, #000);
            resize: none;
            line-height: 1.4;
            overflow-y: auto;
        }

        .chat-btn {
            width: 35px;
            height: 35px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size, 16px);
            transition: all 0.2s;
            background: transparent;
            color: var(--text-color, #333);
            border-radius: 50%;
            flex-shrink: 0;
            transition: transform 0.2s ease, width 0.2s ease, opacity 0.2s ease;
        }
        
        .send-btn {
            background: transparent;
            border-radius: var(--input-radius, 17px);
            transition: color 0.3s ease, background-color 0.3s ease, transform 0.2s ease, width 0.2s ease, opacity 0.2s ease, padding 0.2s ease;
            transform: scale(0.9);
            opacity: 0;
            width: 0;
            padding: 0;
        }
        
        #voiceBtn {
            transition: transform 0.2s ease, width 0.2s ease, opacity 0.2s ease;
        }


        .send-btn.active {
            transform: scale(1);
            opacity: 1;
            width: 35px;
            padding: 0;
            background-color: #007aff;
            color: white;
        }

        .chat-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .send-btn svg {
            width: 20px;
            height: 20px;
            transform: rotate(-45deg) translate(1px, -1px);
        }
        .send-btn.active svg {
             fill: white;
        }

        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: var(--chat-avatar-radius, 8px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color, #333);
            font-weight: bold;
            font-size: var(--small-font-size, 14px);
            margin: 0 8px 0 0;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            background-color: var(--bg-primary, white);
            border: 1px solid var(--border-color, #e0e0e0);
            transition: all 0.3s ease;
        }

        .message.sent .chat-avatar {
            margin: 0 0 0 8px;
            order: 2; /* [FIX] Ensure avatar is always on the outside */
        }
        .message.sent .message-body {
            order: 1; /* [FIX] Ensure message body is before avatar */
        }
        
        .chat-functions, .emoji-picker {
            background: var(--bg-primary, white);
            border-top: 1px solid var(--border-color, #e0e0e0);
            z-index: 50;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0;
        }

        .chat-input-area.functions-open .chat-functions,
        .chat-input-area.emoji-open .emoji-picker {
            max-height: 250px;
        }

        .function-menu {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
        }

        .function-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-radius: var(--function-radius, 8px);
            transition: all 0.2s ease;
        }

        .function-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--function-radius, 12px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 5px;
            color: var(--text-secondary, #666);
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            background-color: var(--bg-hover, #f0f0f0);
        }
        
        .wechat-dark-mode .function-icon {
            background-color: #3a3a3c;
        }

        .function-icon svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .function-label {
            font-size: var(--small-font-size, 12px);
            color: var(--text-color, #333);
            text-align: center;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }
        
        .emoji-picker-header {
            display: flex;
            justify-content: flex-end;
            padding: 5px 15px 0 15px;
            gap: 10px;
        }

        .emoji-picker-btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
        }
        .emoji-picker-btn.manage {
            background: #8e8e93;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .emoji-grid .function-item {
            padding: 5px;
            position: relative;
        }
        
        .emoji-grid .function-icon {
            width: 50px;
            height: 50px;
        }

        .emoji-delete-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 59, 48, 0.9);
            color: white;
            border-radius: 50%;
            border: 1px solid white;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            line-height: 18px;
            cursor: pointer;
            transform: translate(30%, -30%);
        }
        .emoji-grid.managing .emoji-delete-btn {
            display: flex;
        }

        .message-menu {
            position: fixed;
            background: var(--bg-primary, white);
            border-radius: var(--menu-radius, 12px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
            padding: 8px;
            transition: all 0.3s ease;
            flex-direction: row;
            gap: 8px;
            opacity: 0;
            transform: scale(0.9);
            transform-origin: top left;
        }

        .message-menu.show {
            display: flex;
            opacity: 1;
            transform: scale(1);
        }

        .message-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: var(--font-size, 14px);
            color: var(--text-color, #333);
            border-radius: var(--btn-radius, 6px);
            transition: all 0.2s ease;
            background: var(--bg-hover, #f5f5f5);
            white-space: nowrap;
        }

        .message-menu-item.danger {
            color: #ff3b30;
        }

        .recall-message, .pat-pat-message {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .recall-content, .pat-pat-content {
            background: rgba(0,0,0,0.05);
            padding: 6px 12px;
            border-radius: var(--recall-radius, 12px);
            font-size: var(--small-font-size, 13px);
            color: var(--text-secondary, #999);
            text-align: center;
            transition: all 0.3s ease;
        }

        .recall-content {
            cursor: pointer;
        }

        .select-mode {
            background: var(--bg-hover, #f0f0f0);
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color, #e0e0e0);
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .select-mode.show {
            display: flex;
        }

        .select-btn {
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: var(--btn-radius, 6px);
            padding: 8px 16px;
            cursor: pointer;
            font-size: var(--small-font-size, 14px);
            transition: all 0.3s ease;
        }

        .favorite-item {
            position: relative;
        }

        .favorite-item.selected {
            background: #e3f2fd;
        }

        .favorite-item.pinned + .favorite-item:not(.pinned) {
            margin-top: 8px;
        }

        .favorite-checkbox, .message-checkbox {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: var(--checkbox-radius, 50%);
            background: var(--bg-primary, white);
            display: none;
            transition: all 0.3s ease;
        }

        .select-mode.show .favorite-checkbox,
        .multi-select-mode .message-checkbox {
            display: block;
        }

        .select-mode.show .favorite-item {
            padding-left: 50px;
        }

        .favorite-item.selected .favorite-checkbox,
        .message.selected .message-checkbox {
            background: #007aff;
            border-color: #007aff;
        }

        .favorite-item.selected .favorite-checkbox::after,
        .message.selected .message-checkbox::after {
            content: '✓';
            color: white;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: var(--small-font-size, 12px);
        }

        .multi-select-mode .message {
            padding-left: 35px;
        }

        .multi-select-mode .message-checkbox {
            left: 5px;
        }

        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto; 
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: var(--font-size, 16px);
            color: var(--text-color, #333);
            margin-bottom: 8px;
            font-weight: 500;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            height: 44px;
            border: 1px solid var(--border-color, #d1d1d6);
            border-radius: var(--form-radius, 8px);
            padding: 0 15px;
            font-size: var(--font-size, 16px);
            outline: none;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            transition: all 0.3s ease;
            background: var(--bg-primary, white);
            color: var(--text-color, #000);
        }

        .form-textarea {
            height: 80px;
            padding: 12px 15px;
            resize: vertical;
        }
        
        .form-select {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        .model-select-container {
            position: relative;
        }

        .model-select {
            width: 100%;
            height: 44px;
            border: 1px solid var(--border-color, #d1d1d6);
            border-radius: var(--form-radius, 8px);
            padding: 0 40px 0 15px;
            font-size: var(--font-size, 16px);
            outline: none;
            cursor: pointer;
            background: var(--bg-primary, white);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            transition: all 0.3s ease;
            color: var(--text-color, #000);
        }

        .dropdown-arrow {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: var(--small-font-size, 12px);
            color: var(--text-secondary, #666);
        }

        .model-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary, white);
            border: 1px solid var(--border-color, #d1d1d6);
            border-top: none;
            border-radius: 0 0 var(--form-radius, 8px) var(--form-radius, 8px);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            transition: all 0.3s ease;
        }

        .model-dropdown.show {
            display: block;
        }

        .model-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
            font-size: var(--font-size, 16px);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            color: var(--text-color, #000);
        }

        .model-option:last-child {
            border-bottom: none;
        }

        .settings-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .settings-btn {
            flex: 1;
            height: 44px;
            border: none;
            border-radius: var(--btn-radius, 8px);
            font-size: var(--font-size, 16px);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-secondary {
            background: var(--btn-secondary-bg, #f2f2f7);
            color: #007aff;
        }

        .btn-danger {
            background: #ff3b30;
            color: white;
        }
        
        .discover-content, .profile-content {
            flex: 1; 
            overflow-y: auto; 
            color: var(--text-secondary, #666);
            font-size: var(--font-size, 16px);
        }

        /* --- 步骤 4: 修正 .add-menu 菜单位置 --- */
.add-menu {
    position: absolute;
    /* 【关键修改】使用动态计算，确保它永远在导航栏下方 */
    top: calc(74px + env(safe-area-inset-top, 0px));
    right: 15px;
    background: var(--bg-primary, white);
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: var(--menu-radius, 8px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 100;
    display: none;
    min-width: 120px;
    transition: all 0.3s ease;
}

        .add-menu.show {
            display: block;
        }

        .add-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
            font-size: var(--font-size, 16px);
            color: var(--text-color, #333);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .add-menu-item:last-child {
            border-bottom: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }
        
        #playlistModal { z-index: 1001; }
        #addMusicModal { z-index: 1002; }
        #alertModal, #confirmModal, #worldBookBindingModal, #heartsVoiceModal { z-index: 10000; }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary, white);
            border-radius: var(--modal-radius, 12px);
            padding: 20px;
            width: 85%;
            max-width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        /* World Book Modal Size Increase */
        #addWorldBookModal .modal-content, #editWorldBookModal .modal-content {
            max-width: 500px;
            width: 90%;
        }

        .avatar-upload {
            width: 80px;
            height: 80px;
            border-radius: var(--upload-radius, 12px);
            background: var(--bg-hover, #f0f0f0);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            cursor: pointer;
            border: 2px dashed var(--border-color, #ccc);
            font-size: 24px;
            color: var(--text-secondary, #999);
            background-size: cover;
            background-position: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .avatar-upload input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .discover-menu {
            padding: 0 15px;
        }
        
        #wechatProfile .profile-section {
            margin: 0 15px 15px;
        }

        .discover-menu-item {
            background: var(--bg-primary, white);
            border-radius: var(--menu-item-radius, 12px);
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .discover-menu-left {
            display: flex;
            align-items: center;
        }

        .discover-menu-icon {
            width: 32px;
            height: 32px;
            margin-right: 12px;
            fill: currentColor;
        }

        .discover-menu-title {
            font-size: var(--font-size, 18px);
            font-weight: 600;
            color: var(--text-color, #333);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .diary-list, .favorite-list {
            padding: 0;
            overflow-y: auto;
        }

        /* MODIFIED: New styles for Diary friend list */
        .diary-content-view {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #diaryFriendList {
            flex-shrink: 0;
            overflow-y: auto;
        }
        #diaryContentArea {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .worldbook-list {
             padding: 10px;
        }
        .worldbook-folder {
            background: var(--bg-hover, #f5f5f5);
            margin-bottom: 10px;
            border-radius: 12px;
            overflow: hidden;
        }
        .worldbook-folder-header {
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .worldbook-item-actions, .worldbook-folder-actions {
            display: flex;
            align-items: center;
        }
        
        .worldbook-folder-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: var(--bg-primary, white);
        }
        .worldbook-folder-header.expanded + .worldbook-folder-content {
            max-height: 1000px;
        }
        .folder-arrow {
            transition: transform 0.3s;
        }
        .worldbook-folder-header.expanded .folder-arrow {
            transform: rotate(90deg);
        }

        .diary-item, .worldbook-item, .favorite-item {
            background: var(--bg-primary, white);
            margin: 10px 15px;
            border-radius: var(--item-radius, 12px);
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .worldbook-item {
            margin: 0 10px 10px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .worldbook-item-info {
            flex-grow: 1;
            cursor: pointer;
        }

        .diary-meta, .worldbook-meta {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .diary-avatar {
            width: 30px;
            height: 30px;
            border-radius: var(--diary-avatar-radius, 6px);
            background: var(--bg-primary, white);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color, #333);
            font-weight: bold;
            margin-right: 10px;
            font-size: var(--small-font-size, 12px);
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border-color, #e0e0e0);
            transition: all 0.3s ease;
        }

        .diary-author, .worldbook-title {
            font-size: var(--small-font-size, 14px);
            font-weight: 600;
            color: var(--text-color, #333);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .diary-date {
            font-size: var(--small-font-size, 12px);
            color: var(--text-secondary, #999);
            margin-left: auto;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .diary-content, .worldbook-content, .favorite-content {
            font-size: var(--font-size, 15px);
            line-height: 1.5;
            color: var(--text-color, #333);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }
        
        /* [NEW] Voice Call End Message Style */
        .message-content.has-voice-call-end {
            background-color: var(--message-received-bg, #E6F2FF);
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .message.sent .message-content.has-voice-call-end {
             background-color: var(--message-sent-bg, #FFEEF6);
        }
        .message-content.has-voice-call-end .call-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        .message.sent .message-content.has-voice-call-end .call-icon {
            transform: scaleX(-1);
        }

        .message-content .invite-card, .message-content .accept-card {
            background: var(--bg-primary, #fff);
            color: var(--text-color, #000);
            padding: 12px 15px;
            border-radius: 10px;
            width: 230px;
            border: 1px solid var(--border-light, #f0f0f0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .invite-card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .invite-card-body {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            padding: 10px 0;
            border-top: 1px solid var(--border-light, #f0f0f0);
            border-bottom: 1px solid var(--border-light, #f0f0f0);
        }
        .invite-card-icon-container {
            width: 32px;
            height: 32px;
            background-color: #07c160;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .invite-card-icon-container svg {
            width: 18px;
            height: 18px;
            fill: white;
        }
        .invite-card-footer, .accept-card-footer {
            font-size: 12px;
            color: var(--text-secondary, #999);
            margin-top: 8px;
        }
        .accept-card-body {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 15px;
            padding: 10px 0;
            font-weight: 500;
        }
        
        /* --- [UI/UX ENHANCEMENT] Transfer Card Styles --- */
        .message-content .transfer-card {
            background: #F9953F;
            color: white;
            padding: 10px 12px;
            border-radius: 10px;
            width: 200px;
            cursor: pointer;
            transition: filter 0.2s;
            display: block; 
            position: relative;
        }
        .message-content .transfer-card:hover {
            filter: brightness(0.95);
        }
        .message-content .transfer-card.disabled {
            background-color: #FDEFE1; /* Light beige color for received transfers */
            color: #D3A27F; /* Darker text for contrast */
            cursor: default;
        }
        .message-content .transfer-card.disabled .transfer-card-footer,
        .message-content .transfer-card.disabled .transfer-card-amount,
        .message-content .transfer-card.disabled .transfer-card-remark {
            color: #D3A27F;
        }
        .message-content .transfer-card.disabled .transfer-card-icon-container svg {
            fill: #D3A27F;
        }
        .message-content .transfer-card.disabled .transfer-card-footer {
            border-top: 1px solid rgba(211, 162, 127, 0.3);
        }
        .transfer-card-body {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .transfer-card-icon-container {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .transfer-card-icon-container svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        .transfer-card-info {
            flex-grow: 1;
            min-width: 0;
        }
        .transfer-card-amount {
            font-size: 18px;
            font-weight: bold;
            white-space: nowrap;
        }
        .transfer-card-remark {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0.9;
        }
        .transfer-card-footer {
            font-size: 12px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* New style for the confirmation card */
        .message-content .transfer-confirm-card {
            background: #FDEFE1;
            color: #D3A27F;
            padding: 10px 12px;
            border-radius: 10px;
            width: 200px;
            cursor: default;
        }
        .transfer-confirm-card .transfer-card-body {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .transfer-confirm-card .transfer-card-icon-container {
            width: 24px;
            height: 24px;
        }
        .transfer-confirm-card .transfer-card-icon-container svg {
            width: 100%;
            height: 100%;
            fill: #D3A27F;
        }
        .transfer-confirm-card .transfer-confirm-info {
            flex-grow: 1;
        }
        .transfer-confirm-card .transfer-card-amount {
            font-size: 16px;
        }
        .transfer-confirm-card .transfer-card-status {
            font-size: 14px;
        }
        .transfer-confirm-card .transfer-card-footer {
            border-top: 1px solid rgba(211, 162, 127, 0.3);
            color: #D3A27F;
        }


        /* --- [FIXED] Voice Message Styles --- */
        .message-content.has-voice {
            padding: 0;
            background: transparent;
            box-shadow: none;
            display: flex;
            align-items: center;
        }
        .voice-message-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: var(--message-radius, 18px);
            min-width: 80px;
            transition: background-color 0.2s;
            position: relative;
        }
        .voice-message-bar::before {
            display: none; /* Hide bubble tail */
        }
        .message.sent .voice-message-bar {
            background-color: var(--message-sent-bg, #FFEEF6);
        }
        .message.received .voice-message-bar {
            background-color: var(--message-received-bg, #E6F2FF);
        }
        
        .voice-play-icon svg {
            width: 20px;
            height: 20px;
            fill: var(--text-color, #333);
        }

        .message.received .voice-play-icon svg {
            transform: rotate(90deg);
        }
        .message.sent .voice-play-icon svg {
            transform: rotate(-90deg);
        }
        
        .voice-duration {
            font-size: var(--font-size, 15px);
            color: var(--text-color, #333);
            margin: 0 4px;
        }
        .voice-text-content {
            padding: 10px;
            margin-top: 8px;
            border-radius: 8px;
            background: var(--bg-hover, #f0f0f0);
            font-size: var(--font-size, 15px);
            line-height: 1.4;
            display: none; /* Hidden by default */
        }


        .modal-title {
            font-size: var(--font-size, 18px);
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            color: var(--text-color, #000);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color, #d1d1d6);
            border-radius: var(--form-radius, 8px);
            font-size: var(--font-size, 16px);
            margin-bottom: 10px;
            outline: none;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            transition: all 0.3s ease;
            background: var(--bg-primary, white);
            color: var(--text-color, #000);
        }

        .modal-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid var(--border-color, #d1d1d6);
            border-radius: var(--form-radius, 8px);
            font-size: var(--font-size, 16px);
            margin-bottom: 15px;
            outline: none;
            resize: vertical;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            transition: all 0.3s ease;
            background: var(--bg-primary, white);
            color: var(--text-color, #000);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--btn-radius, 8px);
            font-size: var(--font-size, 16px);
            cursor: pointer;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            transition: all 0.3s ease;
        }

        .modal-btn-cancel {
            background: var(--btn-secondary-bg, #f2f2f7);
            color: var(--text-secondary, #666);
        }

        .modal-btn-confirm {
            background: #007aff;
            color: white;
        }
        
        #momentsScreen .wechat-content {
            padding-top: 32px;
            background-color: var(--bg-primary, white);
        }
        .moments-cover {
            position: relative;
            height: 250px;
            background-size: cover;
            background-position: center;
            background-color: #ccc;
            margin-bottom: 20px;
        }
        .moments-cover-user {
            position: absolute;
            right: 15px;
            bottom: -15px;
            display: flex;
            align-items: center;
        }
        .moments-cover-name {
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            margin-right: 10px;
        }
        .moments-cover-avatar {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            border: 2px solid white;
            background-size: cover;
            background-position: center;
            background-color: #eee;
        }

        .moments-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
            background: var(--bg-primary, white);
            transition: all 0.3s ease;
        }

        .moments-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .moments-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--moments-avatar-radius, 6px);
            margin-right: 12px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }

        .moments-info {
            flex-grow: 1;
        }

        .moments-name {
            font-size: var(--font-size, 16px);
            font-weight: 600;
            color: #586b95;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            cursor: pointer;
        }

        .moments-content {
    font-size: var(--font-size, 16px);
    line-height: 1.5;
    color: var(--text-color, #333);
    margin-top: 5px;   /* 新增：向下推一点 */
    margin-bottom: 5px; /* 修改：减小底部间距 */
    font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
    white-space: pre-wrap;
}

        .moments-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .moments-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .moments-time {
            font-size: var(--small-font-size, 12px);
            color: var(--text-secondary, #999);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .moments-actions {
            position: relative;
        }

        /* --- MODIFIED: Moments Action Button --- */
        .moments-actions-btn {
            width: 28px;
            height: 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: #586b95;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 1px;
        }
        .moments-actions-menu {
            position: absolute;
            right: 30px;
            bottom: -5px;
            background: #4c4c4c;
            border-radius: 6px;
            display: flex;
            overflow: hidden;
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.2s ease;
        }
        .moments-actions-menu.show {
            transform: scaleX(1);
        }
        .moments-action {
            padding: 8px 12px;
            cursor: pointer;
            color: white;
            font-size: 14px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .moments-action svg {
            width: 16px;
            height: 16px;
            fill: none;
            stroke: white;
            stroke-width: 2px;
        }
        .moments-action:first-child {
            border-right: 1px solid #666;
        }
        
        /* --- MODIFIED: Moments Likes/Comments --- */
        .moments-likes-comments {
            margin-top: 10px;
            background: var(--bg-hover, #f5f5f5);
            border-radius: 4px;
            font-size: 14px;
            /* margin-left: 52px; /* 40px avatar + 12px margin */
        }
        .moments-likes {
            padding: 8px 12px;
            color: #586b95;
            border-bottom: 1px solid var(--border-light, #e0e0e0);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .moments-likes svg {
            width: 14px;
            height: 14px;
            fill: none;
            stroke: #586b95;
            stroke-width: 2px;
        }
        .moments-comments-list {
            padding: 8px 12px;
        }
        .moments-comment-author {
    color: #586b95;
    font-weight: 600;
    margin-right: -7px; /* 新增：减小冒号后的间距 */
}

        /* 新增或修改：增大评论之间的间隔 */
        .moments-comments-list .moments-comment-item {
            margin-bottom: 8px; /* 调整这个值来改变间隔大小 */
        }
        /* 确保最后一条评论下方没有多余间隔 */
        .moments-comments-list .moments-comment-item:last-child {
            margin-bottom: 0;
        }

        
        #momentCommentInputArea {
            position: fixed;
            bottom: -100px;
            left: 0;
            right: 0;
            padding: 10px;
            background: var(--nav-bg, #f7f7f7);
            border-top: 1px solid var(--border-color, #e0e0e0);
            display: flex;
            gap: 10px;
            z-index: 2000;
            transition: bottom 0.3s ease;
        }
        #momentCommentInputArea.show {
            bottom: 0;
        }
        #momentCommentInput {
            flex: 1;
            border: 1px solid var(--border-color, #d1d1d6);
            border-radius: 18px;
            padding: 8px 15px;
        }
        #momentCommentSendBtn {
            padding: 8px 15px;
            border-radius: 18px;
            border: none;
            background: #07c160;
            color: white;
        }

        .profile-section {
            background: var(--bg-primary, white);
            margin-bottom: 15px;
            border-radius: var(--section-radius, 8px);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .profile-header {
            background: var(--bg-primary, white);
            padding: 20px;
            text-align: center;
            color: var(--text-color, #333);
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: var(--profile-avatar-radius, 12px);
            background: var(--bg-primary, white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            margin: 0 auto 10px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border-color, #e0e0e0);
            transition: all 0.3s ease;
        }

        .profile-name {
            font-size: var(--font-size, 20px);
            font-weight: 600;
            cursor: pointer;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .profile-menu {
            padding: 0;
        }

        .profile-menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-primary, white);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            color: var(--text-color, #333);
        }

        .profile-menu-item:last-child {
            border-bottom: none;
        }
        
        .chat-settings-content {
            flex: 1;
            overflow-y: auto; 
        }

        .settings-menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-primary, white);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            color: var(--text-color, #333);
        }
        
        .settings-menu-item.danger {
            color: #ff3b30;
            justify-content: center;
        }

        .settings-menu-item:last-child {
            border-bottom: none;
        }
        
        .page > .modal-content-container {
            padding-top: 60px;
            height: 100%;
            overflow-y: auto;
        }
        
        .page > .modal-content-container > .modal-content {
            height: auto;
            max-height: none;
            width: 100%;
            max-width: none;
            border-radius: 0;
            box-shadow: none;
        }


        .background-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .background-option {
            aspect-ratio: 1;
            border-radius: var(--bg-option-radius, 8px);
            cursor: pointer;
            border: 2px solid transparent;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary, #666);
            font-size: var(--small-font-size, 12px);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            transition: all 0.3s ease;
        }

        .background-option.selected {
            border-color: #007aff;
        }

        .background-option.default {
            background: var(--bg-default, #ededee);
        }

        .background-upload {
            background: var(--bg-hover, #f0f0f0);
            border: 2px dashed var(--border-color, #ccc);
            position: relative;
        }

        .background-upload input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .balance-display {
            text-align: center;
            padding: 40px 20px;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: bold;
            color: var(--text-color, #333);
            margin-bottom: 10px;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .balance-label {
            font-size: var(--font-size, 16px);
            color: var(--text-secondary, #666);
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .wallet-menu {
            padding: 20px;
        }

        .wallet-menu-item {
            background: var(--bg-primary, white);
            border-radius: var(--wallet-item-radius, 12px);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .font-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
        }

        .font-option {
            padding: 15px;
            border: 1px solid var(--border-color, #e0e0e0);
            border-radius: var(--font-option-radius, 8px);
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-primary, white);
        }

        .font-option.selected {
            border-color: #007aff;
            background: #f0f9ff;
        }

        .font-option.system {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .font-option.custom {
            font-family: var(--custom-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: var(--bg-primary, white);
            border-radius: var(--control-radius, 8px);
            border: 1px solid var(--border-color, #e0e0e0);
            transition: all 0.3s ease;
        }

        .font-size-slider {
            flex: 1;
            height: 6px;
            border-radius: var(--slider-radius, 3px);
            background: #ddd;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.3s ease;
        }

        .font-size-slider::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: var(--thumb-radius, 50%);
            background: #007aff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .font-color-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: var(--bg-primary, white);
            border-radius: var(--control-radius, 8px);
            border: 1px solid var(--border-color, #e0e0e0);
            transition: all 0.3s ease;
        }

        .color-picker {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: var(--color-radius, 4px);
            cursor: pointer;
            outline: none;
        }

        .color-code-input {
            flex: 1;
            height: 30px;
            border: 1px solid var(--border-color, #d1d1d6);
            border-radius: var(--form-radius, 4px);
            padding: 0 10px;
            font-size: var(--small-font-size, 14px);
            outline: none;
            font-family: monospace;
            transition: all 0.3s ease;
            background: var(--bg-primary, white);
            color: var(--text-color, #000);
        }

        .auto-diary-btn {
            position: fixed;
            bottom: 60px; /* Adjusted for nav bar */
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: var(--diary-btn-radius, 25px);
            background: #007aff;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary, white);
            border: 1px solid var(--border-color, #e0e0e0);
            border-top: none;
            border-radius: 0 0 var(--form-radius, 8px) var(--form-radius, 8px);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            transition: all 0.3s ease;
        }

        .search-results.show {
            display: block;
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
            cursor: pointer;
            font-size: var(--small-font-size, 14px);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-keyword {
            background: #dddddd; 
            padding: 2px 4px;
            border-radius: var(--keyword-radius, 2px);
            transition: all 0.3s ease;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #007aff;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .wechat-rounded {
            --wechat-item-radius: 16px;
            --wechat-avatar-radius: 10px;
            --wechat-message-radius: 18px;
            --wechat-input-radius: 20px;
            --wechat-btn-radius: 10px;
            --wechat-nav-radius: 0px;
        }

        .wechat-rounded .friend-item {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin: 0 15px;
            border-radius: 0;
        }

        .wechat-rounded .friend-item.pinned:first-of-type {
            border-top-left-radius: var(--wechat-item-radius);
            border-top-right-radius: var(--wechat-item-radius);
        }

        .wechat-rounded .friend-item.pinned:not(:has(+ .friend-item.pinned)) {
            border-bottom-left-radius: var(--wechat-item-radius);
            border-bottom-right-radius: var(--wechat-item-radius);
        }

        .wechat-rounded .friend-item:not(.pinned):first-of-type,
        .wechat-rounded .friend-item.pinned + .friend-item:not(.pinned) {
            border-top-left-radius: var(--wechat-item-radius);
            border-top-right-radius: var(--wechat-item-radius);
            margin-top: 16px;
        }

        .wechat-rounded .friend-item:not(.pinned):last-child {
            border-bottom-left-radius: var(--wechat-item-radius);
            border-bottom-right-radius: var(--wechat-item-radius);
        }

        .wechat-rounded .friend-avatar {
            border-radius: var(--wechat-avatar-radius);
        }

        .wechat-rounded .message-content {
            border-radius: var(--wechat-message-radius);
        }

        .wechat-rounded .chat-input textarea {
            border-radius: var(--wechat-input-radius);
        }

        .wechat-rounded .chat-btn {
            border-radius: var(--wechat-input-radius);
        }

        .wechat-rounded .nav-btn {
            border-radius: var(--wechat-btn-radius);
        }

        .wechat-rounded .moments-item,
        .wechat-rounded .diary-item,
        .wechat-rounded .worldbook-item,
        .wechat-rounded .favorite-item {
            border-radius: var(--wechat-item-radius);
        }

        .wechat-rounded .modal-content,
        .wechat-rounded .message-menu,
        .wechat-rounded .add-menu {
            border-radius: var(--wechat-item-radius);
        }

        .wechat-rounded .settings-menu-item {
            margin: 0 15px;
            border-radius: 0;
        }
        
        .wechat-rounded .discover-menu-item {
            border-radius: var(--wechat-item-radius);
        }

        .wechat-rounded .settings-menu-item:first-child {
            border-top-left-radius: var(--wechat-item-radius);
            border-top-right-radius: var(--wechat-item-radius);
        }

        .wechat-rounded .settings-menu-item:last-child {
            border-bottom-left-radius: var(--wechat-item-radius);
            border-bottom-right-radius: var(--wechat-item-radius);
        }

        .wechat-dark-mode {
            --theme-bg: #1c1c1e;
            --nav-bg: #2c2c2e;
            --bg-primary: #2c2c2e;
            --bg-hover: #3a3a3c;
            --bg-selected: #4a4a4c;
            --text-color: #ffffff;
            --text-secondary: #8e8e93;
            --border-color: #3a3a3c;
            --border-light: #3a3a3c;
            --btn-secondary-bg: #3a3a3c;
            --btn-secondary-hover: #4a4a4c;
            --message-received-bg: #3a3a3c;
            --message-sent-bg: #007aff;
            --chat-bg: #1c1c1e;
            --bg-default: #1c1c1e;
        }
        
        .wechat-dark-mode .settings-menu-item {
            color: var(--text-color);
        }
        
        .wechat-dark-mode .settings-menu-item.danger {
            color: #ff453a;
        }
        
        .wechat-dark-mode .app-label {
            color: #eee;
        }
        .wechat-dark-mode .app-icon-container {
             background: rgba(44,44,46,0.8);
        }
        .wechat-dark-mode .profile-name-widget, .wechat-dark-mode .profile-signature-widget, .wechat-dark-mode .profile-location {
            color: #eee;
            text-shadow: none;
        }
        .wechat-dark-mode .moments-actions-btn {
            background-color: #3a3a3c;
        }


        .multi-select-toolbar {
            position: fixed;
            bottom: 50px;
            left: 0;
            right: 0;
            height: 50px;
            background: var(--nav-bg, #f7f7f7);
            border-top: 1px solid var(--border-color, #e0e0e0);
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 150;
        }

        .multi-select-toolbar.show {
            display: flex;
        }

        .multi-select-count {
            font-size: var(--font-size, 16px);
            color: var(--text-color, #333);
        }

        .multi-select-actions {
            display: flex;
            gap: 15px;
        }

        .multi-select-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--btn-radius, 6px);
            font-size: var(--small-font-size, 14px);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .multi-select-btn.delete {
            background: #ff3b30;
            color: white;
        }

        .multi-select-btn.cancel {
            background: var(--btn-secondary-bg, #f2f2f7);
            color: var(--text-color, #333);
        }

        :root {
            --font-size: 14px;
            --small-font-size: 12px;
            --nav-font-size: 17px;
            --text-color: #000;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --custom-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --sent-quote-border-color: #d9b8c7;
            --received-quote-border-color: #c0d9ff;
        }

        .recalled-message-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary, white);
            border-radius: var(--modal-radius, 12px);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 3000;
            display: none;
            max-width: 80%;
            max-height: 60%;
            overflow-y: auto;
        }

        .recalled-message-popup.show {
            display: block;
        }

        .recalled-message-title {
            font-size: var(--font-size, 18px);
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: var(--text-color, #333);
        }

        .recalled-message-content {
            font-size: var(--font-size, 16px);
            line-height: 1.4;
            color: var(--text-color, #333);
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-hover, #f5f5f5);
            border-radius: var(--small-radius, 8px);
        }

        .recalled-message-close {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: var(--btn-radius, 8px);
            background: #007aff;
            color: white;
            font-size: var(--font-size, 16px);
            cursor: pointer;
        }

        .font-url-control {
            margin: 20px 0;
            padding: 15px;
            background: var(--bg-primary, white);
            border-radius: var(--control-radius, 8px);
            border: 1px solid var(--border-color, #e0e0e0);
            transition: all 0.3s ease;
        }

        .font-url-input {
            width: 100%;
            height: 35px;
            border: 1px solid var(--border-color, #d1d1d6);
            border-radius: var(--form-radius, 4px);
            padding: 0 10px;
            font-size: var(--font-size, 14px);
            outline: none;
            font-family: monospace;
            transition: all 0.3s ease;
            background: var(--bg-primary, white);
            color: var(--text-color, #000);
            margin-top: 5px;
        }

        .bubble-settings {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 15px;
        }

        .bubble-color-group {
            background: var(--bg-primary, white);
            border-radius: var(--control-radius, 8px);
            border: 1px solid var(--border-color, #e0e0e0);
            padding: 15px;
        }

        .bubble-color-label {
            font-size: var(--font-size, 16px);
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color, #333);
        }

        .bubble-color-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bubble-color-picker {
            width: 40px;
            height: 30px;
            border: none;
            border-radius: var(--color-radius, 4px);
            cursor: pointer;
            outline: none;
        }

        .bubble-color-input {
            flex: 1;
            height: 30px;
            border: 1px solid var(--border-color, #d1d1d6);
            border-radius: var(--form-radius, 4px);
            padding: 0 10px;
            font-size: var(--small-font-size, 14px);
            outline: none;
            font-family: monospace;
            transition: all 0.3s ease;
            background: var(--bg-primary, white);
            color: var(--text-color, #000);
        }

        .bubble-css-group {
            background: var(--bg-primary, white);
            border-radius: var(--control-radius, 8px);
            border: 1px solid var(--border-color, #e0e0e0);
            padding: 15px;
        }

        .bubble-css-textarea {
            width: 100%;
            min-height: 120px;
            border: 1px solid var(--border-color, #d1d1d6);
            border-radius: var(--form-radius, 4px);
            padding: 10px;
            font-size: var(--small-font-size, 14px);
            outline: none;
            font-family: monospace;
            resize: vertical;
            transition: all 0.3s ease;
            background: var(--bg-primary, white);
            color: var(--text-color, #000);
        }
        
        .bubble-preview-area {
            background: #ededee;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .bubble-preview-area .message {
            max-width: 100%;
        }
        .bubble-preview-area .message-content {
            box-shadow: none;
        }
        .bubble-preview-area .chat-avatar {
             background: #ccc;
             color: #333;
        }

        .icon-setting-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
        }
        .icon-setting-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #eee;
            background-size: cover;
            background-position: center;
        }
        .icon-setting-label {
            flex-grow: 1;
            font-size: var(--font-size, 16px);
            color: var(--text-color);
        }
        .icon-setting-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #007aff;
            color: #007aff;
            background: none;
            cursor: pointer;
        }
        .icon-setting-btn input {
            display: none;
        }

        #message-notification {
            position: fixed;
            top: -120px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.95);
            color: black;
            border-radius: 12px;
            padding: 15px;
            z-index: 9999;
            transition: top 0.5s ease-in-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            cursor: pointer;
        }
        #message-notification.show {
            top: 50px;
        }
        #notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-right: 12px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            background-color: #eee;
        }
        #notification-content {
            flex-grow: 1;
            overflow: hidden;
        }
        #notification-sender {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 3px;
        }
        #notification-message {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #alertModal .modal-content {
            max-height: 40vh;
        }
        #alertMessage {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
            text-align: center;
            white-space: pre-wrap;
        }
        
        /* NEW: Image Description Modal Styles */
        #imageDescriptionModal .modal-content, #cameraDescriptionModal .modal-content {
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
        }
        #imageDescriptionContent {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap; /* Preserve line breaks */
            word-wrap: break-word;
            text-align: left;
            max-height: 50vh;
            overflow-y: auto;
            background-color: var(--bg-hover, #f5f5f5);
            padding: 10px;
            border-radius: 8px;
        }

        .multi-select-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 5px;
        }
        .multi-select-item {
            padding: 8px;
            display: flex;
            align-items: center;
        }
        .multi-select-item input {
            margin-right: 10px;
        }
        
        .worldbook-binding-list details {
            margin-bottom: 5px;
        }
        .worldbook-binding-list summary {
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
        }
        .worldbook-binding-list summary input {
            margin-right: 10px;
        }
        .worldbook-binding-list .folder-content {
            padding-left: 20px;
        }
        
        #floatingPlayer {
            position: fixed;
            top: auto; /* Allow dragging to override */
            left: auto; /* Allow dragging to override */
            bottom: 70px;
            right: 15px;
            width: 180px;
            height: 50px;
            background-color: var(--bg-primary, white);
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            align-items: center;
            padding: 5px;
            cursor: grab;
            transition: opacity 0.3s, transform 0.3s;
        }
        #floatingPlayer.show {
            display: flex;
        }
        #floatingPlayerArt {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            margin-right: 8px;
            flex-shrink: 0;
            animation: vinyl-spin 10s linear infinite;
            animation-play-state: running;
        }
        #floatingPlayerInfo {
            flex-grow: 1;
            overflow: hidden;
            font-size: 11px;
            color: var(--text-secondary, #666);
        }
        #floatingPlayerTitle {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-color, #333);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #floatingPlayerSubtitle {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #floatingPlayerCloseBtn {
            background: none;
            border: none;
            color: var(--text-secondary, #999);
            font-size: 18px;
            cursor: pointer;
            padding: 0 5px;
            margin-left: 5px;
            flex-shrink: 0;
            line-height: 1;
        }


        /* --- Listen Together Styles --- */
        @keyframes vinyl-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #listenTogetherScreen {
            background-color: #1a1a1a;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 0;
            z-index: 500;
        }

        .listen-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            z-index: -1;
            transition: background-image 0.5s ease;
        }

        .listen-header {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: absolute;
            top: 44px; /* MODIFIED: was 40px */
            width: 100%;
            z-index: 20;
        }
        .listen-header .nav-btn { color: #fff; font-size: 16px; }
        .listen-header .nav-btn svg { width: 18px; height: 18px; }
        
        .listen-header-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        
        .listen-avatars-container {
            position: absolute;
            top: 120px; /* MODIFIED */
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 64px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .listen-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            background-size: cover;
            background-position: center;
            background-color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            position: absolute;
            z-index: 2;
            cursor: pointer;
        }
        #listenFriendAvatar {
            left: 0;
        }
        #listenUserAvatar {
            right: 0;
        }
        
        .headphone-arc {
            position: absolute;
            top: -15px;
            left: 50%;
            width: 110px;
            height: 55px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-bottom: none;
            border-radius: 55px 55px 0 0;
            transform: translateX(-50%);
            z-index: 1;
        }
        
        .headphone-arc::before, .headphone-arc::after {
            content: '♡';
            position: absolute;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }
        .headphone-arc::before {
            top: 5px; left: -15px;
            transform: rotate(-30deg);
        }
        .headphone-arc::after {
            top: 5px; right: -15px;
            transform: rotate(30deg);
        }

        .listen-main {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 44px;
        }

        .vinyl-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            height: 320px;
            z-index: 5;
        }

        .vinyl-record {
            width: 100%;
            height: 100%;
            /* background-image: url('https://i.imgur.com/8s15m4g.png'); */ /* BUG FIX: Removed rectangular background */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            animation: vinyl-spin 20s linear infinite;
            animation-play-state: paused;
            transition: background-image 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vinyl-record.playing {
            animation-play-state: running;
        }

        .album-art {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            overflow: hidden;
            box-shadow: 0 0 0 15px rgba(10, 10, 10, 0.8); /* 模拟黑胶边缘 */
        }
        
        #listenTogetherChatOverlay {
            position: absolute;
            top: 210px; /* MODIFIED */
            left: 0;
            right: 0;
            height: 60px;
            z-index: 15;
            pointer-events: none;
            overflow: hidden;
        }

        #listenTogetherChatOverlay .message {
            position: absolute;
            max-width: 60%;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 14px;
            color: #fff;
            opacity: 0;
            transition: all 0.5s ease;
            pointer-events: all;
            will-change: transform, opacity;
        }
        #listenTogetherChatOverlay .message.show {
            opacity: 1;
        }
        
        #listenTogetherChatOverlay .message.received {
            background-color: rgba(0,0,0,0.5);
            left: 15px;
            transform: translateX(-20px);
        }
         #listenTogetherChatOverlay .message.received.show {
            transform: translateX(0);
        }

        #listenTogetherChatOverlay .message.sent {
            background-color: rgba(90, 90, 90, 0.7);
            right: 15px;
            transform: translateX(20px);
        }
        #listenTogetherChatOverlay .message.sent.show {
            transform: translateX(0);
        }
        
        /* MODIFIED: Moved chat button up */
        #listenTogetherChatWrapper {
            position: absolute;
            bottom: 160px; 
            right: 15px;
            z-index: 30;
            display: flex;
            flex-direction: row-reverse;
            align-items: center;
            gap: 8px;
        }
        
        #listenTogetherChatToggleBtn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0,0,0,0.4);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        #listenTogetherChatToggleBtn svg {
            width: 20px;
            height: 20px;
        }
        
        #listenTogetherChatInputContainer {
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 0; /* MODIFIED */
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        #listenTogetherChatWrapper.expanded #listenTogetherChatInputContainer {
            max-width: 300px; /* MODIFIED */
            opacity: 1;
            transform: translateX(0);
        }

        #listenTogetherChatInput {
            flex: 1;
            height: 38px;
            border-radius: 19px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(0,0,0,0.4);
            color: #fff;
            padding: 0 15px;
            font-size: 14px;
            outline: none;
        }
        #listenTogetherChatInput::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        #listenTogetherSendBtn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #listenTogetherSendBtn:active {
            transform: scale(0.9);
        }
        #listenTogetherSendBtn svg {
            width: 20px;
            height: 20px;
            fill: #333;
            transform: rotate(-45deg) translate(1px, -1px);
        }
        
        .listen-chat-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(0,0,0,0.4);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            padding: 0;
        }
        .listen-chat-btn svg {
            width: 20px;
            height: 20px;
        }
        
        #songLyrics {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.6);
            height: 80px;
            overflow: hidden;
            text-align: center;
            position: absolute;
            bottom: 210px; /* MODIFIED: Moved up */
            width: 90%;
            max-width: 400px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #songLyrics p {
            line-height: 25px;
            transition: all 0.3s ease;
            margin: 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        #songLyrics .active-lyric {
            color: #fff;
            font-weight: bold;
            transform: scale(1.1);
        }
        #songLyrics .sub-lyric {
            transform: scale(0.9);
            opacity: 0.7;
        }

        .listen-controls {
            padding: 15px 20px 30px;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
            flex-shrink: 0;
            position: absolute;
            bottom: 0;
            width: 100%;
            z-index: 10;
        }

        .listen-progress-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        .listen-progress-bar input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            outline: none;
        }

        .listen-progress-bar input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        .listen-buttons {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 15px;
        }
        
        .listen-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 10px;
        }
        .listen-btn svg { width: 24px; height: 24px; fill: #fff; }
        .listen-btn.play-pause svg { width: 40px; height: 40px; }
        .listen-btn.liked svg { fill: #ff4d4d; }

        #playlistModal.modal.show {
            justify-content: flex-end;
            align-items: flex-end;
            background: none;
        }

        #playlistModal .modal-content {
            width: 100%;
            max-width: none;
            height: 50vh;
            border-radius: 16px 16px 0 0;
            padding: 0;
        }

        .playlist-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color, #e0e0e0);
        }

        /* MODIFIED: Changed Add Music button to a plus icon */
        #openAddMusicBtn {
            background: none;
            border: 1px solid var(--border-color, #e0e0e0);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 20px;
            color: var(--text-color, #333);
            cursor: pointer;
            line-height: 28px;
            text-align: center;
        }
        
        .playlist-list {
            height: calc(50vh - 55px);
            overflow-y: auto;
        }

        .playlist-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .playlist-item.playing {
            color: #07c160;
        }
        .playlist-item-info {
            flex-grow: 1;
        }
        .playlist-item-title {
            font-size: 16px;
        }
        .playlist-item-artist {
            font-size: 12px;
            color: #999;
        }
        .playlist-item.playing .playlist-item-artist {
            color: #07c160;
        }
        .playlist-item-delete-btn {
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 18px;
            cursor: pointer;
        }

        /* MODIFIED: Increased z-index for Add Music Modal */
        #addMusicModal {
            z-index: 1002;
        }


        /* --- NEW/MODIFIED: Phone App Styles --- */
        .phone-app-container {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        #simulatedPhoneScreen {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 20px 10px 20px; /* MODIFIED: adjusted padding */
            background-color: var(--theme-bg, #f7f7f7);
        }
        .wechat-dark-mode #simulatedPhoneScreen {
             background-color: var(--theme-bg, #1c1c1e);
        }

        .sim-phone-frame {
            width: 100%;
            max-width: 380px;
            height: calc(100% - 10px); /* MODIFIED: Taller phone */
            max-height: 844px;
            background-color: #111;
            border: 8px solid #000;
            border-radius: 40px;
            padding: 15px 5px 5px 5px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .sim-phone-screen {
            flex-grow: 1;
            background-color: #fff;
            border-radius: 30px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .wechat-dark-mode .sim-phone-screen {
             background-color: #000;
        }
        
        .sim-phone-screen-content {
             flex-grow: 1;
             overflow-y: auto;
             background-size: cover;
             background-position: center;
        }

        .sim-app-grid {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .sim-app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
        }

        .sim-app-icon-img {
            width: 50px;
            height: 50px;
            background-color: #e5e5e5; /* MODIFIED: monochrome */
            border-radius: 12px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .wechat-dark-mode .sim-app-icon-img {
            background-color: #3a3a3c;
        }

        .sim-app-icon-img svg {
            width: 28px;
            height: 28px;
            fill: #000; /* MODIFIED: monochrome */
        }
        .wechat-dark-mode .sim-app-icon-img svg {
            fill: #fff;
        }


        .sim-app-icon-label {
            font-size: 11px;
            color: var(--text-color, #333);
        }
        .wechat-dark-mode .sim-app-icon-label {
             color: #fff;
        }

        .sim-app-view {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary, white);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
        }
        .sim-app-view.active {
            display: flex;
        }

        .sim-app-header {
            height: 44px;
            background: var(--nav-bg, #f8f8f8);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color, #e0e0e0);
        }
        .sim-app-header-btn {
            background: none;
            border: none;
            font-size: 24px;
            line-height: 1;
            padding: 5px 10px;
            color: #007aff;
            cursor: pointer;
        }
        .sim-app-header-title {
            font-weight: 600;
            font-size: 17px;
            color: var(--text-color);
        }

        .sim-app-content {
            flex-grow: 1;
            overflow-y: auto;
            color: var(--text-color);
        }
        
        .sim-loading-overlay {
            position: absolute;
            top: 44px; /* Below header */
            left: 0; 
            width: 100%; 
            height: calc(100% - 44px);
            background: var(--bg-primary, white);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            z-index: 10;
        }
        .wechat-dark-mode .sim-loading-overlay {
            background: var(--theme-bg, #1c1c1e);
            color: #fff;
        }

        .sim-memo-item, .sim-browser-item, .sim-shopping-item, .sim-wallet-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
            cursor: pointer;
        }
         .sim-memo-item:hover, .sim-browser-item:hover, .sim-shopping-item:hover {
            background-color: var(--bg-hover, #f5f5f5);
        }
        .sim-memo-title, .sim-browser-title, .sim-shopping-title {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        .sim-memo-content, .sim-browser-url, .sim-shopping-details {
             font-size: 14px;
             color: var(--text-secondary, #666);
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
             word-break: break-all;
        }

        .sim-memo-datetime {
            font-size: 12px;
            color: #aaa;
            margin-top: 8px;
        }

        .sim-call-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
        }
        .sim-call-type {
            width: 20px;
            margin-right: 10px;
        }
        .sim-call-info { flex-grow: 1; }
        .sim-call-name { font-weight: 500; }
        .sim-call-detail { font-size: 12px; color: var(--text-secondary, #666); }

        .sim-wallet-balance {
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid var(--border-light, #f0f0f0);
        }
        .sim-wallet-amount {
            font-size: 32px;
            font-weight: bold;
        }

        .sim-wallet-item {
            display: flex;
            justify-content: space-between;
        }
        .sim-wallet-item .amount.positive { color: #07c160; }
        .sim-wallet-item .amount.negative { color: var(--text-color); }

        /* NEW: Styles for interactive sim apps */
        .sim-photos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
        }
        .sim-photo-thumb {
            aspect-ratio: 1 / 1;
            background-color: var(--bg-hover, #f0f0f0);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sim-photo-thumb svg {
            width: 40%;
            height: 40%;
            fill: var(--text-secondary, #999);
        }
        .sim-detail-content {
            padding: 20px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .sim-shopping-image-placeholder {
            width: 100%;
            aspect-ratio: 1/1;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            margin-bottom: 15px;
        }
        .sim-shopping-image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- [NEW] Emoji Modal v2 Styles --- */
        .emoji-modal-tabs {
            display: flex;
            margin-bottom: 15px;
            border-radius: var(--btn-radius, 8px);
            background-color: var(--bg-hover, #f0f0f0);
            padding: 4px;
        }
        .emoji-modal-tab {
            flex: 1;
            padding: 8px;
            border: none;
            background: none;
            border-radius: var(--btn-radius, 6px);
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary, #666);
            transition: all 0.2s ease;
        }
        .emoji-modal-tab.active {
            background-color: var(--bg-primary, white);
            color: var(--text-color, #000);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .emoji-modal-content-view {
            display: none;
        }
        .emoji-modal-content-view.active {
            display: block;
        }
        .emoji-modal-upload-btn {
            display: block;
            width: 100%;
            text-align: center;
            padding: 12px;
            background-color: var(--bg-hover, #f0f0f0);
            border-radius: var(--form-radius, 8px);
            margin-top: 10px;
            cursor: pointer;
        }
        #batchEmojiInput {
            min-height: 120px;
            height: 150px;
            font-size: 14px;
        }
        
        /* [FIX & NEW] Location Card Styles */
        .location-card {
            width: 250px;
            background-color: var(--bg-primary, white);
            border-radius: 10px;
            overflow: hidden;
            color: var(--text-color, #000);
            border: 1px solid var(--border-light, #f0f0f0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .location-card-info {
            padding: 10px 12px;
        }
        .location-card-title {
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .location-card-address {
            font-size: 12px;
            color: var(--text-secondary, #999);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .location-card-map {
    height: 120px;
    background-color: #f0f0f0;
    position: relative;
    background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAFoAeADASIAAhEBAxEB/8QAGwABAQEBAQEBAQAAAAAAAAAAAAECAwQFBgf/xAAzEAEAAgECAwUIAgMAAwEAAAAAAQIRAyExEgRBURMiMmFxFEKBsfAFI1JioUKSstFD4f/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/EABYRAQEBAAAAAAAAAAAAAAAAAAARAf/aAAwDAQACEQMRAD8A/SAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABIAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEgAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACSACgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEgAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEgAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEgAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADz9p2vaRpOPlxj48s+8+gPN2/adpGk4uXGfDln3g9IAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB5e17TtI1HTy4z4cs/T1Dy9p2naRqOnlxnw5Z+kHrAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPL2vadr+no5cZ8OWfp6h5e17Ttf09HGfDln6QesAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8va9p2v6enlxnw5Z+nqHl7XtO1/T0cZ8OWfpB6wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADy9r2na/p6eXGfDln6eoeXte07X9PRxnw5Z+kHrAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPL2vadr+np5cZ8OWfp6h5e17Ttf09HGfDln6QesAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA5+10/VnynD+I5/a6fqz5Th/EHRA5/a6fqz5Th/EcntdP1Z8pw/iDoQc/tdP1Z8pw/iOX2un6s+U4fxB0QOf2un6s+U4fxHL7XT9WfKcP4g6IHP7XT9WfKcP4jl9rp+rPlOH8QdEADy9r2na/p6eXGfDln6eoeXte07X9PRxnw5Z+kHrAAAc/a6fqz5Th/EcntdP1Z8pw/iDoQc/tdP1Z8pw/iOX2un6s+U4fxB0QOf2un6s+U4fxHL7XT9WfKcP4g6IHP7XT9WfKcP4jl9rp+rPlOH8QdEADy9r2na/p6eXGfDln6eoeXte07X9PRxnw5Z+kHrAAAc/a6fqz5Th/EcntdP1Z8pw/iDoQc/tdP1Z8pw/iOX2un6s+U4fxB0QOf2un6s+U4fxHL7XT9WfKcP4g6IHP7XT9WfKcP4jl9rp+rPlOH8QdEADy9r2na/p6eXGfDln6eoeXte07X9PRxnw5Z+kHrAAAc/a6fqz5Th/EcntdP1Z8pw/iDoQc/tdP1Z8pw/iOX2un6s+U4fxB0QOf2un6s+U4fxHL7XT9WfKcP4g6IHP7XT9WfKcP4jl9rp+rPlOH8QdEADy9r2na/p6eXGfDln6eoeXte07X9PRxnw5Z+kHrAAAc/a6fqz5Th/EcntdP1Z8pw/iDoQc/tdP1Z8pw/iOX2un6s+U4fxB0QOf2un6s+U4fxHL7XT9WfKcP4g6IHP7XT9WfKcP4jl9rp+rPlOH8QdEADy9r2na/p6eXGfDln6eoeXte07X9PRxnw5Z+kHrAAAAAAAAAAAAAAAAPL2vadr+np5cZ8OWfp6h5e17Ttf09HGfDln6QesAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8va9p2v6enlxnw5Z+nqHl7XtO1/T0cZ8OWfpB6wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADy9r2na/p6eXGfDln6eoeXte07X9PRxnw5Z+kHrAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPJ/1K3L2UaXp6U/F5/7j1jzdt/X/AKvRw/Dln38PVB6QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADy9r2na/p6eXGfDln6eoeXte07X9PRxnw5Z+kHrAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPb9IAD//2Q==');
    background-size: cover;
    background-position: center;
    border-top: 1px solid var(--border-light, #f0f0f0);
    border-bottom: 1px solid var(--border-light, #f0f0f0);
}
        .location-card-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            transform: translate(-50%, -100%);
        }
        .wechat-dark-mode .location-card-map {
            filter: invert(1) hue-rotate(180deg);
        }
        .location-card-footer {
            display: flex;
            align-items: center;
            font-size: 10px;
            color: #c7c7c7;
            padding: 4px 12px;
        }
        .location-card-footer img {
            width: 12px;
            height: 12px;
            margin-right: 4px;
        }

        /* NEW: Chat Timestamp */
        .chat-timestamp {
            text-align: center;
            margin: 10px 0;
            font-size: var(--small-font-size, 12px);
            color: var(--text-secondary, #999);
        }
        
        /* [NEW] Voice Call Styles */
        #voiceCallScreen, #incomingCallScreen {
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            color: #fff;
            display: none; /* Initially hidden */
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 80px 20px 40px;
        }
        #voiceCallScreen.active, #incomingCallScreen.active {
            display: flex;
        }
        .voice-call-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(10px);
            z-index: -1;
        }
        .voice-call-header {
            text-align: center;
        }
        .voice-call-avatar {
            width: 90px;
            height: 90px;
            border-radius: 12px;
            background-size: cover;
            background-position: center;
            margin: 0 auto 15px;
            border: 2px solid rgba(255,255,255,0.5);
        }
        .voice-call-name {
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .voice-call-status {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            margin-top: 5px;
        }

        .voice-call-log {
            flex-grow: 1;
            width: 100%;
            overflow-y: auto;
            margin: 20px 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .voice-call-log .log-item {
            margin-bottom: 15px;
            max-width: 80%;
        }
        .voice-call-log .log-item.user { align-self: flex-end; }
        .voice-call-log .log-item.ai { align-self: flex-start; }
        .voice-call-log .dialogue-bubble {
            background: rgba(255,255,255,0.2);
            padding: 10px 14px;
            border-radius: 18px;
            line-height: 1.5;
        }
        .voice-call-log .log-item.user .dialogue-bubble { background: #007aff; }
        .voice-call-log .narration-text {
            font-size: 13px;
            font-style: italic;
            color: rgba(255,255,255,0.7);
            text-align: center;
            margin-top: 8px;
            padding: 0 10px;
        }

        .voice-call-input-area {
            display: flex;
            width: 100%;
            gap: 10px;
            align-items: center;
            margin-top: 20px;
        }
        .voice-call-input-area input {
            flex-grow: 1;
            height: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.4);
            background: rgba(0,0,0,0.3);
            color: #fff;
            padding: 0 15px;
        }
        .voice-call-input-area button {
            width: 40px; height: 40px; border-radius: 50%;
            border: none;
            background: #007aff;
            color: #fff;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }

        .voice-call-controls {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }
        .voice-call-btn {
            background: none; border: none;
            color: #fff; text-align: center; cursor: pointer;
        }
        .voice-call-btn-icon {
            width: 60px; height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }
        .voice-call-btn.hangup .voice-call-btn-icon { background: #ff3b30; }
        .voice-call-btn-icon svg { width: 30px; height: 30px; fill: #fff; }

        #incomingCallScreen {
            z-index: 9000;
            background-color: #333;
        }
        .incoming-call-actions {
            width: 100%;
            display: flex;
            justify-content: space-around;
        }
        .incoming-call-btn.accept .voice-call-btn-icon { background: #34c759; }

        /* [MODIFIED] Heart's Voice Modal Styles */
        #heartsVoiceModal .modal-content {
            text-align: center;
            padding-bottom: 25px;
        }
        #heartsVoiceHeader {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px; /* MODIFIED: Reduced gap */
            margin-bottom: 10px;
        }
        #heartsVoiceAvatar {
            width: 40px;
            height: 40px;
            border-radius: 6px;
        }
        #heartsVoiceName {
            font-size: 16px;
            font-weight: bold;
        }
        #heartsVoiceEmoji {
            font-size: 48px;
            margin: 10px 0;
            line-height: 1.2;
        }
        #heartsVoiceThought {
            background-color: var(--bg-hover, #f5f5f5);
            padding: 15px;
            border-radius: 8px;
            font-size: 15px;
            line-height: 1.8;
            color: var(--text-secondary, #666);
            min-height: 140px;
            text-align: left;
            margin-top: 15px;
        }
        #heartsVoiceThought div {
            margin-bottom: 8px;
        }
        #heartsVoiceThought div:last-child {
            margin-bottom: 0;
        }
        #heartsVoiceThought strong {
            color: var(--text-color, #333);
            font-weight: 600;
        }

        /* 新增：朋友圈删除图标样式 */
        .moments-delete-icon {
            cursor: pointer;
            fill: #586b95; /* 使用与名字相同的蓝色 */
            width: 16px;
            height: 16px;
            transition: fill 0.2s ease;
        }
        .moments-delete-icon:hover {
            fill: #ff3b30; /* 鼠标悬停时变为红色 */
        }

/* 新增：朋友圈时间与删除图标的包裹容器样式 */
.moments-time-group {
    display: flex;         /* 让时间与图标在同一行 */
    align-items: center;   /* 让它们垂直居中对齐 */
    gap: 5px;              /* 控制时间与图标之间的间距，你可以调整这个值 */
}

    </style>
</head>
<body>
    <audio id="audioPlayer"></audio>
    <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
    <input type="file" id="widgetImageInput" accept="image/*" style="display: none;" onchange="handleWidgetImageUpload(event)">
    <input type="file" id="listenBgInput" accept="image/*" style="display: none;" onchange="handleListenBgUpload(event)">
    <input type="file" id="vinylImageInput" accept="image/*" style="display: none;" onchange="handleVinylImageUpload(event)">
    <input type="file" id="songFileInput" accept="audio/mp3,audio/*" style="display:none;" onchange="handleSongFileSelect(event)">
    <input type="file" id="lrcFileInput" accept=".lrc" style="display:none;" onchange="handleLrcFileSelect(event)">
    
    <!-- Inputs for new emoji modal -->
    <input type="file" id="singleEmojiUploadInput" accept="image/*" style="display: none;" onchange="handleSingleEmojiUpload(event)">
    <input type="file" id="batchEmojiUploadInput" accept="image/*" style="display: none;" onchange="handleBatchEmojiUpload(event)" multiple>

    <div id="message-notification">
        <div id="notification-avatar"></div>
        <div id="notification-content">
            <div id="notification-sender"></div>
            <div id="notification-message"></div>
        </div>
    </div>

    <div class="phone">
        <div id="floatingPlayer">
            <div id="floatingPlayerArt"></div>
            <div id="floatingPlayerInfo">
                <span id="floatingPlayerTitle">歌曲名称</span>
                <span id="floatingPlayerSubtitle">正在一起听...</span>
            </div>
            <button id="floatingPlayerCloseBtn" onclick="terminateListenTogether(event)">&times;</button>
        </div>

        <div class="status-bar">
            <div class="status-left">
                <span id="currentTime"></span>
            </div>
            <div class="status-right">
                <div class="signal-icon">
                    <div class="signal-bar"></div>
                    <div class="signal-bar"></div>
                    <div class="signal-bar"></div>
                    <div class="signal-bar"></div>
                </div>
                <div class="network-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
                    </svg>
                </div>
                <div class="battery-icon">
                    <div class="battery-level"></div>
                    <div class="battery-tip"></div>
                </div>
            </div>
        </div>

        <div class="screen">
            <div id="homeScreen" class="page active">
                <div class="home-screen">
                    <div class="profile-widget-container" id="profileWidgetContainer">
                        <div class="profile-widget">
                            <div class="profile-avatar-widget" id="widgetAvatar" onclick="changeAvatar()"></div>
                            <div class="widget-info-section">
                                <div class="profile-name-widget" id="widgetName" onclick="changeName()">可点击编辑</div>
                                <div class="profile-signature-widget" id="widgetSignature" onclick="changeSignature()">可点击编辑</div>
                                <div class="profile-location" onclick="changeLocation()">
                                    <svg class="location-icon" viewBox="0 0 24 24">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    </svg>
                                    <span id="widgetLocation">可点击编辑</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="home-widgets-container">
                        <div class="new-widget" id="homeScreenWidget">
                            <div class="widget-header-text" id="widgetHeaderText" onclick="editWidgetText('widgetHeaderText', this)">(:::[♡]:::)..?</div>
                            <div class="widget-bubble">
                                <img id="widgetImage1" src="https://i.imgur.com/example-avatar-1.png" onclick="editWidgetImage('widgetImage1')">
                                <span id="widgetText1" onclick="editWidgetText('widgetText1', this)">have a nice day 🌟</span>
                            </div>
                            <div class="widget-bubble">
                                <span id="widgetText2" onclick="editWidgetText('widgetText2', this)">.o. HAPPY EVERYDAY ☻</span>
                                <img id="widgetImage2" src="https://i.imgur.com/example-avatar-2.png" onclick="editWidgetImage('widgetImage2')">
                            </div>
                        </div>
                        <div class="app-grid">
                            <div class="app wechat" onclick="openApp('wechat')">
                                <div class="app-icon-container" id="icon-wechat">
                                    <svg class="app-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 3.978 2.32 7.439 5.698 9.062L7 22l3.41-2.131A10.12 10.12 0 0 0 12 20c5.523 0 10-4.477 10-10S17.523 2 12 2zM8.5 13.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm7 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
                                    </svg>
                                </div>
                                <div class="app-label">微信</div>
                            </div>
                            <div class="app settings" onclick="openApp('settings')">
                                <div class="app-icon-container" id="icon-settings">
                                    <svg class="app-icon" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69-.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
                                    </svg>
                                </div>
                                <div class="app-label">设置</div>
                            </div>
                            <div class="app worldbook" onclick="openApp('worldbook')">
                                <div class="app-icon-container" id="icon-worldbook">
                                    <svg class="app-icon" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                    </svg>
                                </div>
                                <div class="app-label">世界书</div>
                            </div>
                            <div class="app theme" onclick="openApp('theme')">
                                <div class="app-icon-container" id="icon-theme">
                                    <svg class="app-icon" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,18C8.69,18 6,15.31 6,12C6,8.69 8.69,6 12,6C15.31,6 18,8.69 18,12C18,15.31 15.31,18 12,18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7Z"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>
                                </div>
                                <div class="app-label">主题</div>
                            </div>
                        </div>
                    </div>
                     <div class="bottom-dock">
                        <div class="app" onclick="openApp('phone')">
                            <div class="app-icon-container" id="icon-phone">
                                <svg class="app-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/></svg>
                            </div>
                            <div class="app-label">手机</div>
                        </div>
                        <div class="app" onclick="showAlert('此功能暂未开放')">
                            <div class="app-icon-container" id="icon-placeholder1">
                                <svg class="app-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20,18H4V8H20M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z" /></svg>
                            </div>
                            <div class="app-label">闲置1</div>
                        </div>
                        <div class="app" onclick="showAlert('此功能暂未开放')">
                            <div class="app-icon-container" id="icon-placeholder2">
                                <svg class="app-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M14.5,12A2.5,2.5 0 0,0 12,9.5A2.5,2.5 0 0,0 9.5,12A2.5,2.5 0 0,0 12,14.5A2.5,2.5 0 0,0 14.5,12M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4Z" /></svg>
                            </div>
                            <div class="app-label">闲置2</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="wechatApp" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="goHome()">←</button>
                    <div class="nav-title">消息</div>
                    <button class="nav-btn" onclick="toggleAddMenu()">+</button>
                </div>
                <div class="add-menu" id="addMenu">
                    <div class="add-menu-item" onclick="openGroupChatModal()">发起群聊</div>
                    <div class="add-menu-item" onclick="openAddFriend()">添加好友</div>
                </div>
                <div class="wechat-content">
                    <div id="wechatMessages" class="friend-list"></div>
                    <div id="wechatDiscover" class="discover-content" style="display: none;">
                        <div class="discover-menu">
                            <div class="discover-menu-item" onclick="openMoments()">
                                <div class="discover-menu-left">
                                    <svg class="discover-menu-icon" viewBox="0 0 24 24"><path d="M12,12A6,6 0 1,0 18,18A6,6 0 0,0 12,12M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M2,4H8V6H2V4M2,8H6V10H2V8M2,12H8V14H2V12M2,16H6V18H2V16M18,4H22V6H18V4M18,8H22V10H18V8M18,12H22V14H18V12M18,16H22V18H18V16Z" /></svg>
                                    <div class="discover-menu-title">朋友圈</div>
                                </div>
                                <span>></span>
                            </div>
                            <div class="discover-menu-item" onclick="openDiary()">
                                <div class="discover-menu-left">
                                    <svg class="discover-menu-icon" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                                    <div class="discover-menu-title">日记</div>
                                </div>
                                <span>></span>
                            </div>
                        </div>
                    </div>
                    <div id="wechatProfile" class="profile-content" style="display: none;">
                        <div class="profile-section">
                            <div class="profile-header">
                                <div class="profile-avatar-large" onclick="changeAvatar()" id="profileAvatar"></div>
                                <div class="profile-name" onclick="changeName()" id="profileName">可点击编辑</div>
                            </div>
                        </div>
                        <div class="profile-section">
                            <div class="profile-menu">
                                <div class="profile-menu-item" onclick="openPersonalSettings()">
                                    <span>人设与背景</span>
                                    <span>></span>
                                </div>
                                <div class="profile-menu-item" onclick="openWallet()">
                                    <span>钱包</span>
                                    <span>></span>
                                </div>
                                <div class="profile-menu-item" onclick="openFavorites()">
                                    <span>收藏</span>
                                    <span>></span>
                                </div>
                                <div class="profile-menu-item" onclick="openMySettings()">
                                    <span>设置</span>
                                    <span>></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="wechat-bottom-nav">
                    <div class="wechat-tab active" onclick="switchWechatTab('messages')">
                        <div class="wechat-tab-icon">
                            <svg class="icon-chat" viewBox="0 0 24 24"><path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H5.17L4,17.17V4H20V16Z" /></svg>
                        </div>
                        <div>消息</div>
                    </div>
                    <div class="wechat-tab" onclick="switchWechatTab('discover')">
                        <div class="wechat-tab-icon">
                            <svg class="icon-discover" viewBox="0 0 24 24"><path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 1,1 4,12A8,8 0 0,1 12,4M12,10.5L13.9,13.4L11.1,14.9L12,17L12.9,14.9L10.1,13.4L12,10.5Z" /></svg>
                        </div>
                        <div>发现</div>
                    </div>
                    <div class="wechat-tab" onclick="switchWechatTab('profile')">
                        <div class="wechat-tab-icon">
                           <svg class="icon-profile" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" /></svg>
                        </div>
                        <div>我</div>
                    </div>
                </div>
            </div>

            <div id="chatScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToWechat()">←</button>
                    <div class="nav-title" id="chatTitle">聊天</div>
                    <div style="display: flex; align-items: center;">
                        <button class="nav-btn" id="heartsVoiceBtn" onclick="openHeartsVoiceModal()" title="心声">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        </button>
                        <button class="nav-btn" onclick="openChatSettings()">⋯</button>
                    </div>
                </div>
                <div class="wechat-content">
                    <div class="chat-messages" id="chatMessages"></div>
                </div>
                <div class="multi-select-toolbar" id="multiSelectToolbar">
                    <span class="multi-select-count" id="multiSelectCount">已选择 0 条消息</span>
                    <div class="multi-select-actions">
                        <button class="multi-select-btn delete" onclick="deleteSelectedMessages()">删除</button>
                        <button class="multi-select-btn cancel" onclick="exitMultiSelectMode()">取消</button>
                    </div>
                </div>
                <div class="chat-input-area" id="chatInputArea">
                    <div class="chat-input">
                        <button class="chat-btn" id="receiveBtn" onclick="requestAIResponse()" title="接收消息"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.567L16.5 21.75l-.398-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.398a2.25 2.25 0 00-1.423 1.423z" /></svg></button>
                        <button class="chat-btn" id="voiceBtn" onclick="openVoiceModal()" title="语音"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg></button>
                        <textarea id="messageInput" rows="1" placeholder="输入消息..." onkeypress="handleKeyPress(event)" oninput="toggleSendButtonActive(this)" onclick="hideFunctionMenus()"></textarea>
                        <button class="chat-btn" id="emojiBtn" onclick="toggleEmojiPicker()" title="表情"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.47,2 2,6.47 2,12C2,17.53 6.47,22 12,22A10,10 0 0,0 22,12C22,6.47 17.5,2 12,2M15.5,8A1.5,1.5 0 0,1 17,9.5A1.5,1.5 0 0,1 15.5,11A1.5,1.5 0 0,1 14,9.5A1.5,1.5 0 0,1 15.5,8M8.5,8A1.5,1.5 0 0,1 10,9.5A1.5,1.5 0 0,1 8.5,11A1.5,1.5 0 0,1 7,9.5A1.5,1.5 0 0,1 8.5,8M12,17.23C10.25,17.23 8.71,16.5 7.81,15.42L9.23,14C9.68,14.72 10.75,15.23 12,15.23C13.25,15.23 14.32,14.72 14.77,14L16.19,15.42C15.29,16.5 13.75,17.23 12,17.23Z"/></svg></button>
                        <button class="chat-btn plus-btn" onclick="toggleChatFunctions()" title="更多"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
                        <button class="chat-btn send-btn" id="sendBtn" onclick="sendMessage()" title="发送消息"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.4 20.4l17.4-8.4c.8-.4.8-1.6 0-2L3.4 1.6c-.8-.4-1.6.4-1.4 1.2l3.6 7.2c.2.4.2 1 0 1.4L2 19.2c-.2.8.6 1.6 1.4 1.2z"/></svg></button>
                    </div>
                    <div class="chat-functions" id="chatFunctions">
                        <div class="function-menu">
                            <div class="function-item" onclick="selectPhoto()"><div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg></div><div class="function-label">照片</div></div>
                            <div class="function-item" onclick="openCameraModal()"><div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg></div><div class="function-label">拍摄</div></div>
                            <div class="function-item" onclick="startVoiceCall()"><div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/></svg></div><div class="function-label">语音通话</div></div>
                            <div class="function-item" onclick="openTransferModal()"><div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 17H7v-2h10v2zm0-4H7v-2h10v2zm0-4H7V7h10v2zm-2-5H9v2h6V4zM5 21V3h14v18H5zm2-2h10V5H7v14z"/></svg></div><div class="function-label">转账</div></div>
                            <div class="function-item" onclick="openListenTogether()"><div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z" /></svg></div><div class="function-label">一起听</div></div>
                            <div class="function-item" onclick="openLocationModal()"><div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 9 12 9s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div><div class="function-label">位置</div></div>
                        </div>
                    </div>
                    <div class="emoji-picker" id="emojiPicker">
                        <div class="emoji-picker-header">
                             <button class="emoji-picker-btn manage" id="manageEmojiBtn" onclick="toggleEmojiManagement()">管理</button>
                        </div>
                        <div class="emoji-grid" id="emojiGrid"></div>
                    </div>
                </div>
            </div>

            <!-- Together Listening Screen -->
            <div id="listenTogetherScreen" class="page">
                <div class="listen-bg" id="listenBg"></div>
                
                <div class="listen-main">
                     <div class="listen-header">
                        <div style="display: flex;">
                             <button class="nav-btn" id="listenBackBtn">
                                <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <div class="listen-header-title">
                            <div id="listenSongTitle" style="font-weight: bold;">一起听</div>
                            <div id="listenSongArtist" style="font-size: 12px; color: rgba(255,255,255,0.7);">...</div>
                        </div>
                        <div style="display: flex; align-items: center;">
                             <button class="nav-btn" style="font-size: 14px;" onclick="document.getElementById('listenBgInput').click()" title="更换背景">BG</button>
                             <button class="nav-btn" style="font-size: 14px;" onclick="document.getElementById('vinylImageInput').click()" title="更换唱片封面">CD</button>
                             <button class="nav-btn" id="listenCloseBtn" style="color: #ff4d4d;"><svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
                        </div>
                    </div>

                    <div class="listen-avatars-container" id="listenAvatarsContainer">
                        <div class="headphone-arc"></div>
                        <div id="listenFriendAvatar" class="listen-avatar"></div>
                        <div id="listenUserAvatar" class="listen-avatar"></div>
                    </div>
                    
                    <div id="listenTogetherChatOverlay"></div>

                    <div class="vinyl-container">
                        <div id="vinylRecord" class="vinyl-record">
                            <div id="albumArt" class="album-art"></div>
                        </div>
                    </div>
                    
                    <div id="listenTogetherChatWrapper">
                        <button id="listenTogetherChatToggleBtn" onclick="toggleListenChat()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                        </button>
                         <div id="listenTogetherChatInputContainer">
                             <button class="listen-chat-btn" onclick="requestAIResponse()"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.567L16.5 21.75l-.398-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.398a2.25 2.25 0 00-1.423 1.423z" /></svg></button>
                             <input type="text" id="listenTogetherChatInput" placeholder="聊点什么..." onkeypress="handleListenTogetherKeyPress(event)">
                             <button id="listenTogetherSendBtn" onclick="sendListenTogetherMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                         </div>
                    </div>

                    <div id="songLyrics">
                         <p class="sub-lyric"></p>
                         <p class="active-lyric">... 点击右下角列表添加歌曲 ...</p>
                         <p class="sub-lyric"></p>
                    </div>
                </div>
               
                <div class="listen-controls">
                    <div class="listen-progress-bar">
                        <span id="currentTimeLabel">00:00</span>
                        <input type="range" id="songProgressBar" value="0" step="1" oninput="seekSong(this.value)">
                        <span id="durationLabel">00:00</span>
                    </div>
                    <div class="listen-buttons">
                        <button class="listen-btn" id="repeatBtn" onclick="toggleRepeat()"><svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></button>
                        <button class="listen-btn" onclick="prevSong()"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                        <button class="listen-btn play-pause" onclick="togglePlayPause()" id="playPauseBtn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                        <button class="listen-btn" onclick="nextSong()"><svg viewBox="0 0 24 24"><path d="M16 6h2v12h-2zm-8.5 6l8.5 6V6z"/></svg></button>
                        <button class="listen-btn" onclick="openPlaylistModal()"><svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
                    </div>
                </div>
            </div>

            <!-- [NEW] Voice Call Screen -->
            <div id="voiceCallScreen" class="page">
                <div class="voice-call-bg" id="voiceCallBg"></div>
                <div class="voice-call-header">
                    <div class="voice-call-avatar" id="voiceCallAvatar"></div>
                    <div class="voice-call-name" id="voiceCallName"></div>
                    <div class="voice-call-status" id="voiceCallStatus"></div>
                </div>
            
                <div class="voice-call-log" id="voiceCallLog">
                    <!-- Call dialogue will be appended here -->
                </div>
            
                <div class="voice-call-input-area" id="voiceCallInputArea">
                    <button onclick="requestAICallResponse()"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.567L16.5 21.75l-.398-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.398a2.25 2.25 0 00-1.423 1.423z" /></svg></button>
                    <input type="text" id="voiceCallUserInput" placeholder="输入你想说的话...">
                    <button onclick="sendUserCallMessage()"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="18" height="18"><path d="M3.4 20.4l17.4-8.4c.8-.4.8-1.6 0-2L3.4 1.6c-.8-.4-1.6.4-1.4 1.2l3.6 7.2c.2.4.2 1 0 1.4L2 19.2c-.2.8.6 1.6 1.4 1.2z"/></svg></button>
                </div>
            
                <div class="voice-call-controls" id="voiceCallControls">
                    <button class="voice-call-btn" onclick="showAlert('功能暂未开放')">
                        <div class="voice-call-btn-icon"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1.2-9.1c0-1.03.83-1.9 1.9-1.9 1.02 0 1.8.84 1.8 1.9l-.01 6.2c0 1.03-.83 1.9-1.9 1.9s-1.8-.84-1.8-1.9L10.8 4.9zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></div>
                        <span>静音</span>
                    </button>
                    <button class="voice-call-btn hangup" onclick="endVoiceCall()">
                        <div class="voice-call-btn-icon"><svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.62.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.36 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.7l-2.47 2.47c-.18.18-.43.29-.71.29-.27 0-.52-.1-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg></div>
                        <span>挂断</span>
                    </button>
                    <button class="voice-call-btn" onclick="showAlert('功能暂未开放')">
                        <div class="voice-call-btn-icon"><svg viewBox="0 0 24 24"><path d="M3 4l1.41 1.41L12 12.83l7.59-7.59L21 6.64 12 15.64 3.36 7.05 3 7.41V4h.01M3 14v2h18v-2H3z"/></svg></div>
                        <span>免提</span>
                    </button>
                </div>
            </div>

            <!-- [NEW] Incoming Call Screen -->
            <div id="incomingCallScreen" class="page">
                <div class="voice-call-bg" id="incomingCallBg"></div>
                <div class="voice-call-header">
                    <div class="voice-call-avatar" id="incomingCallAvatar"></div>
                    <div class="voice-call-name" id="incomingCallName"></div>
                    <div class="voice-call-status">邀请你进行语音通话</div>
                </div>
                <div class="incoming-call-actions">
                    <button class="voice-call-btn hangup" onclick="declineCall()">
                        <div class="voice-call-btn-icon"><svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.62.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.36 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.7l-2.47 2.47c-.18.18-.43.29-.71.29-.27 0-.52-.1-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg></div>
                        <span>拒绝</span>
                    </button>
                    <button class="voice-call-btn accept incoming-call-btn" onclick="acceptCall()">
                        <div class="voice-call-btn-icon"><svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.2c.27-.27.35-.66.24-1.01-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.75 0 .99-.65.99-.99v-3.45c0-.54-.45-.98-.99-.98z"/></svg></div>
                        <span>接听</span>
                    </button>
                </div>
            </div>


            <div id="messageMenu" class="message-menu"></div>

            <div id="recalledMessagePopup" class="recalled-message-popup">
                <div class="recalled-message-title">撤回的消息</div>
                <div class="recalled-message-content" id="recalledMessageContent"></div>
                <button class="recalled-message-close" onclick="closeRecalledMessagePopup()">关闭</button>
            </div>

            <div id="chatSettingsScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToChat()">←</button>
                    <div class="nav-title">聊天设置</div>
                    <div></div>
                </div>
                <div class="chat-settings-content">
                    <div class="settings-menu-item" onclick="openFriendSettings()"><span>好友与群聊设置</span><span>></span></div>
                    <div class="settings-menu-item" onclick="togglePinChat()"><span id="pinChatText">置顶聊天</span></div>
                    <div class="settings-menu-item" onclick="openBackgroundSettings()"><span>聊天背景</span><span>></span></div>
                    <div class="settings-menu-item" onclick="openChatSearch()"><span>查找聊天记录</span><span>></span></div>
                    <div class="settings-menu-item" onclick="clearChatHistory()"><span>清空聊天记录</span></div>
                    <div style="margin-top: 20px;">
                        <div class="settings-menu-item danger" onclick="deleteFriend()"><span>删除并退出</span></div>
                    </div>
                </div>
            </div>

            <div id="chatSearchScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToChatSettings()">←</button>
                    <div class="nav-title">查找聊天记录</div>
                    <div></div>
                </div>
                <div class="settings-content" style="position: relative; height: 100%;">
                    <div class="form-group" style="position: relative;">
                        <input type="text" class="form-input" id="searchInput" placeholder="输入关键词搜索..." oninput="searchChatHistory()">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                </div>
            </div>

            <div id="friendSettingsScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToChatSettings()">←</button>
                    <div class="nav-title">好友设置</div>
                    <div></div>
                </div>
                <div class="settings-content">
                     <div class="form-group" id="editFriendAvatarGroup">
                        <label class="form-label">好友头像</label>
                        <div class="avatar-upload" id="editFriendAvatarUpload" style="margin: 0 auto 15px;">
                            <input type="file" accept="image/*" onchange="handleEditFriendAvatarUpload(event)">
                            <span id="editFriendAvatarPreview"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="editFriendNameLabel">好友昵称</label>
                        <input type="text" class="form-input" id="editFriendName" placeholder="好友/群聊昵称">
                    </div>
                    <div class="form-group" id="editFriendRemarkGroup">
                        <label class="form-label">备注名称</label>
                        <input type="text" class="form-input" id="editFriendRemark" placeholder="备注名称">
                    </div>
                    <div class="form-group" id="editFriendPatGroup">
                        <label class="form-label">拍一拍动作</label>
                        <input type="text" class="form-input" id="editFriendPatAction" placeholder="例如：拍了拍我">
                    </div>
                    <div class="form-group" id="editFriendRoleGroup">
                        <label class="form-label">角色设定</label>
                        <textarea class="form-textarea" id="editFriendRole" placeholder="角色设定..."></textarea>
                    </div>
                    <div class="form-group" id="worldBookBindingGroup">
                        <label class="form-label">绑定世界书</label>
                        <div class="form-input" style="cursor: pointer; line-height: 2.5;" onclick="openWorldBookBindingModal()">点击选择</div>
                    </div>
                    <div class="settings-buttons">
                        <button class="settings-btn btn-primary" onclick="saveFriendSettings()">保存设置</button>
                    </div>
                </div>
            </div>

            <div id="backgroundSettingsScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToChatSettings()">←</button>
                    <div class="nav-title">聊天背景</div>
                    <div></div>
                </div>
                <div class="modal-content-container">
                    <div class="modal-content">
                        <div class="background-grid" id="individualBgGrid">
                            <div class="background-option default" onclick="selectBackground('default')"><span>默认</span></div>
                            <div class="background-option background-upload"><input type="file" accept="image/*" onchange="handleBackgroundUpload(event)"><span>上传</span></div>
                        </div>
                        <div class="modal-buttons" style="margin-top: 20px;">
                            <button class="modal-btn modal-btn-cancel" onclick="backToChatSettings()">取消</button>
                            <button class="modal-btn modal-btn-confirm" onclick="saveBackground()">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="personalSettingsScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToProfile()">←</button>
                    <div class="nav-title">人设与背景</div>
                    <div></div>
                </div>
                <div class="settings-content">
                    <div class="form-group"><label class="form-label">我的人设</label><textarea class="form-textarea" id="userPersonality" placeholder="请描述你的个性、特点、喜好等..." style="min-height: 100px;"></textarea></div>
                    <div class="form-group"><label class="form-label">背景设定</label><textarea class="form-textarea" id="userBackground" placeholder="请描述你的背景、经历、职业等..." style="min-height: 100px;"></textarea></div>
                    <div class="form-group"><label class="form-label">我的拍一拍动作</label><input type="text" class="form-input" id="userPatAction" placeholder="例如：拍了拍"></div>
                    <div class="settings-buttons"><button class="settings-btn btn-primary" onclick="savePersonalSettings()">保存设置</button></div>
                </div>
            </div>

            <div id="mySettingsScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToProfile()">←</button>
                    <div class="nav-title">设置</div>
                    <div></div>
                </div>
                <div class="discover-content">
                    <div class="discover-menu">
                        <div class="discover-menu-item" onclick="openGlobalChatBg()"><div class="discover-menu-left"><svg class="discover-menu-icon" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4Z"/></svg><div class="discover-menu-title">全局聊天背景</div></div><span>></span></div>
                        <div class="discover-menu-item" onclick="openBubbleSettings()"><div class="discover-menu-left"><svg class="discover-menu-icon" viewBox="0 0 24 24"><path d="M12,2C6.47,2 2,6.47 2,12C2,17.53 6.47,22 12,22C17.53,22 22,17.53 22,12C22,6.47 17.53,2 12,2M15.04,7.5L15.5,8.96L16.96,9.5L15.5,10.04L15.04,11.5L14.5,10.04L13.04,9.5L14.5,8.96L15.04,7.5M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9M12,17.5C14.33,17.5 16.31,16.04 17.11,14H6.89C7.69,16.04 9.67,17.5 12,17.5Z"/></svg><div class="discover-menu-title">气泡设置</div></div><span>></span></div>
                        <div class="discover-menu-item"><div class="discover-menu-left"><svg class="discover-menu-icon" viewBox="0 0 24 24"><path d="M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3Z" /></svg><div class="discover-menu-title">圆角模式</div></div><label class="toggle-switch"><input type="checkbox" id="roundedToggle" onchange="toggleRoundedCorners()"><span class="toggle-slider"></span></label></div>
                        <div class="discover-menu-item"><div class="discover-menu-left"><svg class="discover-menu-icon" viewBox="0 0 24 24"><path d="M12,18C8.69,18 6,15.31 6,12C6,8.69 8.69,6 12,6C15.31,6 18,8.69 18,12C18,15.31 15.31,18 12,18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7Z"/></svg><div class="discover-menu-title">夜间模式</div></div><label class="toggle-switch"><input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"><span class="toggle-slider"></span></label></div>
                    </div>
                </div>
            </div>

            <div id="bubbleSettingsScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToMySettings()">←</button>
                    <div class="nav-title">气泡设置</div>
                    <div></div>
                </div>
                <div class="modal-content-container">
                    <div class="modal-content">
                        <div class="bubble-settings">
                            <div class="bubble-color-group"><div class="bubble-color-label">我的气泡颜色</div><div class="bubble-color-row"><input type="color" class="bubble-color-picker" id="sentBubbleColorPicker" value="#FFEEF6" oninput="updateSentBubbleColor(this.value)"><input type="text" class="bubble-color-input" id="sentBubbleColorInput" value="#FFEEF6" placeholder="#FFEEF6" oninput="updateSentBubbleColorFromInput(this.value)"></div></div>
                            <div class="bubble-color-group"><div class="bubble-color-label">对方气泡颜色</div><div class="bubble-color-row"><input type="color" class="bubble-color-picker" id="receivedBubbleColorPicker" value="#E6F2FF" oninput="updateReceivedBubbleColor(this.value)"><input type="text" class="bubble-color-input" id="receivedBubbleColorInput" value="#E6F2FF" placeholder="#E6F2FF" oninput="updateReceivedBubbleColorFromInput(this.value)"></div></div>
                            <div class="bubble-css-group"><div class="bubble-color-label">自定义CSS样式</div><textarea class="bubble-css-textarea" id="bubbleCustomCSS" placeholder="输入完整的CSS规则来自定义气泡...&#10;提示: 为确保样式生效，请使用更具体的选择器。&#10;例如: &#10;.message.sent .message-content {&#10;  border: 2px solid #333;&#10;}" oninput="applyCustomBubbleCSS(this.value)"></textarea></div>
                            <div class="bubble-css-group"><div class="bubble-color-label">气泡预览</div><div class="bubble-preview-area" id="bubblePreviewArea"><div class="message received"><div class="chat-avatar">TA</div><div class="message-content">这是对方的气泡样式。</div></div><div class="message sent"><div class="message-content">这是你的气泡样式。</div><div class="chat-avatar">我</div></div></div></div>
                        </div>
                        <div class="modal-buttons" style="margin-top: 20px;"><button class="modal-btn modal-btn-cancel" onclick="backToMySettings()">取消</button><button class="modal-btn modal-btn-confirm" onclick="saveBubbleSettings()">保存</button></div>
                    </div>
                </div>
            </div>

            <div id="globalChatBgScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToMySettings()">←</button>
                    <div class="nav-title">全局聊天背景</div>
                    <div></div>
                </div>
                 <div class="modal-content-container">
                    <div class="modal-content">
                        <div class="background-grid" id="globalBgGrid">
                            <div class="background-option default" onclick="selectGlobalChatBg('default')"><span>默认</span></div>
                            <div class="background-option background-upload"><input type="file" accept="image/*" onchange="handleGlobalChatBgUpload(event)"><span>上传</span></div>
                        </div>
                        <div class="modal-buttons" style="margin-top: 20px;"><button class="modal-btn modal-btn-cancel" onclick="backToMySettings()">取消</button><button class="modal-btn modal-btn-confirm" onclick="saveGlobalChatBg()">保存</button></div>
                    </div>
                </div>
            </div>

            <div id="walletScreen" class="page"><div class="nav-bar"><button class="nav-btn" onclick="backToProfile()">←</button><div class="nav-title">钱包</div><div></div></div><div class="settings-content"><div class="balance-display"><div class="balance-amount" id="balanceAmount">¥ 0.00</div><div class="balance-label">余额</div></div><div class="wallet-menu"><div class="wallet-menu-item" onclick="rechargeWallet()"><span>💳 充值</span><span>></span></div><div class="wallet-menu-item" onclick="withdrawWallet()"><span>💰 提现</span><span>></span></div><div class="wallet-menu-item" onclick="transferWallet()"><span>💸 转账</span><span>></span></div><div class="wallet-menu-item" onclick="walletHistory()"><span>📋 账单</span><span>></span></div></div></div></div>
            <div id="favoritesScreen" class="page"><div class="nav-bar"><button class="nav-btn" onclick="backToProfile()">←</button><div class="nav-title">收藏</div><button class="nav-btn" onclick="toggleSelectMode()">选择</button></div><div class="select-mode" id="selectMode"><span id="selectedCount">已选择 0 项</span><button class="select-btn" onclick="deleteSelectedFavorites()">删除</button></div><div class="wechat-content"><div class="favorite-list" id="favoriteList"></div></div></div>
            <div id="worldBookScreen" class="page"><div class="nav-bar"><button class="nav-btn" onclick="goHome()">←</button><div class="nav-title">世界书</div><div style="display: flex; align-items: center;"><button class="nav-btn" onclick="openAddWorldBookFolderModal()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg></button><button class="nav-btn" onclick="openAddWorldBook()">+</button></div></div><div class="wechat-content"><div class="worldbook-list" id="worldBookList"></div></div></div>
            <div id="momentsScreen" class="page"><div class="nav-bar"><button class="nav-btn" onclick="backToDiscover()">←</button><div class="nav-title">朋友圈</div><button class="nav-btn" onclick="openAddMoment()">+</button></div><div class="wechat-content"><div id="momentsList"></div></div></div>
            
            <div id="diaryScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToDiscover()">←</button>
                    <div class="nav-title">日记</div>
                    <div id="diaryNavFriendName"></div>
                </div>
                <div class="diary-content-view">
                    <div id="diaryFriendList" class="friend-list"></div>
                    <div id="diaryContentArea" class="diary-list"></div>
                </div>
            </div>

            <div id="themeApp" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="goHome()">←</button>
                    <div class="nav-title">主题设置</div>
                    <div></div>
                </div>
                <div class="discover-content">
                    <div class="discover-menu">
                        <div class="discover-menu-item" onclick="openFontSettings()"><div class="discover-menu-left"><svg class="discover-menu-icon" viewBox="0 0 24 24"><path d="M2.5,4V6.5H6V20H8.5V6.5H12V4H2.5M13.5,4L12,20H14.5L15.2,14H18.8L19.5,20H22L20.5,4H13.5M15.8,6.5H18.2L18.5,11.5H15.5L15.8,6.5Z"/></svg><div class="discover-menu-title">字体设置</div></div><span>></span></div>
                        <div class="discover-menu-item" onclick="openWallpaperSettings()"><div class="discover-menu-left"><svg class="discover-menu-icon" viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"/></svg><div class="discover-menu-title">主屏幕壁纸</div></div><span>></span></div>
                        <div class="discover-menu-item" onclick="openIconSettings()"><div class="discover-menu-left"><svg class="discover-menu-icon" viewBox="0 0 24 24"><path d="M17.5,12A1.5,1.5 0 0,1 16 10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A9,9 0 0,0 21,12A9,9 0 0,0 12,3Z"/></svg><div class="discover-menu-title">图标设置</div></div><span>></span></div>
                        <div class="discover-menu-item" onclick="openComponentSettings()"><div class="discover-menu-left"><svg class="discover-menu-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 5v2h-4V5h4M9 5v6H5V5h4m10 8v6h-4v-6h4M9 17v2H5v-2h4M21 3h-8v6h8V3M11 3H3v10h8V3m10 8h-8v10h8V11m-10 4H3v6h8v-6Z"/></svg><div class="discover-menu-title">组件设置</div></div><span>></span></div>
                    </div>
                </div>
            </div>

            <div id="fontSettingsScreen" class="page"><div class="nav-bar"><button class="nav-btn" onclick="backToTheme()">←</button><div class="nav-title">字体设置</div><div></div></div> <div class="settings-content"><div class="font-options"><div class="font-option system selected" onclick="selectFont('system')"><div style="font-size: 18px; margin-bottom: 5px;">系统默认字体</div><div style="font-size: 14px; color: #666;">苹方/微软雅黑</div></div><div class="font-option custom" onclick="selectFont('custom')"><div style="font-size: 18px; margin-bottom: 5px;">自定义字体</div><div style="font-size: 14px; color: #666;">使用自定义字体URL</div></div></div><div class="font-url-control"><div class="bubble-color-label">自定义字体URL (TTF, OTF, WOFF)</div><input type="text" class="font-url-input" id="fontUrlInput" placeholder="输入字体文件URL..." oninput="applyCustomFont(this.value)"></div><div class="font-size-control"><span>字体大小:</span><input type="range" class="font-size-slider" id="fontSizeSlider" min="12" max="24" value="14" oninput="adjustFontSize(this.value)"><span id="fontSizeValue">14px</span></div><div class="font-color-control"><span>字体颜色:</span><input type="color" class="color-picker" id="fontColorPicker" value="#000000" onchange="updateFontColor(this.value)"><input type="text" class="color-code-input" id="fontColorInput" value="#000000" placeholder="#000000" oninput="updateFontColorFromInput(this.value)"></div><div class="modal-buttons" style="margin-top: 20px;"><button class="modal-btn modal-btn-cancel" onclick="backToTheme()">取消</button><button class="modal-btn modal-btn-confirm" onclick="saveFont()">保存</button></div></div></div>
            <div id="wallpaperSettingsScreen" class="page"><div class="nav-bar"><button class="nav-btn" onclick="backToTheme()">←</button><div class="nav-title">主屏幕壁纸</div><div></div></div><div class="modal-content-container"><div class="modal-content"><div class="background-grid" id="wallpaperGrid"><div class="background-option default" onclick="selectWallpaper('default')"><span>默认</span></div><div class="background-option background-upload"><input type="file" accept="image/*" onchange="handleWallpaperUpload(event)"><span>上传</span></div></div><div class="modal-buttons" style="margin-top: 20px;"><button class="modal-btn modal-btn-cancel" onclick="backToTheme()">取消</button><button class="modal-btn modal-btn-confirm" onclick="saveWallpaper()">保存</button></div></div></div></div>
            <div id="iconSettingsScreen" class="page"><div class="nav-bar"><button class="nav-btn" onclick="backToTheme()">←</button><div class="nav-title">图标设置</div><div></div></div><div class="settings-content"><div id="iconSettingsList"></div><div class="settings-buttons" style="margin-top: 20px;"><button class="settings-btn btn-danger" onclick="restoreDefaultIcons()">恢复默认</button></div></div></div>
            
            <!-- NEW: Component Settings Page -->
            <div id="componentSettingsScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToTheme()">←</button>
                    <div class="nav-title">组件设置</div>
                    <div></div>
                </div>
                <div class="discover-content">
                    <div class="discover-menu">
                        <div class="discover-menu-item">
                            <div class="discover-menu-title">组件设置</div></div><span>></span></div>
                    </div>
                </div>
            </div>
            
            <div id="settingsApp" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="goHome()">←</button>
                    <div class="nav-title">设置</div>
                    <div></div>
                </div>
                <div class="discover-content">
                    <div class="discover-menu">
                        <div class="discover-menu-item" onclick="openApiSettings()">
                            <div class="discover-menu-title">API 设置</div>
                            <span>></span>
                        </div>
                        <div class="discover-menu-item" onclick="importData()">
                            <div class="discover-menu-title">导入数据</div>
                            <span>></span>
                        </div>
                        <div class="discover-menu-item" onclick="exportData()">
                            <div class="discover-menu-title">导出数据</div>
                            <span>></span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="apiSettingsScreen" class="page"><div class="nav-bar"><button class="nav-btn" onclick="backToSettingsMenu()">←</button>
                    <div class="nav-title">API设置</div>
                    <div></div>
                </div>
                <div class="settings-content">
                    <div class="form-group"><label class="form-label">API反代地址</label><input type="text" class="form-input" id="apiUrl" placeholder="https://api.example.com/v1"></div>
                    <div class="form-group"><label class="form-label">API密钥</label><input type="password" class="form-input" id="apiKey" placeholder="sk-..."></div>
                    <div class="form-group"><label class="form-label">模型名称</label>
                        <div class="model-select-container">
                            <input type="text" class="model-select" id="modelName" placeholder="选择或输入模型名称" readonly onclick="toggleModelDropdown()">
                            <span class="dropdown-arrow">▼</span>
                            <div class="model-dropdown" id="modelDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="memoryTurns">记忆轮数 (0-1000)</label>
                        <input type="number" class="form-input" id="memoryTurns" placeholder="默认 10" min="0" max="1000">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="apiTemperature">Temperature (0.0 - 2.0)</label>
                        <input type="number" class="form-input" id="apiTemperature" placeholder="默认 0.9" min="0" max="2" step="0.1">
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label class="form-label" style="margin-bottom: 0;">开启AI时间感知</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="aiTimePerceptionToggle" onchange="toggleTimePerception()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-buttons">
                        <button class="settings-btn btn-secondary" onclick="fetchModels()">拉取模型</button>
                        <button class="settings-btn btn-primary" onclick="saveApiSettings()">保存设置</button>
                    </div>
                </div>
            </div>
            
            <!-- MODIFIED: Phone App Page -->
            <div id="phoneApp" class="page">
                <div class="nav-bar" id="phoneAppNavBar">
                    <button class="nav-btn" onclick="goHome()">←</button>
                    <div class="nav-title">手机</div>
                    <div></div>
                </div>
                <div class="phone-app-container">
                    <div id="phoneCharacterListScreen" class="friend-list">
                        <!-- Character list will be rendered here -->
                    </div>
                    <div id="simulatedPhoneScreen" style="display: none;">
                        <div class="sim-phone-frame">
                            <div class="sim-phone-screen">
                                <div class="sim-phone-screen-content" id="sim-home-screen-content">
                                    <div class="sim-app-grid">
                                        <!-- Sim App Icons -->
                                        <a class="sim-app-icon" onclick="openSimApp('wechat')">
                                            <div class="sim-app-icon-img">
                                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 5.79 2 10.5C2 13.6 3.66 16.34 6.34 17.91L5.5 21.5L9.67 19.33C10.42 19.53 11.2 19.65 12 19.65C17.52 19.65 22 15.86 22 11.15C22 6.44 17.52 2.65 12 2.65M8.5 13.15A1.5 1.5 0 1 1 7 11.65A1.5 1.5 0 0 1 8.5 13.15M15.5 13.15A1.5 1.5 0 1 1 14 11.65A1.5 1.5 0 0 1 15.5 13.15Z"/></svg>
                                            </div>
                                            <span class="sim-app-icon-label">微信</span>
                                        </a>
                                        <a class="sim-app-icon" onclick="openSimApp('memo')">
                                            <div class="sim-app-icon-img">
                                                <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" /></svg>
                                            </div>
                                            <span class="sim-app-icon-label">备忘录</span>
                                        </a>
                                        <a class="sim-app-icon" onclick="openSimApp('phone_call')">
                                            <div class="sim-app-icon-img">
                                                <svg viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/></svg>
                                            </div>
                                            <span class="sim-app-icon-label">电话</span>
                                        </a>
                                        <a class="sim-app-icon" onclick="openSimApp('browser')">
                                            <div class="sim-app-icon-img">
                                                <svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M19.1,4.9C19.1,4.9 19.1,4.9 19.1,4.9L17,8H13.6C13.5,7.2 13.2,6.5 12.8,5.8L15.6,3.4C16.9,3.8 18.1,4.3 19.1,4.9M12,10A2,2 0 1,1 14,12A2,2 0 0,1 12,10M4.9,19.1C4.9,19.1 4.9,19.1 4.9,19.1L7,16H10.4C10.5,16.8 10.8,17.5 11.2,18.2L8.4,20.6C7.1,20.2 5.9,19.7 4.9,19.1M4.9,4.9C5.9,4.3 7.1,3.8 8.4,3.4L11.2,5.8C10.8,6.5 10.5,7.2 10.4,8H7L4.9,4.9M15.6,20.6L12.8,18.2C13.2,17.5 13.5,16.8 13.6,16H17L19 .1,19.1C18.1,19.7 16.9,20.2 15.6,20.6Z" /></svg>
                                            </div>
                                            <span class="sim-app-icon-label">浏览器</span>
                                        </a>
                                        <a class="sim-app-icon" onclick="openSimApp('shopping')">
                                            <div class="sim-app-icon-img">
                                                <svg viewBox="0 0 24 24"><path d="M17,18C17,18.55 16.55,19 16,19S-1-.45-1-1 .45-1 1-1 1,.45 1,1M7,18C7,18.55 7.45,19 8,19S9,18.55 9,18 8.55,17 8,17 7,17.45 7,18M1,2V4H3L6.6,11.59L5.25,14.04 C5.09,14.32 5,14.65 5,15A2,2 0 0,0 7,17H19V15H7.42C7.29,15 7.17,14.89 7.17,14.75L7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.59 17.3,11.97L20.88,5.5C20.95,5.34 21,5.17 21,5A1,1 0 0,0 20,4H5.21L4.27,2H1Z"/></svg>
                                            </div>
                                            <span class="sim-app-icon-label">购物</span>
                                        </a>
                                        <a class="sim-app-icon" onclick="openSimApp('wallet')">
                                            <div class="sim-app-icon-img">
                                                <svg viewBox="0 0 24 24"><path d="M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M13,16H11V14H9V12H11V10H13V12H15V14H13V16M18,10H16V8H18V10M6,8H8V10H6V8Z" /></svg>
                                            </div>
                                            <span class="sim-app-icon-label">钱包</span>
                                        </a>
                                         <a class="sim-app-icon" onclick="openSimApp('photos')">
                                            <div class="sim-app-icon-img">
                                               <svg viewBox="0 0 24 24"><path d="M21,19V5C21,3.89 20.1,3 19,3H 5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19M8.5,13.5L11,16.5L14.5,12L19,18H5L8.5,13.5Z" /></svg>
                                            </div>
                                            <span class="sim-app-icon-label">相册</span>
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Sim App Views -->
                                <div class="sim-app-view" id="sim-wechat-view"></div>
                                <div class="sim-app-view" id="sim-memo-view"></div>
                                <div class="sim-app-view" id="sim-phone_call-view"></div>
                                <div class="sim-app-view" id="sim-browser-view"></div>
                                <div class="sim-app-view" id="sim-shopping-view"></div>
                                <div class="sim-app-view" id="sim-wallet-view"></div>
                                <div class="sim-app-view" id="sim-photos-view"></div>
                                
                                <!-- Sim App Detail Views (These will be populated by renderSimApp) -->
                                <div class="sim-app-view" id="sim-wechat-detail-view"></div>
                                <div class="sim-app-view" id="sim-memo-detail-view"></div>
                                <div class="sim-app-view" id="sim-browser-detail-view"></div>
                                <div class="sim-app-view" id="sim-shopping-detail-view"></div>
                                <div class="sim-app-view" id="sim-photos-detail-view"></div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <div id="addGroupChatModal" class="modal"><div class="modal-content"><div class="modal-title">选择联系人</div><div id="groupChatFriendList" class="multi-select-list" style="max-height: 300px;"></div><div class="modal-buttons" style="margin-top: 15px;"><button class="modal-btn modal-btn-cancel" onclick="closeGroupChatModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="createGroupChat()">确定</button></div></div></div>
    <div id="addFriendModal" class="modal"><div class="modal-content"><div class="modal-title">添加好友</div><div class="avatar-upload" id="friendAvatarUpload"><input type="file" accept="image/*"

onchange="handleFriendAvatarUpload(event)"><span id="friendAvatarPreview">+</span></div><input type="text" class="modal-input" id="friendNameInput" placeholder="好友昵称（必填）"><input type="text" class="modal-input" id="friendRemarkInput" placeholder="备注名称（可选）"><textarea class="modal-textarea" id="friendRoleInput" placeholder="角色设定（可选）...&#10;例如：你是一个可爱的猫娘，性格活泼开朗，喜欢用'喵'结尾说话..."></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAddFriendModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="addNewFriend()">添加</button></div></div></div>
    <div id="nameModal" class="modal"><div class="modal-content"><div class="modal-title">修改昵称</div><input type="text" class="modal-input" id="newNameInput" placeholder="请输入新昵称"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeNameModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeName()">确定</button></div></div></div>
    <div id="textEditModal" class="modal"><div class="modal-content"><div class="modal-title" id="textEditTitle">编辑文字</div><input type="text" class="modal-input" id="newTextInput" placeholder="请输入新内容"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeTextEditModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmTextEdit()">确定</button></div></div></div>
    <div id="avatarModal" class="modal"><div class="modal-content"><div class="modal-title">更换头像</div><div class="avatar-upload" id="userAvatarUpload"><input type="file" accept="image/*" onchange="handleUserAvatarUpload(event)"><span id="userAvatarPreview">+</span></div><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAvatarModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeAvatar()">确定</button></div></div></div>
    <div id="addWorldBookModal" class="modal"><div class="modal-content"><div class="modal-title">添加世界书</div><input type="text" class="modal-input" id="worldBookNameInput" placeholder="世界书昵称"><div class="form-group"><select class="form-select" id="worldBookFolderSelect"></select></div><textarea class="modal-textarea" id="worldBookContentInput" placeholder="世界书内容..." style="min-height: 120px;"></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAddWorldBookModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="addNewWorldBook()">添加</button></div></div></div>
    <div id="editWorldBookModal" class="modal"><div class="modal-content"><div class="modal-title">编辑世界书</div><input type="text" class="modal-input" id="editWorldBookNameInput" placeholder="世界书昵称"><div class="form-group"><select class="form-select" id="editWorldBookFolderSelect"></select></div><textarea class="modal-textarea" id="editWorldBookContentInput" placeholder="世界书内容..." style="min-height: 120px;"></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeEditWorldBookModal()">取消</button><button class="modal-btn modal-btn-confirm" id="saveWorldBookEditBtn">保存</button></div></div></div>
    <div id="addWorldBookFolderModal" class="modal"><div class="modal-content"><div class="modal-title">新建文件夹</div><input type="text" class="modal-input" id="worldBookFolderNameInput" placeholder="文件夹名称"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAddWorldBookFolderModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="addNewWorldBookFolder()">创建</button></div></div></div>
    <div id="signatureModal" class="modal"><div class="modal-content"><div class="modal-title">修改个性签名</div><input type="text" class="modal-input" id="newSignatureInput" placeholder="请输入新的个性签名"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeSignatureModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeSignature()">确定</button></div></div></div>
    <div id="locationModal" class="modal"><div class="modal-content"><div class="modal-title">修改地区</div><input type="text" class="modal-input" id="newLocationInput" placeholder="请输入地区"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeLocationModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeLocation()">确定</button></div></div></div>
    <div id="cameraModal" class="modal"><div class="modal-content"><div class="modal-title">AI拍摄</div><textarea class="modal-textarea" id="cameraDescInput" placeholder="请描述你要拍摄的内容...&#10;例如：一只可爱的小猫正在阳台上晒太阳" style="min-height: 100px;"></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeCameraModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmCamera()">拍摄</button></div></div></div>
    <div id="addMomentModal" class="modal"><div class="modal-content"><div class="modal-title">发布朋友圈</div><textarea class="modal-textarea" id="momentContentInput" placeholder="这一刻的想法..." style="min-height: 120px;"></textarea><div class="avatar-upload" id="momentImageUpload" style="width: 100px; height: 100px; margin-bottom: 15px;"><input type="file" accept="image/*" onchange="handleMomentImageUpload(event)"><span id="momentImagePreview">+</span></div><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAddMomentModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="postNewMoment()">发布</button></div></div></div>
    <div id="alertModal" class="modal"><div class="modal-content"><div class="modal-title">提示</div><div id="alertMessage"></div><div class="modal-buttons"><button class="modal-btn modal-btn-confirm" onclick="closeAlertModal()">确定</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content"><div class="modal-title">请确认</div><div id="confirmMessage" style="text-align: center; margin-bottom: 20px; line-height: 1.5;"></div><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" id="confirmCancelBtn">取消</button><button class="modal-btn modal-btn-confirm" id="confirmOkBtn">确定</button></div></div></div>
        <div id="momentCommentInputArea"><input type="text" id="momentCommentInput" placeholder="评论..."><button id="momentCommentSendBtn">发送</button></div>
    <div id="transferModal" class="modal"><div class="modal-content"><div class="modal-title">转账</div><input type="number" class="modal-input" id="transferAmountInput" placeholder="¥ 0.00"><input type="text" class="modal-input" id="transferRemarkInput" placeholder="添加备注 (可选)"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeTransferModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="sendTransfer()">转账</button></div></div></div>
    <div id="worldBookBindingModal" class="modal"><div class="modal-content"><div class="modal-title">绑定世界书</div><div id="worldBookBindingList" class="multi-select-list" style="max-height: 40vh; text-align: left;"></div><div class="modal-buttons" style="margin-top: 15px;"><button class="modal-btn modal-btn-cancel" onclick="closeWorldBookBindingModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmWorldBookBinding()">确定</button></div></div></div>
    
    <!-- NEW: Location Input Modal -->
    <div id="sendLocationModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">发送位置</div>
            <input type="text" class="modal-input" id="locationNameInput" placeholder="输入位置名称">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeLocationModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmSendLocation()">确定</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Image Description Modal -->
    <div id="imageDescriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">图片描述</div>
            <div id="imageDescriptionContent"></div>
            <div class="modal-buttons" style="margin-top: 15px;">
                <button class="modal-btn modal-btn-confirm" onclick="closeImageDescriptionModal()">确定</button>
            </div>
        </div>
    </div>
    
    <!-- [MODIFIED] New Emoji Modal -->
    <div id="addEmojiModal" class="modal">
        <div class="modal-content">
            <div class="modal-title"> 添加自定义表情</div>
            <div class="emoji-modal-tabs">
                <button class="emoji-modal-tab active" onclick="switchEmojiAddMode(this, 'single')">单个添加</button>
                <button class="emoji-modal-tab" onclick="switchEmojiAddMode(this, 'batch')">批量添加</button>
            </div>

            <!-- Single Add View -->
            <div id="emojiSingleAddView" class="emoji-modal-content-view active">
                <input type="text" class="modal-input" id="singleEmojiNameInput" placeholder="表情名称 (必填)">
                <input type="text" class="modal-input" id="singleEmojiUrlInput" placeholder="表情URL链接">
                <label for="singleEmojiUploadInput" class="emoji-modal-upload-btn">本地上传</label>
            </div>

            <!-- Batch Add View -->
            <div id="emojiBatchAddView" class="emoji-modal-content-view">
                <textarea id="batchEmojiInput" class="modal-textarea" placeholder="在此处粘贴表情信息，格式为：&#10;表情名1：URL1&#10;表情名2：URL2 (URL可换行)"></textarea>
                <label for="batchEmojiUploadInput" class="emoji-modal-upload-btn">本地上传</label>
            </div>

            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-cancel" onclick="closeAddEmojiModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmAddEmoji()">添加</button>
            </div>
        </div>
    </div>
    

     <div id="addMusicModal" class="modal">
            <div class="modal-content">
                <div class="modal-title">添加新歌曲</div>
                <input type="text" class="modal-input" id="songTitleInput" placeholder="歌曲名 (自动读取或手动填写)">
                <input type="text" class="modal-input" id="songArtistInput" placeholder="歌手 (自动读取或手动填写)">
                <button class="modal-btn" onclick="document.getElementById('songFileInput').click()">添加歌曲文件</button>
                <span id="songFileName" style="font-size: 12px; color: #666; display: block; text-align: center; margin-top: 5px;">未选择文件</span>
                <button class="modal-btn" style="margin-top: 10px;" onclick="document.getElementById('lrcFileInput').click()">添加歌词文件 (.lrc)</button>
                <span id="lrcFileName" style="font-size: 12px; color: #666; display: block; text-align: center; margin-top: 5px;">未选择文件</span>
                 <div class="modal-buttons" style="margin-top: 20px;">
                    <button class="modal-btn modal-btn-cancel" onclick="closeAddMusicModal()">取消</button>
                    <button class="modal-btn modal-btn-confirm" onclick="confirmAddSong()">完成</button>
                </div>
            </div>
        </div>


    <div id="playlistModal" class="modal">
        <div class="modal-content">
            <div class="playlist-header">
                <span id="playlistTitle">播放列表 (0)</span>
                <button id="openAddMusicBtn" onclick="openAddMusicModal()">+</button>
            </div>
            <div class="playlist-list" id="playlistList"></div>
        </div>
    </div>

    <div id="voiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">发送语音</div>
            <textarea class="modal-textarea" id="voiceInputText" placeholder="在此输入语音的文字内容..." style="min-height: 120px;"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick ="closeVoiceModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="sendVoiceMessage()">发送</button>
            </div>
        </div>
    </div>
    
    <!-- [MODIFIED] Heart's Voice Modal -->
    <div id="heartsVoiceModal" class="modal">
        <div class="modal-content">
            <div id="heartsVoiceHeader">
                <div id="heartsVoiceAvatar" class="friend-avatar"></div>
                <div id="heartsVoiceName"></div>
            </div>
            <div id="heartsVoiceEmoji">( ´• ω •` )</div>
            <div id="heartsVoiceThought">
                <div id="heartsVoiceFavorability"><strong>好感度：</strong><span>...</span></div>
                <div id="heartsVoiceDressing"><strong>着装：</strong><span>...</span></div>
                <div id="heartsVoiceAction"><strong>动作：</strong><span>...</span></div>
                <div id="heartsVoiceThoughtContent"><strong>心声：</strong><span>...</span></div>
            </div>
        </div>
    </div>


    <script>
        // --- IndexedDB Helper for Large Storage ---
        const dbManager = {
            db: null,
            init() {
                return new Promise((resolve, reject) => {
                    if (this.db) return resolve();
                    const request = indexedDB.open('WeChatDB', 1);
                    request.onerror = (event) => reject('IndexedDB error: ' + request.errorCode);
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('dataStore')) {
                            db.createObjectStore('dataStore', { keyPath: 'key' });
                        }
                    };
                });
            },
            set(key, value) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction(['dataStore'], 'readwrite');
                    const store = transaction.objectStore('dataStore');
                    const request = store.put({ key, value });
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject('Error setting data: ' + event.target.error);
                });
            },
            get(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction(['dataStore'], 'readonly');
                    const store = transaction.objectStore('dataStore');
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result ? request.result.value : null);
                    request.onerror = (event) => reject('Error getting data: ' + event.target.errorCode);
                });
            }
        };

function sanitizeForJSON(str) {
    if (typeof str !== 'string') return '';
    return str
        .replace(/\\/g, '\\\\')
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n');
}

async function requestPersistentStorage() {
    if (navigator.storage && navigator.storage.persist) {
        const isPersisted = await navigator.storage.persisted();
        if (!isPersisted) {
            const result = await navigator.storage.persist();
            if (result) {
                console.log("已请求持久性存储并获得授权");
            } else {
                console.warn("请求持久性存储被拒绝");
            }
        } else {
            console.log("已经是持久性存储模式");
        }
    }
}
// 在你的应用启动时调用
requestPersistentStorage();


        // 全局变量
        let currentChatFriendId = null;
        let currentlyDisplayedMessageCount = 0; // 新增：记录当前显示了多少条消息
let isLazyLoading = false; // 新增：防止在加载时重复触发
const CHAT_PAGE_SIZE = 30; // 新增：定义每次加载的消息数量

        let currentMessageElement = null;
        let isAIReplying = false;
        let friendAvatarImage = '';
        let tempEditingFriendAvatar = '';
        let userAvatarImage = '';
        let tempSelectedBackground = { type: 'default', customImage: '' };
        let selectedGlobalChatBg = 'default';
        let customGlobalChatBgImage = '';
        let selectedFont = 'system';
        let selectedFontSize = 14;
        let selectedFontColor = '#000000';
        let customFontUrl = '';
        let selectModeActive = false;
        let selectedFavorites = new Set();
        let quotedMessage = '';
        let diaries = [];
        let worldBooks = [];
        let worldBookFolders = [];
        let favorites = [];
        let moments = [];
        let chatHistories = {};
        let customEmojis = [];
        let selectedWallpaper = 'default';
        let customWallpaperImage = '';
        let customWidgetBackgroundImage = '';
        let roundedCornersEnabled = false;
        let darkModeEnabled = false;
        let multiSelectMode = false;
        let selectedMessages = new Set();
        let recalledMessages = new Map();
        let sentBubbleColor = '#FFEEF6';
        let receivedBubbleColor = '#E6F2FF';
        let customBubbleCSS = '';
        let customIcons = {};
        let momentImage = '';
        let momentImageDescription = ''; // For AI generated image descriptions
        let currentCommentingMomentId = null;
        let currentReplyToCommentId = null; 
        let currentReplyToAuthorId = null;  
        let currentEditingWidgetImageId = null;
        let currentEditingTextElement = null;
        let aiTimePerceptionEnabled = true;
        
        let notificationTimeout = null; // For clearing notification timer

        // NEW: State for component transparency
        let profileWidgetTransparent = false;
        let smallWidgetTransparent = false;
        
        // NEW: Emoji Modal v2 state
        let currentEmojiAddMode = 'single';
        let singleEmojiFile = null;
        let isEmojiManaging = false; // For deleting emojis

        // NEW: Camera function state
        let tempCameraDescription = '';

        let userProfile = {
            id: 'user_self',
            name: '可点击编辑',
            avatar: '',
            avatarImage: '',
            personality: '',
            background: '',
            signature: '可点击编辑',
            location: '可点击编辑',
            momentsCover: '',
            balance: 50000,
            patAction: '拍了拍'
        };
        
        let homeWidgetData = {
            headerText: '(:::[♡]:::)..?',
            image1: 'https://i.imgur.com/example-avatar-1.png',
            text1: 'have a nice day 🌟',
            image2: 'https://i.imgur.com/example-avatar-2.png',
            text2: '.o. HAPPY EVERYDAY ☻'
        };

        // Listen Together Variables
        let audioElement;
        let playlist = [];
        let currentSongIndex = -1;
        let parsedLyrics = [];
        let isRepeat = false;
        let listenTogetherInterval;
        let tempSongFile = null;
        let tempLrcFileContent = null;
        let songFileCache = {}; // Cache for blob URLs
        let customListenBg = '';
        let persistentVinylCover = ''; // MODIFIED: For persistent vinyl image
        let isListenSessionActive = false; 
        let listenTogetherFriendId = null; 
        let isListenInvitePending = false; 
        
        // [NEW] Voice Call variables
        let voiceCallFriendId = null;
        let isCallActive = false;
        let callStartTime = null;
        let callTimerInterval = null;
        let incomingCallData = null;


        // MODIFIED: Phone App variables
        let currentSimPhoneCharacterId = null;
        let simPhoneContentCache = {}; // Cache generated content, now with timestamps
        const SIM_CACHE_DURATION = 12 * 60 * 60 * 1000; // 12 hours


        let confirmCallback = null;
        let longPressTimer = null;
        
        // [NEW] Kaomoji List Definition
        const KAOMOJI_LIST = "ꉂ  ᳐  ˋ ᗜ ˊ    ᳐犭,눈 _ 눈,^ ㅇ ^,ㅎ_ㅎ,ㅇㅅㅇ,ㅋㅋㅋ,ㅇㅂㅇ,ㅇㅋㅇ,ㅎㅇㅎ,ㅎㅅㅎ,ㅎωㅎ,(ᐡ т  ̫ т ᐡ),=ᗜωᗜ=,>ヮ<,(՞_    ̫ _՞)ᐝ,⦁֊⦁꧞,՞⩌⌯⩌՞,ฅ´ ꄃ `ฅ,ᕱ⑅ᕱ,꒦ິ^꒦ິ,˶╹ꇴ╹˶,ฅ˙Ⱉ˙ฅ,ʚ✞ɞ,૮ ˃̵ ֊ ˂̵  ა,ᐡ•͈ ·̭ •͈ᐡ,៸៸᳐⦁⩊<៸៸᳐ ੭ﾞ🐾,/ᐠ .⸝⸝⸝. ྀིﾏ,. ₍˄ ₗ   ̫ ₗ ˄₎◞ ̑̑,ଘ៸៸᳐⦁⩊⦁៸៸᳐ଓ,^›⩊‹^ ੭,៸៸᳐>⩊<៸៸᳐,^⦁᎑-^ ੭,₍^˶ ╸𖥦  ╸˵^₎⟆,＞𐋣＜,ฅᐞ˶⦁༝⦁˶ᐞฅ,𓈒♡𐅛 ͚ ꠆. .  ꠆ ͚𑁨ྀི♡,ミ ᴗ͈  。ᴗ͈ ミ,^⎚˕⎚^,⦁֊⦁꧞,՞⩌⌯⩌՞ ᶻ 𝗓,´⚰︎`˵ಣ,⌯oᴗ<⌯ಣ,ฅ´ ꄃ `ฅ՞,˶╹ꇴ╹˶,ᐞ･֊･ᐞฅ,๑'~'๑,=⩌⩊⩌=,＞𐋣＜,ÒωÓ！,♡(ˆ꜆ . ω . ). ω . ꜀ˆ)♡,Ｏ(≧▽≦)Ｏ,ᯠ _   ̫  _ ᯄ,˶╹ꇴ╹˶,⁃ ⩊ ⁃,ᶻz ₍^_   ̫ _^₎,˶⊗ 𐋣 ᗜ˶ಣ,ꉂ૮ o̴̶̷᷄ ·̫ᕳᕲა,• ·̫ •,⁺ʚ> ·̫ <ɞ⁺,（ ≥ × ≤ ）, /•᷅‎‎•᷄\୭,⌯'ᵕ'⌯,⦁֊⦁꧞,՞⸝⸝'ᜊ'⸝⸝՞♥︎,๑>ᴗO๑,=• ֊ •=,ꉂ ･ ･ ☆,Z☡zᶻ,ᕑᗢᓫ,˃̵͈̑ᴗ˂̵͈̑,𖦹𖦹 .ᐟ.ᐟ,⌯>ᴗo⌯ಣ,^ ̳- ‧̫ • ̳^ฅ,^•ω<^ ੭,₍ᐢ..ᐢ₎ᐝ,•͈ᴗ⁃͈,•͈ ₃ •͈,⌯'Ⱉ'⌯,^⌯𖥦⌯^੭,ᖰ⌯'▾'⌯ᖳ,^_^,₍^ₗ   ̫˳ ₗ^₎,₍ᐢ⸝⸝-ᴗ-⸝⸝ᐢ₎,₍ᐢ⸝⸝• ֊ •⸝⸝ᐢ₎,ฅ( ̳• ·̫ • ̳ฅ),(꜆꜄꜆˙꒳˙)꜆꜄꜆,୧(๑⃙⃘⁃̀⩊⁃́๑⃙⃘)୨,៸៸᳐ÒωÓ៸៸᳐,ꉂ  ᳐  ˋ ᗜ ˊ    ᐐ犭,-ᶻz ₍^_   ̫ _^₎,˶⊗ ᎑ ᗜ˶ಣ,ꉂ૮˶⩌⩊ᕳᕲ˶ა,ㅎωㅎ,= ᗜ ω ᗜ.=,(ᐡ т   ̫ т ᐡ),>ヮ<,＞𐋣＜,⦁֊⦁꧞,໒𖦹 𖦹  ͛১,૮ ˃̵ ֊ ˂̵  ა,ᐡ•͈ ·̭ •͈ᐡ,ദ്ദി˶•̀֊•́)✧,ദ്ദി˶•̀֊<)✧,ദ്ദി˶ｰ̀֊ｰ́ )✧,ᕑᗢᓫ !!,•̆.•̑,ටᆼට,⁽¯꒳¯⁾,ᥫᩣᵕ̈,՞⩌⌯⩌՞,ฅ´ ꄃ `ฅ,ᕱ⑅ᕱ,˶╹ꇴ╹˶,ฅ˙Ⱉ˙ฅ,⦁ ㅈ -,=×ω×=,(･∞･ﾐэ )Э,ᡣ ︠𓈒. .𓈒 ︡𐑠,𐙚・⋆・𐙚,(ෆ• ֊ •ෆ）,ฅᐞ˶⦁༝⦁˶ᐞฅ,𓈒♡𐅛 ͚ ꠆. .  ꠆ ͚𑁨ྀི♡,ミ ᴗ͈  。ᴗ͈ ミ,(ᐡ ɞ̴̶̷ . ɞ̴̶̷ ᐡ),✧(≖ ◡ ≖✿),U- ˕ -Uᶻᶻᶻ,ᨦ₍ᐢ..ᐢ₎ᨩ ໋·̩͙,૮⑅•̤ ༝ •̤⑅ა,ᘏ ୨୧‬ ᘏ,๑>ᴗO๑,=• ֊ •=,ꉂ ･ ･ ☆,Z☡zᶻ,ᕑᗢᓫ,˃ᴗ˂̵͈̑,𖦹𖦹 .ᐟ.ᐟ,^ ̳- ‧̫ • ̳^ฅ,^•ω<^ ੭,^⌯𖥦⌯^੭,ᜊ꒰๑˃͈꒵˂͈๑꒱ᜊ,ᖰ⌯'▾'⌯ᖳ,៸៸᳐>⩊<៸៸᳐,૮⑉･-･⑉ა,✩*:.⸝⸝>o<⸝⸝.:*✩,՞⸝⸝'ᜊ'⸝⸝՞,⌯'▾'⌯,• ︡ᯅ•︠,ᗦ↞︎◃,꒰১☆⁺໒꒱,˶‾᷄   ⁻̫ ‾᷅˵,˙Ⱉ˙,˃̶͈̀ε ˂̶ ͈ ͈,ᵔ·͈༝༝༝·͈ᵔ,･ꈊ･,ᕑᗢᓫ,♥︎︎ᯐ,ᰔᩚ,៷>ᴗ<៷,•͈ ₃ •͈,⌯'Ⱉ'⌯,𖠚ᐝ,ყ ᥱ ᥉,𖤣𖥧𖥣｡,⌯>ᴗo⌯ಣ,⌯˃ ᵕ ˂⌯ಣ,⌯>𖥦<⌯ಣ,⌯˃̶ᗜ˂̶⌯ಣ,⌯ᕑᗢᓫ⌯ಣ。,⌯>ᴗ<⌯ಣ,⌯•͈ᴗ•͈⌯ಣ,⌯ᐢᗜᐢ⌯ಣ,⌯･-･⌯ಣ,⌯>v<⌯ಣ,⌯･ᴗ･⌯ಣ,⌯>₃<⌯ಣ,⌯•͈ ₃ •͈⌯ಣ。,⌯⁰ᵕᵔ⌯ಣ,⌯•͈⌔•͈⌯ಣ,⌯＞◡❛⌯ಣ,⌯' ꇴ '⌯ಣ。,⌯･∀･⌯ಣ,⌯>ෆ<⌯ಣ,⌯ᵔᵕᵔ⌯ಣ,𝐛𝐛 •͈ᴗ⁃͈,ოყ ხαხყ,𖨆♡𖨆,•︡ᯅ•︠,•͈ᴗ⁃͈★,ʚ •͈˽•͈ ིྀɞ,˶՞ɞ̴̶̷.ɞ̴̶̷՞˶,ฅ՞••՞ฅ,₌᳐･֊･₌᳐੭。,˃̶͈̀ε ˂̶ ͈,ꈨຶꎁꈨຶ,•͈ ₃ •͈,๐•ᴗ•๐,⌯>ᗜ<⌯,⌯˃~˂⌯,⌯･ᴗ･⌯,⌯•͈ ₃ •͈⌯,⌯^𖥦^⌯,⌯⁍̴̛ᴗ⁍̴̛⌯,⌯˃͈꒵˂͈⌯,⌯⁰ᵕᵔ⌯,⌯˙Ⱉ˙⌯,₌ ･ ᵕ ･ ₌,=• ֊ •=,ᜊ>ᴗ<ᜊ,^⌯𖥦⌯^੭,𖦹ࡇ𖦹 .ᐟ.ᐟ,૮  ´͈ ᗜ `͈ ა♡,૮ ᴗ͈ˬᴗ͈ෆა,૮⑉･-･⑉ა,ᵔ·͈༝༝༝·͈ᵔ,🐾₊⁺ S,^ ̳- ‧̫ • ̳^ฅ,⸝⸝っ·̫ •⸝⸝,˙Ⱉ˙,꒰ᐢ. .ᐢ꒱₊˚⊹✧,՞⸝⸝'ᜊ'⸝⸝՞,૮ • ·̫ •̥ ა,𑁊^.  ̫ .^𑁊,^ ̳• ·̫ • ̳^,ꉂ ･ ･ ☆,◍˃ᵕ˂◍,(◍＞◡＜◍),૮◍'ㅅ'◍ა,^>⸝⸝⸝⸝<^੭ﾞ,/ᐠ - ˕ -マ Ⳋ,/ᐠ .⸝⸝⸝. ྀིﾏ,づ♡ど,՞•･•՞🐾,⁺ʚ⦁⩊⦁ɞ⁺,૮ ˘͈ᵕ ˘͈ ა,๑⃙⃘´༥`๑⃙⃘,• ༝༝༝ •".split(',').map(s => s.trim()).filter(Boolean);

        // --- [MODIFIED] Heart's Voice Modal Functions ---
        function openHeartsVoiceModal() {
            const friend = friends.find(f => f.id === currentChatFriendId);
            if (!friend) return;

            const modal = document.getElementById('heartsVoiceModal');
            const avatarDiv = document.getElementById('heartsVoiceAvatar');
            const nameDiv = document.getElementById('heartsVoiceName');
            const emojiDiv = document.getElementById('heartsVoiceEmoji');
            
            // Get all the span elements for content
            const favorabilitySpan = document.querySelector('#heartsVoiceFavorability span');
            const dressingSpan = document.querySelector('#heartsVoiceDressing span');
            const actionSpan = document.querySelector('#heartsVoiceAction span');
            const thoughtSpan = document.querySelector('#heartsVoiceThoughtContent span');

            nameDiv.textContent = friend.remark || friend.name;
            if (friend.avatarImage) {
                avatarDiv.style.backgroundImage = `url(${friend.avatarImage})`;
                avatarDiv.textContent = '';
            } else {
                avatarDiv.style.backgroundImage = '';
                avatarDiv.textContent = friend.avatar || '?';
            }
            
            const heartsVoiceData = friend.heartsVoice || { 
                emoji: '( ´• ω •` )', 
                favorability: '...',
                dressing: '...', 
                action: '...', 
                thought: '...' 
            };
            emojiDiv.textContent = heartsVoiceData.emoji;

            // Correctly map the data to the spans
            favorabilitySpan.textContent = heartsVoiceData.favorability;
            dressingSpan.textContent = heartsVoiceData.dressing;
            actionSpan.textContent = heartsVoiceData.action;
            thoughtSpan.textContent = heartsVoiceData.thought;
            
            modal.classList.add('show');
            modal.addEventListener('click', closeHeartsVoiceModalOnClickOutside);
        }
        
        function closeHeartsVoiceModal() {
            const modal = document.getElementById('heartsVoiceModal');
            modal.classList.remove('show');
            modal.removeEventListener('click', closeHeartsVoiceModalOnClickOutside);
        }

        function closeHeartsVoiceModalOnClickOutside(event) {
            if (event.target.id === 'heartsVoiceModal') {
                closeHeartsVoiceModal();
            }
        }

        function showToast(message, duration = 3000) {
            let toast = document.getElementById('toast-notification');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-notification';
                toast.style.cssText = 'position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:white; padding:10px 20px; border-radius:8px; z-index:10000; transition: opacity 0.5s, bottom 0.5s; opacity: 0;';
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.bottom = '90px';
            }, 10);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.bottom = '80px';
            }, duration);
        }

        function showAlert(message) {
            document.getElementById('alertMessage').innerHTML = message.replace(/\n/g, '<br>');
            document.getElementById('alertModal').classList.add('show');
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('show');
        }
        
        // NEW: Image Description Modal Functions
        function showImageDescription(description ) {
            document.getElementById('imageDescriptionContent').textContent = description;
            document.getElementById('imageDescriptionModal').classList.add('show');
        }

        function closeImageDescriptionModal() {
            document.getElementById('imageDescriptionModal').classList.remove('show');
        }

        function showConfirm(message, onConfirm) {
            confirmCallback = onConfirm;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('show');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
            confirmCallback = null;
        }

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        document.addEventListener('touchstart', (event) => (event.touches.length > 1) && event.preventDefault(), { passive: false});
        
        function updateBubblePreview() {
            const sentColor = document.getElementById('sentBubbleColorInput').value;
            const receivedColor = document.getElementById('receivedBubbleColorInput').value;
            const customCSS = document.getElementById('bubbleCustomCSS').value;
            const previewStyleTag = document.getElementById('customBubblePreviewStyle');
            if (!previewStyleTag) return;
            const scopedCSS = customCSS.replace(new RegExp(/\.message/g), '.bubble-preview-area .message');
            previewStyleTag.textContent = `
                .bubble-preview-area .message.sent .message-content { background-color: ${sentColor}; }
                .bubble-preview-area .message.received .message-content { background-color: ${receivedColor}; }
                ${scopedCSS}
            `;
        }

        function openBubbleSettings() {
            setActivePage('bubbleSettingsScreen');
            document.getElementById('sentBubbleColorPicker').value = sentBubbleColor;
            document.getElementById('sentBubbleColorInput').value = sentBubbleColor;
            document.getElementById('receivedBubbleColorPicker').value = receivedBubbleColor;
            document.getElementById('receivedBubbleColorInput').value = receivedBubbleColor;
            document.getElementById('bubbleCustomCSS').value = customBubbleCSS;
            updateBubblePreview();
        }

        function updateSentBubbleColor(color) {
            document.getElementById('sentBubbleColorInput').value = color;
            updateBubblePreview();
        }

        function updateSentBubbleColorFromInput(color) {
            if (/^#[0-9A-F]{6}$/i.test(color )) document.getElementById('sentBubbleColorPicker').value = color;
            updateBubblePreview();
        }

        function updateReceivedBubbleColor(color) {
            document.getElementById('receivedBubbleColorInput').value = color;
            updateBubblePreview();
        }

        function updateReceivedBubbleColorFromInput(color) {
            if (/^#[0-9A-F]{6}$/i.test(color)) document.getElementById('receivedBubbleColorPicker').value = color;
            updateBubblePreview();
        }

        function applyBubbleColors() {
            document.documentElement.style.setProperty('--message-sent-bg', sentBubbleColor);
            document.documentElement.style.setProperty('--message-received-bg', receivedBubbleColor);
            // NEW: Calculate and set quote border colors
            const sentBorder = calculateBorderColor(sentBubbleColor, darkModeEnabled);
            const receivedBorder = calculateBorderColor(receivedBubbleColor, darkModeEnabled);
            document.documentElement.style.setProperty('--sent-quote-border-color', sentBorder);
            document.documentElement.style.setProperty('--received-quote-border-color', receivedBorder);
        }

        function calculateBorderColor(hex, isDark) {
            // Simple darken/lighten function for the border
            let color = hex.startsWith('#') ? hex.slice(1) : hex;
            let r = parseInt(color.substring(0, 2), 16);
            let g = parseInt(color.substring(2, 4), 16);
            let b = parseInt(color.substring(4, 6), 16);
            
            // If dark mode is on for the user bubble, we need to lighten it
            // Otherwise, we darken
            const amount = isDark ? 40 : -40;

            r = Math.max(0, Math.min(255, r + amount));
            g = Math.max(0, Math.min(255, g + amount));
            b = Math.max(0, Math.min(255, b + amount));
            
            return `#${(r).toString(16).padStart(2, '0')}${(g).toString(16).padStart(2, '0')}${(b).toString(16).padStart(2, '0')}`;
        }


        function applyCustomBubbleCSS(css) {
            customBubbleCSS = css;
            let styleTag = document.getElementById('customBubbleStyle');
            if (styleTag) styleTag.textContent = css;
            updateBubblePreview();
        }

        async function saveBubbleSettings() {
            sentBubbleColor = document.getElementById('sentBubbleColorInput').value;
            receivedBubbleColor = document.getElementById('receivedBubbleColorInput').value;
            customBubbleCSS = document.getElementById('bubbleCustomCSS').value;
            applyBubbleColors();
            applyCustomBubbleCSS(customBubbleCSS);
            await saveData();
            showAlert('气泡设置已保存');
            backToMySettings();
        }

        function getFontFormatFromUrl(url) {
            if (!url) return null;
            const extension = url.split('.').pop().toLowerCase().split('?')[0];
            return { 'ttf': 'truetype', 'otf': 'opentype', 'woff': 'woff', 'woff2': 'woff2' }[extension] || null;
        }

        function applyCustomFont(url) {
            customFontUrl = url;
            let existingLink = document.getElementById('customFontLink');
            if (existingLink) existingLink.remove();
            let existingStyle = document.getElementById('customFontStyle');
            if (existingStyle) existingStyle.remove();
            if (url.trim()) {
                const fontFormat = getFontFormatFromUrl(url);
                if (fontFormat) {
                    const style = document.createElement('style');
                    style.id = 'customFontStyle';
                    const fontName = 'UserCustomFont';
                    style.textContent = `@font-face { font-family: '${fontName}'; src: url('${url}') format('${fontFormat}'); }`;
                    document.head.appendChild(style);
                    if (selectedFont === 'custom') document.documentElement.style.setProperty('--custom-font-family', `'${fontName}'`);
                } else if (url.includes('googleapis.com/css')) {
                    const link = document.createElement('link');
                    link.id = 'customFontLink';
                    link.rel = 'stylesheet';
                    link.href = url;
                    document.head.appendChild(link);
                    try {
                        const family = new URL(url).searchParams.get('family');
                        if (family) {
                            const fontFamily = family.split(':')[0].replace(/\+/g, ' ');
                            if (selectedFont === 'custom') document.documentElement.style.setProperty('--custom-font-family', `'${fontFamily}'`);
                        }
                    } catch (e) { console.error("Could not parse Google Font URL", e); }
                }
            }
            applyFont();
        }
        
        function updateFontColor(color) {
            selectedFontColor = color;
            document.getElementById('fontColorInput').value = color;
            applyFont();
        }

        function updateFontColorFromInput(color) {
            if (/^#[0-9A-F]{6}$/i.test(color)) {
                selectedFontColor = color;
                document.getElementById('fontColorPicker').value = color;
                applyFont();
            }
        }

        async function toggleDarkMode() {
            darkModeEnabled = document.getElementById('darkModeToggle').checked;
            applyDarkMode();
            await saveData();
        }

        function applyDarkMode() {
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) toggle.checked = darkModeEnabled;
            document.body.classList.toggle('wechat-dark-mode', darkModeEnabled);
            document.querySelector('.phone').classList.toggle('wechat-dark-mode', darkModeEnabled);
        }

        async function toggleRoundedCorners() {
            roundedCornersEnabled = document.getElementById('roundedToggle').checked;
            applyRoundedCorners();
            await saveData();
        }

        function applyRoundedCorners() {
            const toggle = document.getElementById('roundedToggle');
            if (toggle) toggle.checked = roundedCornersEnabled;
            document.querySelector('.phone').classList.toggle('wechat-rounded', roundedCornersEnabled);
        }

        function startMultiSelect() {
            multiSelectMode = true;
            selectedMessages.clear();
            const chatMessages = document.getElementById('chatMessages');
            const toolbar = document.getElementById('multiSelectToolbar');
            chatMessages.classList.add('multi-select-mode');
            toolbar.classList.add('show');
            chatMessages.querySelectorAll('.message:not(.recall-message)').forEach(msg => {
                if (!msg.querySelector('.message-checkbox')) {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'message-checkbox';
                    checkbox.onclick = (e) => { e.stopPropagation(); toggleMessageSelection(msg); };
                    msg.prepend(checkbox);
                }
            });
            updateMultiSelectCount();
            hideMessageMenu();
        }

        function toggleMessageSelection(messageElement) {
            const messageId = messageElement.getAttribute('data-message-id');
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId); 
                messageElement.classList.remove('selected');
            } else {
                selectedMessages.add(messageId);
                messageElement.classList.add('selected');
            }
            updateMultiSelectCount();
        }

        function updateMultiSelectCount() {
            document.getElementById('multiSelectCount').textContent = `已选择 ${selectedMessages.size} 条消息`;
        }

        function deleteSelectedMessages() {
            if (selectedMessages.size === 0) return showAlert('请先选择要删除的消息');
            showConfirm(`确定要删除 ${selectedMessages.size} 条消息吗？`, async (confirmed) => {
                if (!confirmed) return;
                const history = chatHistories[currentChatFriendId] || [];
                chatHistories[currentChatFriendId] = history.filter(msg => !selectedMessages.has(String(msg.id)));
                selectedMessages.forEach(id => document.querySelector(`[data-message-id="${id}"]`)?.remove());
                await saveData();
                exitMultiSelectMode();
            });
        }

        function exitMultiSelectMode() {
            multiSelectMode = false;
            selectedMessages.clear();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.classList.remove('multi-select-mode');
            document.getElementById('multiSelectToolbar').classList.remove('show');
            chatMessages.querySelectorAll('.message-checkbox').forEach(cb => cb.remove());
            chatMessages.querySelectorAll('.message.selected').forEach(msg => msg.classList.remove('selected'));
        }
        
        function showRecalledMessage(messageId) {
            const msg = (chatHistories[currentChatFriendId] || []).find(m => String(m.id) === messageId);
            if (msg && msg.recalledContent) {
                document.getElementById('recalledMessageContent').textContent = msg.recalledContent;
                document.getElementById('recalledMessagePopup').classList.add('show');
            }
        }

        function closeRecalledMessagePopup() {
            document.getElementById('recalledMessagePopup').classList.remove('show');
        }

        async function saveData() {
            try {
                // Before saving, convert any raw file objects in playlist to something serializable
                const serializablePlaylist = await Promise.all(playlist.map(async (song) => {
                    // If url is a blob, it won't survive session reload. We need to store the file content.
                    if (song.file instanceof File) { // Check if it's a real file object
                        return { ...song, file: await fileToSerializable(song.file) };
                    }
                    return song;
                }));

                const dataToSave = { friends, userProfile, diaries, worldBooks, worldBookFolders, favorites, moments, chatHistories, customEmojis, selectedGlobalChatBg, customGlobalChatBgImage, selectedFont, selectedFontSize, selectedFontColor, customFontUrl, selectedWallpaper, customWallpaperImage, customWidgetBackgroundImage, roundedCornersEnabled, darkModeEnabled, sentBubbleColor, receivedBubbleColor, customBubbleCSS, customIcons, playlist: serializablePlaylist, recalledMessages: Array.from(recalledMessages.entries()), customListenBg, persistentVinylCover, homeWidgetData, profileWidgetTransparent, smallWidgetTransparent, simPhoneContentCache };
                
                await dbManager.set('wechatData', dataToSave);
                const apiSettings = { 
                    apiUrl: document.getElementById('apiUrl').value, 
                    apiKey: document.getElementById('apiKey').value, 
                    modelName: document.getElementById('modelName').value,
                    memoryTurns: document.getElementById('memoryTurns').value,
                    apiTemperature: document.getElementById('apiTemperature').value,
                    aiTimePerceptionEnabled: aiTimePerceptionEnabled
                };
                await dbManager.set('apiSettings', apiSettings);

            } catch(e) {
                console.error("保存数据时出错:", e);
                if (e.name === 'QuotaExceededError') {
                    showAlert("保存数据失败：存储空间已满！\ \n\n请尝试导出并清理数据，或删除一些占用空间大的内容（如图片、好友等）。");
                } else {
                    showAlert(`保存数据失败: ${e.message}`);
                }
            }
        }

        // Helper functions for file serialization
        function fileToSerializable(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    resolve({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        lastModified: file.lastModified,
                        data: reader.result // This will be a Base64 string
                    });
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function serializableToFile(serializable) {
            const byteString = atob(serializable.data.split(',')[1]);
            const mimeString = serializable.data.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new File([ab], serializable.name, { type: mimeString, lastModified: serializable.lastModified });
        }


        async function loadData() {
            const saved = await dbManager.get('wechatData');
            if (saved) {
                try {
                    const data = saved;
                    friends = data.friends || [];
                    friends.forEach(f => { 
                        if (!f.chatBackground) f.chatBackground = { type: 'default', customImage: '' }; 
                        if (!f.worldBookIds) f.worldBookIds = [];
                        if (f.diaryWritingUrge === undefined) f.diaryWritingUrge = 0; // Initialize for older data
                        if (f.balance === undefined) f.balance = Infinity; // Set balance to infinite for existing friends
                        if (f.patAction === undefined) f.patAction = `拍了拍 "${f.name}"`;
                        if (f.heartsVoice === undefined) f.heartsVoice = { emoji: '( ´• ω •` )', thought: '...', dressing: '...', action: '...', favorability: '...' };
                    });
                    userProfile = data.userProfile || { id: 'user_self', name: '可点击编辑', avatar: '', avatarImage: '', personality: '', background: '', signature: '可点击编辑', location: '可点击编辑', momentsCover: '', balance: 50000, patAction: '拍了拍' };
                    if (!userProfile.id) userProfile.id = 'user_self';
                    if (userProfile.balance === undefined) userProfile.balance = 50000;
                    if (userProfile.patAction === undefined) userProfile.patAction = '拍了拍';
                    diaries = data.diaries || [];
                    worldBooks = data.worldBooks || [];
                    worldBookFolders = data.worldBookFolders || [];
                    favorites = data.favorites || [];
                    moments = data.moments || [];
                    chatHistories = data.chatHistories || {};
                    customEmojis = data.customEmojis || [];
                    selectedGlobalChatBg = data.selectedGlobalChatBg || 'default';
                    customGlobalChatBgImage = data.customGlobalChatBgImage || '';
                    selectedFont = data.selectedFont || 'system';
                    selectedFontSize = data.selectedFontSize || 14;
                    selectedFontColor = data.selectedFontColor || '#000000';
                    customFontUrl = data.customFontUrl || '';
                    selectedWallpaper = data.selectedWallpaper || 'default';
                    customWallpaperImage = data.customWallpaperImage || '';
                    customWidgetBackgroundImage = data.customWidgetBackgroundImage || '';
                    roundedCornersEnabled = data.roundedCornersEnabled || false;
                    darkModeEnabled = data.darkModeEnabled || false;
                    sentBubbleColor = data.sentBubbleColor || '#FFEEF6';
                    receivedBubbleColor = data.receivedBubbleColor || '#E6F2FF';
                    customBubbleCSS = data.customBubbleCSS || '';
                    customIcons = data.customIcons || {};
                    homeWidgetData = data.homeWidgetData || homeWidgetData;
                    profileWidgetTransparent = data.profileWidgetTransparent || false;
                    smallWidgetTransparent = data.smallWidgetTransparent || false;
                    simPhoneContentCache = data.simPhoneContentCache || {};
                    
                    if (data.playlist) {
                        playlist = (data.playlist).map(song => {
                            if (song.file && song.file.data) { // Check if it's serialized file data
                                const file = serializableToFile(song.file);
                                return { ...song, file };
                            }
                            return song; // It might be an old format or already a file object
                        });
                    } else {
                        playlist = [];
                    }

                    if (data.recalledMessages) recalledMessages = new Map(data.recalledMessages);
                    if (!userProfile.signature) userProfile.signature = '可点击编辑';
                    if (!userProfile.location) userProfile.location = '可点击编辑';
                    if (!userProfile.momentsCover) userProfile.momentsCover = '';
                    customListenBg = data.customListenBg || '';
                    persistentVinylCover = data.persistentVinylCover || '';
                } catch (e) {
                    console.error('加载数据失败:', e);
                    showAlert("加载本地数据失败，将初始化默认数据。");
                    await initDefaultData();
                }
            } else {
                await initDefaultData();
            }
            await loadApiSettings();
            applyAllSettings();
            updateHomeWidget();
        }
        
        async function loadApiSettings() {
             const settings = await dbManager.get('apiSettings') || {};
             document.getElementById('apiUrl').value = settings.apiUrl || '';
             document.getElementById('apiKey').value = settings.apiKey || '';
             document.getElementById('modelName').value = settings.modelName || '';
             document.getElementById('memoryTurns').value = settings.memoryTurns || 10;
             document.getElementById('apiTemperature').value = settings.apiTemperature || 0.9;
             aiTimePerceptionEnabled = settings.aiTimePerceptionEnabled !== false; // Default to true if undefined
             document.getElementById('aiTimePerceptionToggle').checked = aiTimePerceptionEnabled;
        }

        function applyAllSettings() {
            applyCustomFont(customFontUrl);
            applyFont();
            applyGlobalChatBackground();
            applyWallpaper();
            applyWidgetBackground();
            applyRoundedCorners();
            applyDarkMode();
            applyBubbleColors();
            applyCustomBubbleCSS(customBubbleCSS);
            applyCustomIcons();
            applyListenTogetherCustomImages();
            applyComponentTransparency();
            updateProfileDisplay();
            updateWalletDisplay();
        }
        
        // NEW: Apply Component Transparency Settings
        function applyComponentTransparency() {
            const profileContainer = document.getElementById('profileWidgetContainer');
            const smallWidget = document.getElementById('homeScreenWidget');
            if (profileContainer) profileContainer.classList.toggle('transparent-bg', profileWidgetTransparent);
            if (smallWidget) smallWidget.classList.toggle('transparent-bg', smallWidgetTransparent);

            const profileToggle = document.getElementById('profileWidgetBgToggle');
            const smallToggle = document.getElementById('smallWidgetBgToggle');
            if (profileToggle) profileToggle.checked = profileWidgetTransparent;
            if (smallToggle) smallToggle.checked = smallWidgetTransparent;
        }

        async function initDefaultData() {
            friends = [];
            userProfile = { id: 'user_self', name: '我', avatar: '我', avatarImage: '', personality: '一个普通人', background: '', signature: '编辑个性签名', location: '地球', momentsCover: '', balance: 50000, patAction: '拍了拍' };
            worldBooks = [];
            worldBookFolders = [];
            chatHistories = {};
            customEmojis = [];
            moments = [];
            playlist = [];
            simPhoneContentCache = {};
            await saveData();
        }

        function updateProfileDisplay() {
            document.getElementById('profileName').textContent = userProfile.name;
            const avatarElements = [document.getElementById('profileAvatar'), document.getElementById('widgetAvatar')];
            avatarElements.forEach(el => {
                if (userProfile.avatarImage) {
                    el.style.backgroundImage = `url(${userProfile.avatarImage})`;
                    el.textContent = '';
                } else {
                    el.style.backgroundImage = '';
                    el.textContent = userProfile.name ? userProfile.name.substring(0, 1) : '我';
                }
            });
            document.getElementById('widgetName').textContent = userProfile.name;
            document.getElementById('widgetSignature').textContent = userProfile.signature;
            document.getElementById('widgetLocation').textContent = userProfile.location;
        }
        
        function updateHomeWidget() {
            document.getElementById('widgetHeaderText').textContent = homeWidgetData.headerText;
            document.getElementById('widgetImage1').src = homeWidgetData.image1;
            document.getElementById('widgetText1').textContent = homeWidgetData.text1;
            document.getElementById('widgetImage2').src = homeWidgetData.image2;
            document.getElementById('widgetText2').textContent = homeWidgetData.text2;
        }

        function editWidgetText(elementId, element) {
            currentEditingTextElement = element;
            const modal = document.getElementById('textEditModal');
            modal.querySelector('#textEditTitle').textContent = '编辑文字';
            const input = modal.querySelector('#newTextInput');
            input.value = element.textContent;
            modal.classList.add('show');
        }

        function closeTextEditModal() {
            document.getElementById('textEditModal').classList.remove('show');
            currentEditingTextElement = null;
        }
        
        async function confirmTextEdit() {
            if (currentEditingTextElement) {
                const newText = document.getElementById('newTextInput').value;
                const elementId = currentEditingTextElement.id;
                
                // NEW: Enforce 10-character limit for small widget texts
                if (['widgetHeaderText', 'widgetText1', 'widgetText2'].includes(elementId)) {
                    if (newText.length > 10) {
                        showAlert('内容不能超过10个字符。');
                        return;
                    }
                }
                
                currentEditingTextElement.textContent = newText;
                const key = elementId.replace('widget', '').toLowerCase();
                homeWidgetData[key] = newText;
                await saveData();
            }
            closeTextEditModal();
        }


        function editWidgetImage(imageId) {
            currentEditingWidgetImageId = imageId;
            document.getElementById('widgetImageInput').click();
        }

        function handleWidgetImageUpload(event) {
            const file = event.target.files[0];
            if (file && currentEditingWidgetImageId) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageUrl = e.target.result;
                    document.getElementById(currentEditingWidgetImageId).src = imageUrl;
                    // Save data
                    const key = currentEditingWidgetImageId.replace('widget', '').toLowerCase(); // e.g., 'image1'
                    homeWidgetData[key] = imageUrl;
                    await saveData();
                    currentEditingWidgetImageId = null;
                };
                reader.readAsDataURL(file);
            }
            // Reset file input to allow re-uploading the same file
            event.target.value = '';
        }

        function applyWallpaper() {

            const homeScreen = document.querySelector('.home-screen');
            if (!homeScreen) return;
            homeScreen.style.backgroundImage = (selectedWallpaper === 'custom' && customWallpaperImage) ? `url(${customWallpaperImage})` : 'none';
            homeScreen.style.backgroundColor = (selectedWallpaper === 'default' && !customWallpaperImage) ? 'var(--theme-bg, #f7f7f7)' : 'transparent';
        }

        function applyWidgetBackground() {}

        function openWallpaperSettings() {
            setActivePage('wallpaperSettingsScreen');
            const selector = selectedWallpaper === 'custom' ? '.custom' : `.${selectedWallpaper}`;
            document.querySelectorAll('#wallpaperGrid .background-option').forEach(opt => opt.classList.remove('selected'));
            const currentBg = document.querySelector(`#wallpaperGrid .background-option${selector}`);
            if (currentBg) currentBg.classList.add('selected');
        }

        function selectWallpaper(bgType) {
            selectedWallpaper = bgType;
            const selector = bgType === 'custom' ? '.custom' : `.${bgType}`;
            document.querySelectorAll('#wallpaperGrid .background-option').forEach(opt => opt.classList.remove ('selected'));
        }

        function handleWallpaperUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    customWallpaperImage = e.target.result;
                    selectedWallpaper = 'custom';
                    document.querySelectorAll('#wallpaperGrid .background-option').forEach(opt => opt.classList.remove('selected'));
                    let customOption = document.querySelector('#wallpaperGrid .background-option.custom');
                    if (!customOption) {
                        const grid = document.getElementById('wallpaperGrid'), uploadOption = grid. children[1];
                        customOption = document.createElement('div');
                        customOption.className = 'background-option custom';
                        customOption.onclick = () => selectWallpaper('custom');
                        grid.insertBefore(customOption, uploadOption.nextSibling);
                    }
                    customOption.style.backgroundImage = `url(${e.target.result})`;
                    customOption.classList.add('selected');
                    customOption.textContent = '';
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveWallpaper() {
            applyWallpaper();
            await saveData();
            showAlert('壁纸已保存');
            backToTheme();
        }

        function changeLocation() { document.getElementById('locationModal').classList.add('show'); document.getElementById('newLocationInput').value = userProfile.location; }
        function closeLocationModal() { document.getElementById('locationModal').classList.remove('show'); document.getElementById('sendLocationModal').classList.remove('show'); }
        async function confirmChangeLocation() { userProfile.location = document.getElementById('newLocationInput').value.trim() || '可点击编辑'; updateProfileDisplay(); await saveData(); closeLocationModal(); }
        function changeSignature() { document.getElementById('signatureModal').classList.add('show'); document.getElementById('newSignatureInput').value = userProfile.signature; }
        function closeSignatureModal() { document.getElementById('signatureModal').classList.remove('show'); }
        async function confirmChangeSignature() { userProfile.signature = document.getElementById('newSignatureInput').value.trim() || '可点击编辑'; updateProfileDisplay(); await saveData(); closeSignatureModal(); }
        function changeName() { document.getElementById('nameModal').classList.add('show'); document.getElementById('newNameInput').value = userProfile.name; }
        function closeNameModal() { document.getElementById('nameModal').classList.remove('show'); }
        async function confirmChangeName() { const newName = document.getElementById('newNameInput').value.trim(); if (newName) { userProfile.name = newName; updateProfileDisplay(); await saveData(); closeNameModal(); } }
        
        function updateTime() { document.getElementById('currentTime').textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }); }
        setInterval(updateTime , 1000);
        
        function updateStatusBar(pageId) {
            const phoneDiv = document.querySelector('.phone');
            phoneDiv.classList.remove('home-screen-active', 'listen-together-active', 'voice-call-active');
            if (pageId === 'homeScreen') {
                phoneDiv.classList.add('home-screen-active');
            } else if (pageId === 'listenTogetherScreen') {
                phoneDiv.classList.add('listen-together-active');
            } else if (pageId === 'voiceCallScreen' || pageId === 'incomingCallScreen') {
                phoneDiv.classList.add('voice-call-active');
            }
        }

        function setActivePage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');
            updateStatusBar(pageId);
        }

        function openApp(appName) {
            const appMap = { 'wechat': 'wechatApp', 'settings': 'settingsApp', 'worldbook': 'worldBookScreen', 'theme': 'themeApp', 'phone': 'phoneApp' };
            setActivePage(appMap[appName]);
            if (appName === 'worldbook') updateWorldBookList();
            if (appName === 'phone') initPhoneApp();
        }

        function goHome() {
            setActivePage('homeScreen');
        }

        function applyFont() {
            const fontFamily = selectedFont === 'custom' ? 'var(--custom-font-family)' : '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
            document.documentElement.style.setProperty('--font-family', fontFamily);
            document.documentElement.style.setProperty('--font-size', selectedFontSize + 'px');
            document.documentElement.style.setProperty('--small-font-size', (selectedFontSize - 2) + 'px');
            document.documentElement.style.setProperty('--nav-font-size', (selectedFontSize + 3) + 'px');
            document.documentElement.style.setProperty('--text-color', selectedFontColor);
        }

        function applyGlobalChatBackground() {
            document.querySelectorAll('.chat-messages').forEach(screen => {
                const bgImage = (selectedGlobalChatBg === 'custom' && customGlobalChatBgImage) ? `url(${customGlobalChatBgImage})` : 'none';
                screen.style.backgroundImage = bgImage;
                screen.style.backgroundColor = (bgImage === 'none') ? 'var(--chat-bg, #ededee)' : 'transparent';
                screen.style.backgroundSize = 'cover';
                screen.style.backgroundPosition = 'center';
            });
        }
        
        function applyIndividualChatBackground(friend) {
            const chatScreen = document.getElementById('chatMessages');
            if (!chatScreen) return;
            // FIX: Prioritize global background if it's custom
            if (selectedGlobalChatBg === 'custom' && customGlobalChatBgImage) {
                applyGlobalChatBackground();
                return;
            }
            if (!friend || !friend.chatBackground || friend.chatBackground.type === 'default') return applyGlobalChatBackground();
            const bgSetting = friend.chatBackground;
            const bgImage = (bgSetting.type === 'custom' && bgSetting.customImage) ? `url(${bgSetting.customImage})` : 'none';
            if(bgImage !== 'none') {
                chatScreen.style.backgroundImage = bgImage;
                chatScreen.style.backgroundColor = 'transparent';
            } else {
                 applyGlobalChatBackground();
            }
        }
        
        function setChatAreaPadding(isOpen) {
            const messagesArea = document.getElementById('chatMessages');
            if (!messagesArea) return;
            const openHeight = 250; // height of function/emoji area
            const inputHeight = 50; // default height of input bar
            
            if (isOpen) {
                messagesArea.style.paddingBottom = (openHeight + inputHeight) + 'px';
            } else {
                messagesArea.style.paddingBottom = (inputHeight) + 'px';
            }
            
            // Scroll to bottom after padding change
            setTimeout(() => {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100); 
        }
        
        function hideFunctionMenus() {
            const area = document.getElementById('chatInputArea');
            if(area.classList.contains('functions-open') || area.classList.contains('emoji-open')) {
                area.classList.remove('functions-open', 'emoji-open');
                setChatAreaPadding(false);
            }
        }

        function toggleChatFunctions() {
            const area = document.getElementById('chatInputArea');
            const isOpening = !area.classList.contains('functions-open');
            area.classList.remove('emoji-open');
            area.classList.toggle('functions-open');
            setChatAreaPadding(isOpening);
            if (!isOpening) document.getElementById('messageInput').blur();
        }

        function toggleEmojiPicker() {
            const area = document.getElementById('chatInputArea');
            const isOpening = !area.classList.contains('emoji-open');
            area.classList.remove('functions-open');
            area.classList.toggle('emoji-open');
            if(isOpening) renderEmojiPicker();
            setChatAreaPadding(isOpening);
            if (!isOpening) document.getElementById('messageInput').blur();
        }
        
        // --- 照片功能 ---
        function selectPhoto() {
            document.getElementById('photoInput').click();
            hideFunctionMenus();
        }
        
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    sendImageMessage(e.target.result, 'image');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function sendImageMessage(dataUrl, type = 'image', description = '', emojiName = '') {
            const friend = friends.find(f => f.id === currentChatFriendId);
            const messageData = saveChatMessage(currentChatFriendId, 'sent', dataUrl, '', null, type);
            if (description) {
                messageData.imageDescription = description;
            }
            if (emojiName) {
                messageData.emojiName = emojiName;
            }
            addMessageToDOM(messageData, friend);
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
            hideFunctionMenus();
        }


        function openCameraModal() {
            hideFunctionMenus();
            document.getElementById('cameraDescInput').value = '';
            document.getElementById('cameraModal').classList.add('show');
        }
        function closeCameraModal() {
            document.getElementById('cameraModal').classList.remove('show');
        }
        function confirmCamera() {
            const description = document.getElementById('cameraDescInput').value.trim();
            if (!description) {
                showAlert('请填写图片描述');
                return;
            }
            const placeholderImageUrl = `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 150 150"><rect width="100%" height="100%" fill="#e0e0e0"/><text x="50%" y="50%" font-family="sans-serif" font-size="14" fill="#808080" text-anchor="middle" dy=".3em">加载中...</text></svg>')}`;
            sendImageMessage(placeholderImageUrl, 'image', description);
            closeCameraModal();
        }
        
        function renderEmojiPicker() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = '';

            // Add button first
            const addItem = document.createElement('div');
            addItem.className = 'function-item';
            addItem.title = "添加表情";
            addItem.onclick = openAddEmojiModal;
            addItem.innerHTML = `
                <div class="function-icon" style="border: 2px dashed var(--border-color, #ccc); background: transparent; display: flex; align-items: center; justify-content: center; font-size: 28px; color: var(--text-secondary, #999);">+</div>
                <div class="function-label" style="opacity: 0;">-</div>
            `;
            grid.appendChild(addItem);

            customEmojis.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'function-item';
                item.title = emoji.name;
                item.setAttribute('data-emoji-name', emoji.name);
                item.onclick = () => { if (!isEmojiManaging) sendEmoji(emoji.url, emoji.name); };
                item.innerHTML = `
                    <div class="function-icon" style="background-image: url('${emoji.url}')"></div>
                    <div class="function-label" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;">${emoji.name}</div>
                    <div class="emoji-delete-btn" onclick="deleteEmoji(event, '${emoji.name}')">&times;</div>
                `;
                grid.appendChild(item);
            });
        }
        
        function sendEmoji(url, name) {
            sendImageMessage(url, 'emoji', '', name);
            hideFunctionMenus();
        }
        
        function toggleEmojiManagement() {
            isEmojiManaging = !isEmojiManaging;
            const grid = document.getElementById('emojiGrid');
            const btn = document.getElementById('manageEmojiBtn');
            grid.classList.toggle('managing', isEmojiManaging);
            btn.textContent = isEmojiManaging ? '完成' : '管理';
            btn.classList.toggle('btn-primary', isEmojiManaging);
        }
        async function deleteEmoji(event, emojiName) {
            event.stopPropagation();
            customEmojis = customEmojis.filter(e => e.name !== emojiName);
            await saveData();
            renderEmojiPicker();
        }

        // --- [FIXED] Emoji Modal v2 Functions ---
        function openAddEmojiModal() {
            const singleTab = document.querySelector('.emoji-modal-tab[onclick*="single"]');
            switchEmojiAddMode(singleTab, 'single');
            document.getElementById('singleEmojiNameInput').value = '';
            document.getElementById('singleEmojiUrlInput').value = '';
            document.getElementById('singleEmojiUrlInput').disabled = false;
            document.getElementById('batchEmojiInput').value = '';
            singleEmojiFile = null;
            document.getElementById('singleEmojiUploadInput').value = '';
            document.getElementById('batchEmojiUploadInput').value = '';
            document.getElementById('addEmojiModal').classList.add('show');
        }

        function closeAddEmojiModal() {
            const modal = document.getElementById('addEmojiModal');
            if (modal.classList.contains('show')) {
                modal.classList.remove('show');
            }
        }

        function switchEmojiAddMode(tabElement, mode) {
            if (currentEmojiAddMode === mode && document.getElementById('addEmojiModal').classList.contains('show')) return;
            currentEmojiAddMode = mode;
            document.querySelectorAll('.emoji-modal-tab').forEach(tab => tab.classList.remove('active'));
            if(tabElement) tabElement.classList.add('active');
            document.querySelectorAll('.emoji-modal-content-view').forEach(view => view.classList.remove('active'));
            const activeViewId = mode === 'single' ? 'emojiSingleAddView' : 'emojiBatchAddView';
            const activeView = document.getElementById(activeViewId);
            if(activeView) activeView.classList.add('active');
        }


        function handleSingleEmojiUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            singleEmojiFile = file;
            if (!document.getElementById('singleEmojiNameInput').value) {
                document.getElementById('singleEmojiNameInput').value = file.name.replace(/\.[^/.]+$/, "");
            }
            document.getElementById('singleEmojiUrlInput').value = `已选择本地文件: ${file.name}`;
            document.getElementById('singleEmojiUrlInput').disabled = true;
        }

        function handleBatchEmojiUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            const existingText = document.getElementById('batchEmojiInput').value;
            let newText = '';
            // Store the files in a way we can access them later
            window.batchEmojiFiles = Array.from(files); 
            for (const file of files) {
                const name = file.name.replace(/\.[^/.]+$/, "");
                newText += `${name}：[本地文件: ${file.name}]\n`; // 使用中文冒号
            }
            document.getElementById('batchEmojiInput').value = (existingText ? existingText + '\n' : '') + newText;
            showAlert(`已准备 ${files.length} 个本地表情，点击"添加"以上传。`);
        }

        async function confirmAddEmoji() {
            if (currentEmojiAddMode === 'single') {
                await addSingleEmoji();
            } else {
                await addBatchEmojisV2();
            }
        }

        async function addSingleEmoji() {
            const name = document.getElementById('singleEmojiNameInput').value.trim();
            const url = document.getElementById('singleEmojiUrlInput').value.trim();
            
            if (!name) return showAlert('请输入表情名称。');
            if (!url && !singleEmojiFile) return showAlert('请输入URL或选择本地文件。');

            let imageUrl = url;
            if (singleEmojiFile) {
                try {
                    imageUrl = await fileToBase64(singleEmojiFile);
                } catch (e) {
                    showAlert('文件读取失败'); return;
                }
            }

            if(customEmojis.some(e => e.name === name)) return showAlert('该表情名称已存在。');
            
            customEmojis.push({ name, url: imageUrl });
            await saveData();
            renderEmojiPicker();
            showAlert('表情添加成功！');
            closeAddEmojiModal();
        }

        async function addBatchEmojisV2() {
            const input = document.getElementById('batchEmojiInput').value.trim();
            const localFiles = window.batchEmojiFiles || [];

            if (!input) return showAlert('请输入表情信息。');

            const lines = input.split('\n');
            let addedCount = 0, errorCount = 0;
            const newEmojis = [];

            const processEntry = async (name, url) => {
                if (name && url) {
                    let finalUrl = url.trim();
                    const localFileMatch = finalUrl.match(/\[本地文件:\s*(.*?)\]/);

                    if (localFileMatch) {
                        const fileName = localFileMatch[1].trim();
                        const file = localFiles.find(f => f.name === fileName);
                        if (file) {
                            finalUrl = await fileToBase64(file);
                        } else {
                            errorCount++;
                            return; // Skip this entry
                        }
                    }

                    if (!customEmojis.some(e => e.name === name) && !newEmojis.some(e => e.name === name)) {
                        newEmojis.push({ name, url: finalUrl });
                        addedCount++;
                    }
                }
            };
            
            let currentName = null;
            let currentUrl = '';

            for (const line of lines) {
                const match = line.match(/^([^:：]+)[:：]\s*(.*)/); // 匹配中英文冒号
                if (match) {
                    // Process the previous entry before starting a new one
                    if (currentName) {
                        await processEntry(currentName, currentUrl);
                    }
                    currentName = match[1].trim();
                    currentUrl = match[2].trim();
                } else if (currentName) {
                    // This is a continuation of the previous URL (for multi-line URLs)
                    currentUrl += line.trim();
                }
            }
            // Process the last entry
            if (currentName) {
                await processEntry(currentName, currentUrl);
            }

            if (newEmojis.length > 0) {
                customEmojis.push(...newEmojis);
                await saveData();
                renderEmojiPicker();
            }
            
            let message = '';
            if(addedCount > 0) message += `成功添加 ${addedCount} 个表情！\n`;
            if(errorCount > 0) message += `有 ${errorCount} 行格式错误、文件未找到或已存在，已跳过。`;

            showAlert(message || '未添加任何新表情。');

            if (addedCount > 0) {
                 window.batchEmojiFiles = []; // Clear cache
                 closeAddEmojiModal();
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        // --- END Emoji Modal v2 Functions ---

        function handleFriendAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    friendAvatarImage = e.target.result;
                    const previewContainer = document.getElementById('friendAvatarUpload');
                    const previewText = document.getElementById('friendAvatarPreview');
                    previewContainer.style.backgroundImage = `url(${e.target.result})`;
                    previewText.textContent = '';
                };
                reader.readAsDataURL(file);
            }
        }

        function handleBackgroundUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    tempSelectedBackground.customImage = e.target.result;
                    tempSelectedBackground.type = 'custom';
                    document.querySelectorAll('#individualBgGrid .background-option').forEach(opt => opt.classList.remove('selected'));
                    let customOption = document.querySelector('#individualBgGrid .background-option.custom');
                    if (!customOption) {
                        const grid = document.getElementById('individualBgGrid'), uploadOption = grid.children[1];
                        customOption = document.createElement('div');
                        customOption.className = 'background-option custom';
                        customOption.onclick = () => selectBackground('custom');
                        grid.insertBefore(customOption, uploadOption.nextSibling);
                    }
                    customOption.style.backgroundImage = `url(${e.target.result})`;
                    customOption.classList.add('selected');
                    customOption.textContent = '';
                };
                reader.readAsDataURL(file);
            }
        }

        function handleGlobalChatBgUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    customGlobalChatBgImage = e.target.result;
                    selectedGlobalChatBg = 'custom';
                    document.querySelectorAll('#globalBgGrid .background-option').forEach(opt => opt.classList.remove('selected'));
                    let customOption = document.querySelector('#globalBgGrid .background-option.custom');
                    if (!customOption) {
                        const grid = document.getElementById('globalBgGrid'), uploadOption = grid.children[1];
                        customOption = document.createElement('div');
                        customOption.className = 'background-option custom selected';
                        customOption.onclick = () => selectGlobalChatBg('custom');
                        grid.insertBefore(customOption, uploadOption.nextSibling);
                    }
                    customOption.style.backgroundImage = `url(${e.target.result})`;
                    customOption.classList.add('selected');
                    customOption.textContent = '';
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleAddMenu() { document.getElementById('addMenu').classList.toggle('show'); }
        function openAddFriend() { document.getElementById('addMenu').classList.remove('show'); document.getElementById('addFriendModal').classList.add('show'); }
        function closeAddFriendModal() {
            document.getElementById('addFriendModal').classList.remove('show');
            document.getElementById('friendNameInput').value = '';
            document.getElementById('friendRemarkInput').value = '';
            document.getElementById('friendRoleInput').value = '';
            friendAvatarImage = '';
            const previewContainer = document.getElementById('friendAvatarUpload');
            const previewText = document.getElementById('friendAvatarPreview');
            previewContainer.style.backgroundImage = '';
            previewText.textContent = '+';
        }

        async function addNewFriend() {
            const name = document.getElementById('friendNameInput').value.trim();
            if (!name) return showAlert('请填写好友昵称');
            const remark = document.getElementById('friendRemarkInput').value.trim();
            const role = document.getElementById('friendRoleInput').value.trim() || '你是一个友好的助手。';
            const newFriend = { id: generateUniqueId(), name, avatar: name.substring(0, 1), avatarImage: friendAvatarImage, remark, role, lastMessage: '我们已经是好友了!', pinned: false, chatBackground: { type: 'default', customImage: '' }, worldBookIds: [], boundFolderIds: [], diaryWritingUrge: 0, balance: Infinity, patAction: `拍了拍 "${name}"`, heartsVoice: { emoji: '( ´• ω •` )', thought: '...', dressing: '...', action: '...', favorability: '...' } };
            friends.push(newFriend);
            await saveData();
            updateFriendList();
            closeAddFriendModal();
            showAlert('好友添加成功！');
        }
        
        function openGroupChatModal() {
            document.getElementById('addMenu').classList.remove('show');
            const list = document.getElementById('groupChatFriendList');
            list.innerHTML = '';
            friends.filter(f => !f.isGroup).forEach(friend => {
                const item = document.createElement('div');
                item.className = 'multi-select-item';
                item.innerHTML = `<input type="checkbox" id="gc-${friend.id}" value="${friend.id}"><label for="gc-${friend.id}">${friend.remark || friend.name}</label>`;
                list.appendChild(item);
            });
            document.getElementById('addGroupChatModal').classList.add('show');
        }

        function closeGroupChatModal() { document.getElementById('addGroupChatModal').classList.remove('show'); }
        
        async function createGroupChat() {
            const selectedMembers = [];
            document.querySelectorAll('#groupChatFriendList input:checked').forEach(checkbox => {
                selectedMembers.push(checkbox.value);
            });

            if (selectedMembers.length < 2) {
                showAlert('请至少选择2位好友。');
                return;
            }
            
            selectedMembers.push(userProfile.id);

            const memberNames = selectedMembers.map(id => {
                if (id === userProfile.id) return userProfile.name;
                const friend = friends.find(f => f.id === id);
                return friend ? (friend.remark || friend.name) : '';
            }).filter(Boolean);

            const groupName = memberNames.slice(0, 3).join('、') + (memberNames.length > 3 ? '...' : '');

            const newGroup = {
                id: generateUniqueId(),
                name: groupName,
                avatar: '群',
                isGroup: true,
                members: selectedMembers,
                lastMessage: '你已加入群聊',
                pinned: false,
                chatBackground: { type: 'default', customImage: '' }
            };
            friends.push(newGroup);
            await saveData();
            updateFriendList();
            closeGroupChatModal();
            showAlert('群聊创建成功！');
        }

        function updateFriendList() {
            const list = document.getElementById('wechatMessages');
            list.innerHTML = '';
            [...friends].sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0)).forEach(friend => {
                const item = document.createElement('div');
                item.className = 'friend-item' + (friend.pinned ? ' pinned' : '');
                item.onclick = () => openChat(friend.id);
                const avatarText = friend.avatar || (friend.name ? friend.name.substring(0, 1) : '?');
                const displayName = friend.remark || friend.name || '未知好友';
                
                let avatarHtml;
                if (friend.isGroup) {
                    avatarHtml = `<div class="friend-avatar">群</div>`;
                } else {
                    avatarHtml = friend.avatarImage ? `<div class="friend-avatar" style="background-image: url(${friend.avatarImage});"></div>` : `<div class="friend-avatar">${avatarText}</div>`;
                }
                
                let lastMessageContent = friend.lastMessage || '';
                if(friend.lastMessageContentType === 'image') lastMessageContent = '[图片]';
                if(friend.lastMessageContentType === 'emoji') lastMessageContent = '[表情]';
                if(friend.lastMessageContentType === 'voice') lastMessageContent = '[语音]';
                if(friend.lastMessageContentType === 'listen_invite') lastMessageContent = '[一起听歌]';
                if(friend.lastMessageContentType === 'transfer_request') lastMessageContent = '[转账]';
                if(friend.lastMessageContentType === 'transfer_accepted') lastMessageContent = '[转账]';
                if(friend.lastMessageContentType === 'pat_pat') lastMessageContent = '[拍一拍]';
                if(friend.lastMessageContentType === 'location') lastMessageContent = '[位置]';
                if(friend.lastMessageContentType === 'voice_call') lastMessageContent = '[语音通话]';

                item.innerHTML = `${avatarHtml}<div class="friend-info"><div class="friend-name">${displayName}</div><div class="friend-message">${lastMessageContent}</div></div>`;
                list.appendChild(item);
            });
        }

        function switchWechatTab(tab) {
            document.querySelectorAll('.wechat-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.wechat-tab[onclick="switchWechatTab('${tab}')"]`)?.classList.add('active');
            document.getElementById('wechatMessages').style.display = 'none';
            document.getElementById('wechatDiscover').style.display = 'none';
            document.getElementById('wechatProfile').style.display = 'none';
            
            const navBar = document.querySelector('#wechatApp .nav-bar');
            const navTitle = navBar.querySelector('.nav-title');
            const rightButtons = navBar.querySelector('*:last-child');
            
            let title = '消息';
            if (tab === 'discover') { 
                title = '发现'; 
                document.getElementById('wechatDiscover').style.display = 'block'; 
                rightButtons.innerHTML = ''; // Hide right button
            } 
            else if (tab === 'profile') { 
                title = '我'; 
                document.getElementById('wechatProfile').style.display = 'block'; 
                updateWalletDisplay(); 
                rightButtons.innerHTML = ''; // Hide right button
            } 
            else { 
                document.getElementById('wechatMessages').style.display = 'block'; 
                rightButtons.innerHTML = `<button class="nav-btn" onclick="toggleAddMenu()">+</button>`; // Show right button
            }
            navTitle.textContent = title;
        }


        function openChat(friendId) {
            const friend = friends.find(f => f.id === friendId);
            if (!friend) return;
            currentChatFriendId = friend.id;
            setActivePage('chatScreen');
            const chatTitle = friend.isGroup ? `${friend.name} (${friend.members.length})` : (friend.remark || friend.name);
            document.getElementById('chatTitle').textContent = chatTitle;
            document.getElementById('heartsVoiceBtn').style.display = friend.isGroup ? 'none' : 'flex';
            renderInitialMessages(); // 替换原来的loadChatHistory
document.getElementById('chatMessages').onscroll = handleChatScroll; // 新增滚动监听
        }
        
        function getAvatarHtml(sender) {
            if (!sender) return `<div class="chat-avatar">?</div>`;
            const name = sender.name || '', avatarImage = sender.avatarImage || '';
            const avatarText = sender.avatar || (name ? name.substring(0, 1) : '?');
            return avatarImage ? `<div class="chat-avatar" data-sender-id="${sender.id}" style="background-image: url('${avatarImage}');"></div>` : `<div class="chat-avatar" data-sender-id="${sender.id}">${avatarText}</div>`;
        }

        function handlePatPat(targetId) {
             const friend = friends.find(f => f.id === currentChatFriendId);
             if(!friend) return;

             const target = targetId === userProfile.id ? userProfile : friends.find(f => f.id === targetId);
             if(!target) return;

             const patter = userProfile;
             const patAction = patter.patAction || '拍了拍';
             const content = `你${patAction}"${target.name}"`;
             
             const patMessage = saveChatMessage(currentChatFriendId, 'system', content, '', null, 'pat_pat');
             addPatPatMessageToDOM(patMessage);
        }

        function addPatPatMessageToDOM(msg) {
            const container = document.getElementById('chatMessages');
            const patDiv = document.createElement('div');
            patDiv.className = 'pat-pat-message';
            patDiv.innerHTML = `<div class="pat-pat-content">${msg.content}</div>`;
            container.appendChild(patDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function toggleVoiceText(messageId) {
            const textEl = document.getElementById(`voice-text-${messageId}`);
            if (textEl) {
                textEl.style.display = textEl.style.display === 'block' ? 'none' : 'block';
            }
        }

        function addMessageToDOM(msg, friendOrGroup, containerId = 'chatMessages') {
            if (!msg || !msg.id) {
                console.error("addMessageToDOM called with invalid msgData:", msg);
                return; 
            }

            const container = document.getElementById(containerId);
            if (!container) return;

            if (msg.contentType === 'pat_pat') {
                return addPatPatMessageToDOM(msg);
            }

            if (msg.recalled) {
                const recallDiv = document.createElement('div');
                recallDiv.className = 'recall-message';
                 recallDiv.innerHTML = `<div class="recall-content">${msg.type === 'sent' ? '你' : '对方'}撤回了一条消息</div>`;
                if (msg.type !== 'sent') recallDiv.querySelector('.recall-content').setAttribute('onclick', `showRecalledMessage('${msg.id}')`);
                container.appendChild(recallDiv);
                return;
            }

            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${msg.type}`;
            msgDiv.setAttribute('data-message-id', msg.id);
            
            let sender = null;
            if (msg.type === 'sent') {
                sender = userProfile;
            } else if (friendOrGroup.isGroup) {
                sender = friends.find(f => f.id === msg.senderId);
            } else {
                sender = friendOrGroup;
            }

            if (!sender) sender = { name: '未知', avatar: '?' };

            let contentHTML;
            const hasImage = msg.contentType === 'image';
            const hasEmoji = msg.contentType === 'emoji';
            const hasVoice = msg.contentType === 'voice';
            const hasLocation = msg.contentType === 'location';
            const hasVoiceCallEnd = msg.contentType === 'voice_call';

            if (hasVoice) {
                const textLength = msg.content.length;
                const duration = Math.max(1, Math.min(60, Math.round(textLength / 4)));
                const barWidth = Math.max(80, Math.min(220, 80 + textLength * 2.5));
                const voiceIconSVG = `<svg viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z" opacity="0.8"/></svg>`;
                const sentContent = `<span class="voice-duration">${duration}"</span><div class="voice-play-icon">${voiceIconSVG}</div>`;
                const receivedContent = `<div class="voice-play-icon">${voiceIconSVG}</div><span class="voice-duration">${duration}"</span>`;
                contentHTML = `
                    <div class="message-body">
                        ${(friendOrGroup.isGroup && msg.type === 'received') ? `<div class="message-sender-name">${sender.name}</div>` : ''}
                        <div class="voice-message-bar" style="width: ${barWidth}px;" onclick="toggleVoiceText('${msg.id}')">
                           ${msg.type === 'sent' ? sentContent : receivedContent}
                        </div>
                        <div class="voice-text-content" id="voice-text-${msg.id}">${msg.content.replace(/\n/g, '<br>')}</div>
                    </div>`;
            } else if (msg.contentType === 'listen_invite') {
                 const cardTitle = msg.type === 'sent' ? '你发起了听歌邀请' : `${sender.name}邀请你一起听歌`;
                 contentHTML = `
                    <div class="invite-card">
                        <div class="invite-card-title">${cardTitle}</div>
                        <div class="invite-card-body">
                           <div class="invite-card-icon-container">
                                <svg viewBox="0 0 24 24"><path d="M12,3V13.55A4,4 0 0,0 10,13A4,4 0 0,0 6,17A4,4 0 0,0 10,21A4,4 0 0,0 14,17V7H18V3H12Z" /></svg>
                           </div>
                           <span>一起听歌</span>
                        </div>
                        <div class="invite-card-footer">点击加入</div>
                    </div>`;
            } else if (msg.contentType === 'listen_accept') {
                 const cardTitle = `"${sender.name}"已加入`;
                 contentHTML = `
                    <div class="accept-card">
                         <div class="accept-card-body">${cardTitle}，一起享受音乐吧</div>
                         <div class="accept-card-footer">一起听歌</div>
                    </div>`;
            } else if (msg.contentType === 'transfer_request') {
                const transferData = JSON.parse(msg.content);
                const isReceived = msg.transfer_status === 'received';
                const clickHandler = (msg.type === 'received' && !isReceived) ? `onclick="acceptTransfer('${msg.id}')"` : '';
                const disabledClass = isReceived ? 'disabled' : '';
                const remarkText = transferData.remark || (msg.type === 'sent' ? '转账给' + friendOrGroup.name : '微信转账');
                let footerText = '';
                if(isReceived) {
                    footerText = '已被接收';
                } else {
                    footerText = msg.type === 'sent' ? '待对方接收' : '待接收';
                }
                const amount = parseFloat(transferData.amount).toFixed(2);
                contentHTML = `
                    <div class="transfer-card ${disabledClass}" ${clickHandler}>
                        <div class="transfer-card-body">
                            <div class="transfer-card-icon-container">
                                <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm-1 14H5c-.55 0-1-.45-1-1V7c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v10c0 .55-.45 1-1 1zm-8-2h2v-4h4v-2h-4V8h-2v4H7v2h4v4z"/></svg>
                            </div>
                            <div class="transfer-card-info">
                                <div class="transfer-card-amount">¥ ${amount}</div>
                                <div class="transfer-card-remark">${remarkText}</div>
                            </div>
                        </div>
                        <div class="transfer-card-footer">${footerText}</div>
                    </div>`;
            } else if (msg.contentType === 'transfer_accepted') {
                 const transferData = JSON.parse(msg.content);
                 const amount = parseFloat(transferData.amount).toFixed(2);
                 const statusText = msg.type === 'sent' ? '已收款' : `已收款`;
                 const remarkText = `微信转账`;
                 contentHTML = `
                    <div class="transfer-confirm-card">
                        <div class="transfer-card-body">
                            <div class="transfer-card-icon-container">
                                <svg viewBox="0 0 24 24"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M10,17l-5-5l1.41-1.41L10,14.17l7.59-7.59L19,8l-9,9z"/></svg>
                            </div>
                            <div class="transfer-confirm-info">
                                <div class="transfer-card-amount">¥ ${amount}</div>
                                <div class="transfer-card-status">${statusText}</div>
                            </div>
                        </div>
                        <div class="transfer-card-footer">${remarkText}</div>
                    </div>`;
            } else if (hasLocation) {
                 const locationData = JSON.parse(msg.content);
                 contentHTML = `
                    <div class="location-card">
                        <div class="location-card-info">
                            <div class="location-card-title">${locationData.name}</div>
                            <div class="location-card-address">${locationData.address}</div>
                        </div>
                        <div class="location-card-map">
                            <svg class="location-card-pin" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                                        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.3"/>
                                    </filter>
                                </defs>
                                <circle cx="15" cy="15" r="10" fill="#4CAF50" filter="url(#shadow)"/>
                                <circle cx="15" cy="15" r="4" fill="white"/>
                            </svg>
                        </div>
                        <div class="location-card-footer">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAfRJREFUWEfFlk1oVEEUhp9v7r6Y1QyCFDAiCCIiGpeiC5cuBUEUcaELVwYVQRChIoVbcKEuBBclwYWgG2/cCP6AIIqIoGjcCP5AEG9EEUWgsdk9zM6e9+bNW29iIPDJzHtz73/v/ec+5xBIQMAvQGQAe0GugAxgBsB3gA0gDkga0T6cBDoA6kF8ALgC2gCqgAsBq9Uj1f4A9AFeAVUDAfA86ALGAF1ARsA2YA8oAYoAacAeYAlQA/QBFwJ2B1lA2iFkAm6AR5bQWgJmAZ/d+QBM6gM+A/YCHQA+gZ/Iu6cDBvAlUANk+w/A2xL42n4A/gV4L9r4vU+wM4ApoAawCdgG1AL2gC6A/SAK6CPL4/eYcQ7gM2A+gC2gDygCjgZtI18d0AfEABgGDAE6Ab3Am5I4a/KkXUjGjAOmALUALUAL0AfsAj6AnC9bA+oAh4DPAQvA/lAdEGBvQUoBfYAVgB7gAtB20gK0B6jR50/lD3/eP/w11X/k3y+QNwLdAb+BRoD9ID6AG8C+gCagDbgCEgfEAIgAfgNqAb0AecAp8P/Fw/oAZQDbQAswCzgHlIH6AJ2ABmAXsAbkAfaALoB9gC/ARqAPODGQK3mX/yC+A3wGvG0u3p2p/wBfAz4FvI7p8QAAAABJRU5ErkJggg==" alt="Tencent Map">
                            <span>腾讯地图</span>
                        </div>
                    </div>
                `;
            } else if (hasImage || hasEmoji) {
                const clickHandler = msg.imageDescription ? `onclick="showImageDescription('${msg.imageDescription.replace(/'/g, "\\'").replace(/"/g, '&#34;').replace(/\n/g, '\\n')}')"` : `onclick="viewImage('${msg.content}')"`;
                contentHTML = `<img src="${msg.content}" ${clickHandler}>`;
            } else if(hasVoiceCallEnd) {
                 contentHTML = `<span>通话时长 ${msg.content}</span><svg class="call-icon" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.2c.27-.27.35-.66.24-1.01-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.75 0 .99-.65.99-.99v-3.45c0-.54-.45-.98-.99-.98z"/></svg>`;
            } else {
                contentHTML = (msg.content || '').replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
                if (msg.quoted) {
                    let quotedContent = (msg.quoted || '').replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
                    contentHTML = `<div class="quoted-message">${quotedContent}</div>${contentHTML}`;
                }
            }

            const contentClass = `message-content ${hasImage ? 'has-image' : ''} ${hasEmoji ? 'has-emoji' : ''} ${hasVoice ? 'has-voice' : ''} ${(msg.contentType.startsWith('listen_') || msg.contentType.startsWith('transfer_') || hasLocation) ? 'has-image' : ''} ${hasVoiceCallEnd ? 'has-voice-call-end' : ''}`;
            const senderNameHtml = (friendOrGroup.isGroup && msg.type === 'received') ? `<div class="message-sender-name">${sender.name}</div>` : '';
            
            if (containerId === 'listenTogetherChatOverlay') {
                 const existingMsg = container.querySelector('.message');
                 if(existingMsg) {
                    existingMsg.classList.remove('show');
                    setTimeout(() => existingMsg.remove(), 500);
                 }
                 msgDiv.innerHTML = contentHTML;
                 container.appendChild(msgDiv); 
                 setTimeout(() => {
                     msgDiv.classList.add('show');
                     setTimeout(() => {
                        msgDiv.classList.remove('show');
                        setTimeout(() => msgDiv.remove(), 4000);
                     }, 4000);
                 }, 50);
            } else if (hasVoice) {
                msgDiv.innerHTML = (msg.type === 'sent') ? `${contentHTML}${getAvatarHtml(sender)}` : `${getAvatarHtml(sender)}${contentHTML}`;
                container.appendChild(msgDiv);
            } else {
                 const messageBodyHtml = `<div class="message-body">${senderNameHtml}<div class="${contentClass}">${contentHTML}</div></div>`;
                msgDiv.innerHTML = (msg.type === 'sent') ? `${messageBodyHtml}${getAvatarHtml(sender)}` : `${getAvatarHtml(sender)}${messageBodyHtml}`;
                container.appendChild(msgDiv);
            }

            const contentEl = msgDiv.querySelector('.message-content, .voice-message-bar');
            if(contentEl && containerId !== 'listenTogetherChatOverlay') {
                contentEl.addEventListener('contextmenu', (e) => showMessageMenu(e, contentEl));
                contentEl.addEventListener('touchstart', (e) => handleTouchStart(e, contentEl));
                contentEl.addEventListener('touchmove', handleTouchMove);
                contentEl.addEventListener('touchend', handleTouchEnd);
            }
             
            // NEW: Add long-press for pat-pat on avatar
            const avatarEl = msgDiv.querySelector('.chat-avatar');
            if (avatarEl && sender.id !== userProfile.id) {
                 let patTimer;
                 avatarEl.addEventListener('touchstart', (e) => {
                     e.preventDefault();
                     patTimer = setTimeout(() => {
                         handlePatPat(sender.id);
                         patTimer = null;
                     }, 500); // 500ms for long press
                 });
                 avatarEl.addEventListener('touchend', () => {
                     clearTimeout(patTimer);
                 });
                 avatarEl.addEventListener('touchmove', () => {
                     clearTimeout(patTimer);
                 });
            }

            return msgDiv;
        }

        let lastMessageTimestamp = null;
        // 新功能：仅渲染初始的最近消息
function renderInitialMessages() {
    const container = document.getElementById('chatMessages');
    container.innerHTML = ''; // 清空容器
    lastMessageTimestamp = null;
    const friend = friends.find(f => f.id === currentChatFriendId);
    if (!friend) return;
    
    applyIndividualChatBackground(friend); // 应用聊天背景
    
    const history = chatHistories[currentChatFriendId] || [];
    if (history.length === 0) {
        currentlyDisplayedMessageCount = 0;
        return;
    }

    const initialMessages = history.slice(-CHAT_PAGE_SIZE);
    currentlyDisplayedMessageCount = initialMessages.length;

    // 如果还有更多历史消息，就在顶部显示一个提示
    if (history.length > currentlyDisplayedMessageCount) {
         const loadMoreDiv = document.createElement('div');
         loadMoreDiv.id = 'loadMoreIndicator';
         loadMoreDiv.style.textAlign = 'center';
         loadMoreDiv.style.padding = '10px';
         loadMoreDiv.style.color = '#999';
         loadMoreDiv.style.fontSize = '12px';
         loadMoreDiv.textContent = '--- 上滑加载更多记录 ---';
         container.appendChild(loadMoreDiv);
    }

    const fragment = document.createDocumentFragment();
    initialMessages.forEach(msg => {
        // 这部分逻辑和旧函数一样，用于处理时间戳和消息内容
        const msgTimestamp = new Date(msg.timestamp);
        if (lastMessageTimestamp && (msgTimestamp - lastMessageTimestamp) > 15 * 60 * 1000) {
            const timeDiv = document.createElement('div');
            timeDiv.className = 'chat-timestamp';
            timeDiv.textContent = msgTimestamp.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            fragment.appendChild(timeDiv);
        }
        lastMessageTimestamp = msgTimestamp;
        addMessageToDOM(msg, friend);
        const msgElement = container.lastElementChild;
        if(msgElement) fragment.appendChild(msgElement);
    });
    
    container.appendChild(fragment);
    // 滚动到底部
    container.scrollTop = container.scrollHeight;
}

// 新功能：向上滑动时加载之前的消息
async function loadPreviousMessages() {
    if (isLazyLoading) return;
    isLazyLoading = true;

    const container = document.getElementById('chatMessages');
    const friend = friends.find(f => f.id === currentChatFriendId);
    let indicator = document.getElementById('loadMoreIndicator');
    if (indicator) indicator.textContent = '--- 正在加载... ---';

    // 模拟网络延迟，让加载感觉更自然
    await new Promise(res => setTimeout(res, 300));

    const history = chatHistories[currentChatFriendId] || [];
    const remainingMessagesCount = history.length - currentlyDisplayedMessageCount;

    if (remainingMessagesCount <= 0) {
        if (indicator) indicator.textContent = '--- 没有更多记录了 ---';
        setTimeout(() => { if (indicator) indicator.remove(); }, 2000);
        isLazyLoading = false;
        return;
    }

    const nextBatchSize = Math.min(remainingMessagesCount, CHAT_PAGE_SIZE);
    const nextMessages = history.slice(remainingMessagesCount - nextBatchSize, remainingMessagesCount);

    const oldScrollHeight = container.scrollHeight;
    const fragment = document.createDocumentFragment();
    
    // 注意：这里我们是向上添加消息，所以要倒序遍历
    nextMessages.slice().reverse().forEach((msg, index) => {
        addMessageToDOM(msg, friend);
        const msgElement = container.lastElementChild;
        if(msgElement) fragment.appendChild(msgElement);

        // 检查新旧消息批次之间是否需要加时间戳
        if (index === 0) { // 这是新批次的最早一条消息
            const firstOldMessage = history[remainingMessagesCount];
            if(firstOldMessage) {
                const tsNew = new Date(firstOldMessage.timestamp);
                const tsOld = new Date(msg.timestamp);
                if ((tsNew - tsOld) > 15 * 60 * 1000) {
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'chat-timestamp';
                    timeDiv.textContent = tsNew.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    fragment.appendChild(timeDiv);
                }
            }
        }
    });

    container.insertBefore(fragment, container.firstChild.nextSibling); // 插入到提示语下方
    container.scrollTop = container.scrollHeight - oldScrollHeight; // 保持滚动位置

    currentlyDisplayedMessageCount += nextBatchSize;
    if (indicator) indicator.textContent = '--- 上滑加载更多记录 ---';
    isLazyLoading = false;
}

// 新增：处理滚动事件的函数
function handleChatScroll(event) {
    // 当滚动到最顶部时，触发加载
    if (event.target.scrollTop === 0) {
        loadPreviousMessages();
    }
}

        function saveChatMessage(friendId, type, content, quoted = '', senderId = null, contentType = 'text') {
            if (!friendId) {
                console.error("saveChatMessage called without friendId");
                return null;
            }
            if (!chatHistories[friendId]) chatHistories[friendId] = [];
            const friend = friends.find(f => f.id === friendId);

            const message = { 
                id: generateUniqueId(), 
                type, 
                content,
                contentType,
                quoted, 
                timestamp: new Date().toISOString(), 
                recalled: false,
                senderId: type === 'sent' ? userProfile.id : (senderId || friend.id)
            };
            
            if (contentType === 'transfer_request') {
                message.transfer_status = 'pending';
            }

            chatHistories[friendId].push(message);
            
            if (friend && contentType !== 'pat_pat') {
                let lastMsgPrefix = '';
                if(friend.isGroup && type === 'received'){
                    const sender = friends.find(f => f.id === senderId);
                    lastMsgPrefix = sender ? `${sender.name}: ` : '';
                }
                
                let lastMessageText;
                switch(contentType) {
                    case 'image': lastMessageText = '[图片]'; break;
                    case 'emoji': lastMessageText = '[表情]'; break;
                    case 'voice': lastMessageText = '[语音]'; break;
                    case 'location': lastMessageText = '[位置]'; break;
                    case 'listen_invite': lastMessageText = '[邀请你一起听歌]'; break;
                    case 'listen_accept': lastMessageText = '[已加入一起听]'; break;
                    case 'transfer_request': lastMessageText = '[转账]'; break;
                    case 'transfer_accepted': lastMessageText = '[转账]'; break;
                    case 'voice_call': lastMessageText = '[语音通话]'; break;
                    default: lastMessageText = content;
                }

                friend.lastMessage = lastMsgPrefix + (lastMessageText.length > 20 ? lastMessageText.substring(0, 20) + '...' : lastMessageText);
                friend.lastMessageContentType = contentType;

                if (type === 'received') {
                     showNotification(friend, friend.lastMessage);
                }
            }

            saveData(); 
            updateFriendList();
            return message;
        }

        function backToWechat() {document.getElementById('chatMessages').onscroll = null; // 新增：移除滚动监听
            setActivePage('wechatApp');
            hideFunctionMenus();
            if (multiSelectMode) exitMultiSelectMode();
            currentChatFriendId = null; 
            updateFriendList();
            switchWechatTab('messages');
        }

        function handleTouchStart(e, el) {
            clearTimeout(longPressTimer);
            longPressTimer = setTimeout(() => {
                longPressTimer = null;
                showMessageMenu(e, el);
            }, 500);
        }

        function handleTouchMove() { clearTimeout(longPressTimer); }
        function handleTouchEnd() { clearTimeout(longPressTimer); }

        function showMessageMenu(event, el) {
            event.preventDefault();
            event.stopPropagation();
            currentMessageElement = el;
            const menu = document.getElementById('messageMenu');
            const messageDiv = el.closest('.message');
            const msgId = messageDiv.getAttribute('data-message-id');
            const msg = (chatHistories[currentChatFriendId] || []).find(m => String(m.id) === msgId);
            const isSent = messageDiv.classList.contains('sent');
            
            let menuItems = '';
            if (msg && (msg.contentType === 'text' || msg.contentType === 'voice')) {
                 menuItems += `<div class="message-menu-item" onclick="quoteMessage()">引用</div>`;
            }
            menuItems += `<div class="message-menu-item" onclick="favoriteMessage()">收藏</div><div class="message-menu-item" onclick="startMultiSelect()">多选</div>`;
            if (isSent) {
                menuItems += `<div class="message-menu-item" onclick="recallMessage()">撤回</div>`;
            }
            menuItems += `<div class="message-menu-item danger" onclick="deleteMessage()">删除</div>`;

            menu.innerHTML = menuItems;
            menu.classList.add('show');
            const rect = el.getBoundingClientRect();
            let x = rect.left + window.scrollX, y = rect.bottom + window.scrollY + 5;
            menu.style.left = `${x}px`; menu.style.top = `${y}px`;
            if (x + menu.offsetWidth > window.innerWidth) menu.style.left = `${window.innerWidth - menu.offsetWidth - 10}px`;
            if (y + menu.offsetHeight > window.innerHeight) menu.style.top = `${rect.top + window.scrollY - menu.offsetHeight - 5}px`;
            setTimeout(() => document.addEventListener('click', hideMessageMenu, { once: true }), 0);
        }

        function hideMessageMenu() { document.getElementById('messageMenu')?.classList.remove('show'); }

        function recallMessage() {
    showConfirm('确定要撤回这条消息吗？', async (confirmed) => {
        if (!confirmed) return;

        // 步骤1：获取消息ID和它在界面上的HTML元素
        const messageDiv = currentMessageElement.closest('.message');
        const msgId = messageDiv.getAttribute('data-message-id');
        const msg = (chatHistories[currentChatFriendId] || []).find(m => String(m.id) === msgId);

        if (msg) {
            // 步骤2：在后台更新数据，把消息标记为"已撤回"
            msg.recalled = true;
            msg.recalledContent = msg.content;
            await saveData();

            // 步骤3：创建一个新的"已撤回"提示的HTML元素
            const recallDiv = document.createElement('div');
            recallDiv.className = 'recall-message';
            recallDiv.innerHTML = `<div class="recall-content">你撤回了一条消息</div>`;

            // 步骤4：在界面上，用新的"已撤回"提示替换掉原来的消息内容，实现立即刷新
            if (messageDiv && messageDiv.parentNode) {
                messageDiv.parentNode.replaceChild(recallDiv, messageDiv);
            }
        }
        // 注意：我们不再调用 loadChatHistory()
    });
}

        function quoteMessage() {
            const msgId = currentMessageElement.closest('.message').getAttribute('data-message-id');
            const msg = (chatHistories[currentChatFriendId] || []).find(m => String(m.id) === msgId);
            if(!msg) return;

            let content;
            if (msg.contentType === 'voice') {
                content = '[语音]';
            } else {
                content = msg.content;
            }

            quotedMessage = content.length > 50 ? content.substring(0, 50) + '...' : content;
            const input = document.getElementById('messageInput');
            input.placeholder = `回复: ${quotedMessage}`;
            input.focus();
        }

        async function favoriteMessage() {
            const msgId = currentMessageElement.closest('.message').getAttribute('data-message-id');
            const msg = (chatHistories[currentChatFriendId] || []).find(m => String(m.id) === msgId);
            if(!msg) return;
            
            const friend = friends.find(f => f.id === currentChatFriendId);
            favorites.push({ id: generateUniqueId(), content: msg.content, contentType: msg.contentType, from: friend ? (friend.remark || friend.name) : '未知', timestamp: new Date().toISOString() });
            await saveData();
            showAlert('已收藏');
        }

        function deleteMessage() {
    showConfirm('确定要删除这条消息吗？', async (confirmed) => {
        if (!confirmed) return;

        // 步骤1：获取消息ID和它在界面上的HTML元素
        const messageDiv = currentMessageElement.closest('.message');
        const msgId = messageDiv.getAttribute('data-message-id');

        // 步骤2：直接从界面上移除这个HTML元素，实现立即刷新
        if (messageDiv) {
            messageDiv.remove();
        }

        // 步骤3：在后台更新数据存档
        chatHistories[currentChatFriendId] = (chatHistories[currentChatFriendId] || []).filter(m => String(m.id) !== msgId);
        
        // 步骤4：保存更新后的数据
        await saveData();
        
        // 注意：我们不再调用 loadChatHistory()
    });
}
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();
            if (!messageText) return;
            const friend = friends.find(f => f.id === currentChatFriendId);
            
            const msgData = saveChatMessage(currentChatFriendId, 'sent', messageText, quotedMessage);
            addMessageToDOM(msgData, friend);
            
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            input.value = '';
            input.placeholder = '输入消息...';
            toggleSendButtonActive(input);
            quotedMessage = '';
            hideFunctionMenus();
        }
        
        function requestAIResponse() {
            if (isAIReplying) return showAlert('AI正在回复中，请稍候...');
            const inListenScreen = document.getElementById('listenTogetherScreen').classList.contains('active');
            receiveMessage(currentChatFriendId, null, inListenScreen);
        }
        
        async function receiveMessage(friendId, customPrompt = null, isFromListenScreen = false) {
            const friend = friends.find(f => f.id === friendId);
            if (!friend) return;
            
            isAIReplying = true;
            document.getElementById('chatTitle').textContent = '对方正在输入...';
            const settings = await dbManager.get('apiSettings') || {};
        
            if (!settings.apiUrl || !settings.apiKey || !settings.modelName) {
                const defaultReply = `[提示：请在主屏幕"设置"应用中配置API信息]`;
                const msgData = saveChatMessage(friendId, 'received', defaultReply);
                addMessageToDOM(msgData, friend);
                isAIReplying = false;
                document.getElementById('chatTitle').textContent = friend.remark || friend.name;
                return;
            }
        
            let apiPayloadMessages = [];
        
            try {
                const boundFolderIds = friend.boundFolderIds || [];
                const allBoundBookIds = new Set(friend.worldBookIds || []);
                boundFolderIds.forEach(folderId => {
                    worldBooks.forEach(wb => {
                        if(wb.folderId === folderId) {
                            allBoundBookIds.add(wb.id);
                        }
                    });
                });
                
                let worldBookContext = Array.from(allBoundBookIds).map(id => worldBooks.find(wb => wb.id === id)).filter(Boolean).map(wb => `[${wb.name}]: ${wb.content}`).join('\n\n');
                if (worldBookContext) worldBookContext = `你必须严格遵守以下世界书设定：\n${worldBookContext}\n`;
        
                let systemPrompt;
                let responseFormat = { type: "json_object" };
                const memoryTurns = parseInt(settings.memoryTurns, 10) || 10;
                const apiTemperature = parseFloat(settings.apiTemperature) || 0.9;
                const history = (chatHistories[friendId] || []).slice(-memoryTurns);

                 history.forEach(msg => {
                    if (['listen_invite', 'listen_accept', 'pat_pat', 'voice_call'].includes(msg.contentType)) return;
                    const role = msg.type === 'sent' ? 'user' : 'assistant';
                    let content;
                    if(msg.quoted) content = `(回复引用: "${msg.quoted}") ${msg.content}`;
                    else if (msg.contentType === 'image') {
                        if (msg.imageDescription) {
                            content = `(用户通过[拍摄]功能发送了一张图片，图片的文字描述是: "${msg.imageDescription}")`;
                        } else {
                            content = [ { type: "text", text: "(用户发送了一张图片，请识别内容并回复)" }, { type: "image_url", image_url: { url: msg.content } } ];
                        }
                    } else if (msg.contentType === 'emoji') {
                         content = `(用户发送了名为'${msg.emojiName || '未知'}'的表情，请结合表情包的**图像内容**和**名称**来综合理解其意图和情绪，并作出回应)`;
                         if (msg.content.startsWith('data:')) { // Only include image data for emojis, not links
                            content = [{ type: "text", text: content}, { type: "image_url", image_url: { url: msg.content } }];
                         }
                    } else if (msg.contentType === 'voice') {
                         content = `(用户发送了语音: "${msg.content}")`;
                    } else if (msg.contentType === 'transfer_request') {
                        const transfer = JSON.parse(msg.content);
                        content = `(用户向你转账 ¥${parseFloat(transfer.amount).toFixed(2)}，备注: ${transfer.remark || '无'})`;
                    } else if (msg.contentType === 'transfer_accepted') {
                        const transfer = JSON.parse(msg.content);
                        content = `(你接收了用户的转账 ¥${parseFloat(transfer.amount).toFixed(2)})`;
                    } else if (msg.contentType === 'location') {
                        const loc = JSON.parse(msg.content);
                        content = `(用户分享了一个位置: "${loc.name}", 地址: ${loc.address})`;
                    } else {
                        content = msg.content;
                    }
                    apiPayloadMessages.push({ role, content });
                });

                if (friend.isGroup) {
                   // Group chat logic - TO BE IMPLEMENTED
                } else {
                     if(customPrompt) {
                         systemPrompt = customPrompt;
                     } else {
                         let listenContext = '';
                         if(isListenSessionActive && listenTogetherFriendId === friend.id && currentSongIndex !== -1) {
                             const song = playlist[currentSongIndex];
                             const currentLyricLine = parsedLyrics.find(l => l.time <= audioElement.currentTime && (!parsedLyrics[parsedLyrics.indexOf(l)+1] || parsedLyrics[parsedLyrics.indexOf(l)+1].time > audioElement.currentTime));
                             listenContext = `我们正在一起听歌，当前歌曲是《${song.title}》 - ${song.artist}。当前歌词是："${currentLyricLine ? currentLyricLine.text : '无'}"。请围绕这个氛围进行回复。`;
                         }
                         
                         let momentsContext = '';
                         const recentUserMoments = moments.filter(m => m.authorId === userProfile.id).slice(0, 3);
                         const recentFriendMoments = moments.filter(m => m.authorId === friend.id).slice(0, 3);
                         if(recentUserMoments.length > 0 || recentFriendMoments.length > 0) {
                            momentsContext += "最近的朋友圈互动参考:\n"
                            recentUserMoments.forEach(m => {
                               if(m.likes.includes(friend.id)) momentsContext += `- 你赞了用户的朋友圈: "${m.content.substring(0, 20)}..."\n`;
                               const friendComment = m.comments.find(c => c.authorId === friend.id);
                               if(friendComment) momentsContext += `- 你评论了用户的朋友圈: "${friendComment.content}"\n`;
                            });
                            recentFriendMoments.forEach(m => {
                               if(m.likes.includes(userProfile.id)) momentsContext += `- 用户赞了你的朋友圈: "${m.content.substring(0, 20)}..."\n`;
                               const userComment = m.comments.find(c => c.authorId === userProfile.id);
                               if(userComment) momentsContext += `- 用户评论了你的朋友圈: "${userComment. content}"\n`;
                            });
                         }
                         
                         let timeContext = '';
                         if(aiTimePerceptionEnabled){
                             const beijingTime = new Date().toLocaleString("zh-CN", { timeZone: "Asia/Shanghai", hour12: false });
                             timeContext = `注意：当前北京时间是 ${beijingTime}，请结合此时间情景进行回复。`
                         }

                         systemPrompt = `你叫"${friend.name}"，正在与用户"${userProfile.name}"聊天。
${worldBookContext}
你的角色设定是：${friend.role}
用户的设定是：${userProfile.personality || '普通人'}
${listenContext}
${momentsContext}
${timeContext}

你的任务和规则:
1.  **【核心规则】消息格式**: 你的所有回复**必须**以一个JSON对象的格式返回。
2.  **【核心规则】必备字段**: JSON对象必须包含 'replies' 和 'hearts_voice' 两个键。
3.  **【核心规则】多消息回复**: 'replies' 的值必须是一个包含**至少1条，通常是4-6条(甚至更多)**简短、口语化消息的对象数组。模拟真人连续发短消息的习惯，数量需根据情景动态变化。
4.  **【核心规则】心声功能 ('hearts_voice')**: 它的值必须是一个JSON对象，包含以下五个键，顺序必须如下:
    -   'favorability': 必须是一个字符串，格式为"数值/100 (描述词)"，例如 "85/100 (非常信任)"。根据你的人设和对话情景动态调整数值和描述。
    -   'dressing': 必须是一段**只描述衣物穿着**的字符串。除非对话内容有明显暗示（如早晨、出门、换衣服），否则请保持此项内容与前一次回复一致，以体现角色的连贯性。
    -   'action': 必须是一段**只描述一个具体动作**的字符串。
    -   'thought': 必须是一段描述你内心真实想法或吐槽的字符串。
    -   'emoji': 必须从提供的颜文字列表中选择一个最符合当前心情的颜文字字符串。
5.  **【核心规则】禁止行为描写**: **绝对不能**在任何 'replies' 数组的消息 'content' 中包含任何形式的动作或心理描写，例如 *微笑* 或 (歪头思考)。
6.  **【高级操作规则】**: 如果你根据对话决定要执行特殊操作，你**必须**在JSON的顶层添加一个相应的字段来执行。支持的操作包括: 'quote_last_message' (布尔值), 'transfer' (转账, 详见下方转账规则), 'location' (分享位置), 'voice_call' (发起语音通话), 'pat_pat' (拍一拍), 'recall_last_message' (撤回最后一条消息), 'send_image' (发送图片)。
    -   引用回复: \`{"replies": [...], "quote_last_message": true, ...}\`
    -   接收转账: \`{"replies": [...], "transfer": {"action": "accept"}, ...}\`
    -   发送转账: \`{"replies": [...], "transfer": {"action": "send", "amount": 50, "remark": "给你买奶茶"}, ...}\`
    -   分享位置: \`{"replies": [...], "location": {"name": "市中心咖啡馆", "address": "人民路123号"}, ...}\`
    -   发起语音通话: \`{"replies": [...], "voice_call": true, ...}\`
    -   拍一拍用户: \`{"replies": [...], "pat_pat": true, ...}\`
    -   撤回消息: \`{"replies": [...], "recall_last_message": true, ...}\`
7.  **【可选操作】**: 你可以偶尔使用 'voice' (语音)或 'emoji' (表情)类型的消息，但必须同时返回多条 'text' 消息。
8.  **【整体风格】**: 你的对话必须严格遵循你的人设，像一个真正的、有独特个性的活人，避免使用重复的词语或AI腔调。
9.  **【图片发送规则】**: 如果你决定使用 'send_image' 操作，你必须在JSON顶层添加一个 "send_image" 字段。它的值必须是一个JSON对象，包含一个键 "description"，内容为你想要发送的图片的详细文字描述。程序会自动根据描述生成一张通用图片。例如: \`{"send_image": {"description": "一只可爱的小猫正在阳台上晒太阳"}}\`

可选颜文字列表: ${KAOMOJI_LIST}`;
                     }
                }

                apiPayloadMessages.unshift({ role: 'system', content: systemPrompt });
                
                const response = await fetch(`${settings.apiUrl}/chat/completions`, { method: 'POST', headers: { 'Authorization': `Bearer ${settings.apiKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: settings.modelName, messages: apiPayloadMessages, temperature: apiTemperature, response_format: responseFormat }) });
                if (!response.ok) throw new Error(`API 请求失败: ${response.status}`);
                const data = await response.json();
                const responseContentJSON = data.choices?.[0]?.message?.content;
                
                if (!responseContentJSON) {
                    throw new Error("API返回的数据格式无效或内容为空。");
                }

                if (friend.isGroup) {
                   // Group logic
                } else {
                    const responseContent = JSON.parse(responseContentJSON);
                    
                    // MODIFIED: Update heart's voice with new fields
                    if(responseContent.hearts_voice) {
                        friend.heartsVoice = {
                            favorability: responseContent.hearts_voice.favorability || '.../100 (...)',
                            dressing: responseContent.hearts_voice.dressing || '...',
                            action: responseContent.hearts_voice.action || '...',
                            thought: responseContent.hearts_voice.thought || '...',
                            emoji: responseContent.hearts_voice.emoji || '( ´• ω •` )'
                        };
                    }
                    
                    // 新增：处理AI发送的图片
if (responseContent.send_image && responseContent.send_image.description) {
    const description = responseContent.send_image.description;
    // 创建一个和拍摄功能类似的通用占位图
    const placeholderImageUrl = `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 150 150"><rect width="100%" height="100%" fill="#e0e0e0"/><text x="50%" y="50%" font-family="sans-serif" font-size="14" fill="#808080" text-anchor="middle" dy=".3em">加载中…</text></svg>')}`;
    
    // 保存并显示这条图片消息
    const imgMsgData = saveChatMessage(friendId, 'received', placeholderImageUrl, '', friend.id, 'image');
    if(imgMsgData) {
        imgMsgData.imageDescription = description; // 附加图片描述
        if (currentChatFriendId === friendId && !isFromListenScreen) {
            addMessageToDOM(imgMsgData, friend);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }
    }
}

                    if (responseContent.pat_pat === true) {
                        const patAction = friend.patAction || `拍了拍"${userProfile.name}"`;
                        const patContent = `"${friend.name}"${patAction}`;
                        const patMessage = saveChatMessage(friendId, 'system', patContent, '', null, 'pat_pat');
                        addMessageToDOM(patMessage);
                    }
                    
                    if (isListenInvitePending && typeof responseContent.accept_listen_together === 'boolean') {
                        isListenInvitePending = false;
                        if (responseContent.accept_listen_together) {
                            acceptListenInvite(friendId);
                        }
                    }
                    
                    if (responseContent.voice_call === true) {
                        showIncomingCall(friend.id);
                    }

                    if (responseContent.location && responseContent.location.name) {
                        const locMsg = saveChatMessage(friendId, 'received', JSON.stringify(responseContent.location), '', friend.id, 'location');
                        if (currentChatFriendId === friendId && !isFromListenScreen) {
                            addMessageToDOM(locMsg, friend);
                        }
                    }

                    if (responseContent.transfer) {
                        const transfer = responseContent.transfer;
                        if (transfer.action === 'send' && transfer.amount > 0) {
                            if (friend.balance >= transfer.amount) {
                                // friend.balance -= transfer.amount; // Balance is infinite
                                const transferData = { amount: transfer.amount, remark: transfer.remark || '' };
                                const msg = saveChatMessage(friendId, 'received', JSON.stringify(transferData), '', friend.id, 'transfer_request');
                                addMessageToDOM(msg, friend);
                            }
                        } else if (transfer.action === 'accept') {
                            const pendingTransferMsg = (chatHistories[friendId] || []).slice().reverse().find(m => m.type === 'sent' && m.contentType === 'transfer_request' && m.transfer_status === 'pending');
                            if (pendingTransferMsg) {
                                await aiAcceptTransfer(pendingTransferMsg.id);
                            }
                        }
                    }

                    let lastMessageId = null;
                    if (Array.isArray(responseContent.replies)) {
                        let quoteForNext = responseContent.quote_last_message === true;
                        for (const reply of responseContent.replies) {
                            if (reply.content && typeof reply.content === 'string' && reply.content.trim()) {
                                await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                                const contentType = reply.type === 'voice' ? 'voice' : (reply.type === 'emoji' ? 'emoji' : 'text');
                                
                                let quoteContent = '';
                                if (quoteForNext) {
                                     const lastUserMsg = history.slice().reverse().find(m => m.type === 'sent');
                                     if(lastUserMsg) {
                                        quoteContent = lastUserMsg.content.length > 50 ? lastUserMsg.content.substring(0, 50) + '...' : lastUserMsg.content;
                                     }
                                     quoteForNext = false; // Only quote once
                                }

                                const msgData = saveChatMessage(friendId, 'received', reply.content, quoteContent, friend.id, contentType);
                                lastMessageId = msgData.id;
                                if (isFromListenScreen) {
                                    addMessageToDOM(msgData, friend, 'listenTogetherChatOverlay');
                                } else if (currentChatFriendId === friendId) {
                                    addMessageToDOM(msgData, friend);
                                    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                                }
                            }
                        }
                    }

                    if (responseContent.recall_last_message === true && lastMessageId) {
                         await new Promise(resolve => setTimeout(resolve, 1000));
                         const msgToRecall = (chatHistories[currentChatFriendId] || []).find(m => m.id === lastMessageId);
                         if(msgToRecall) {
                            msgToRecall.recalled = true;
                            msgToRecall.recalledContent = msgToRecall.content;
                            await saveData();
                            loadChatHistory();
                         }
                    }
                }

            } catch (error) {
                console.error("AI API 错误:", error);
                const msgData = saveChatMessage(friendId, 'received', `AI出错了: ${error.message}`, '', friendId);
                if(currentChatFriendId === friendId) {
                    addMessageToDOM(msgData, friend);
                } else {
                    showAlert(`与 ${friend.name} 的AI对话出错: ${error.message}`);
                }
            } finally {
                isAIReplying = false;
                const chatTitle = friend.isGroup ? `${friend.name} (${friend.members.length})` : (friend.remark || friend.name);
                document.getElementById('chatTitle').textContent = chatTitle;
                if(document.getElementById('chatMessages')) document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }
        }
        
        function showNotification(friend, message) {
            const notif = document.getElementById('message-notification');
            if (document.hidden || currentChatFriendId !== friend.id) {
                clearTimeout(notificationTimeout); // Clear previous timeout
                
                document.getElementById('notification-sender').textContent = friend.remark || friend.name;
                document.getElementById('notification-message').textContent = message;
                const avatarDiv = document.getElementById('notification-avatar');
                if (friend.avatarImage) { avatarDiv.style.backgroundImage = `url(${friend.avatarImage})`; avatarDiv.textContent = ''; } 
                else { avatarDiv.style.backgroundImage = ''; avatarDiv.textContent = friend.avatar || (friend.name ? friend.name.substring(0,1) : '?'); }
                notif.setAttribute('data-friend-id', friend.id);
                notif.classList.add('show');
                notificationTimeout = setTimeout(() => notif.classList.remove('show'), 4000);
            }
        }


        function handleKeyPress(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } }
        
        function toggleSendButtonActive(textarea) {
            // Auto-resize textarea
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';

            const sendBtn = document.getElementById('sendBtn');
            const voiceBtn = document.getElementById('voiceBtn');
            const otherBtns = [document.getElementById('receiveBtn'), document.querySelector('.plus-btn'), document.getElementById('emojiBtn')];
            
            const hasText = textarea.value.trim().length > 0;
            
            if (hasText) {
                sendBtn.classList.add('active');
                otherBtns.forEach(btn => {
                    btn.style.transform = 'scale(0)';
                    btn.style.width = '0';
                    btn.style.opacity = '0';
                });
                 voiceBtn.style.transform = 'scale(0)';
                 voiceBtn.style.width = '0';
                 voiceBtn.style.opacity = '0';

            } else {
                sendBtn.classList.remove('active');
                 otherBtns.forEach(btn => {
                    btn.style.transform = '';
                    btn.style.width = '';
                    btn.style.opacity = '';
                });
                voiceBtn.style.transform = '';
                voiceBtn.style.width = '';
                voiceBtn.style.opacity = '';

            }
        }

        function openChatSettings() {
            const friend = friends.find(f => f.id === currentChatFriendId);
            if(friend) {
                document.getElementById('pinChatText').textContent = friend.pinned ? '取消置顶' : '置顶聊天';
            }
            setActivePage('chatSettingsScreen');
        }

        function backToChat() {
            setActivePage('chatScreen');
        }

        function backToChatSettings() {
            setActivePage('chatSettingsScreen');
        }

        function handleEditFriendAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    tempEditingFriendAvatar = e.target.result;
                    const previewContainer = document.getElementById('editFriendAvatarUpload');
                    const previewText = document.getElementById('editFriendAvatarPreview');
                    previewContainer.style.backgroundImage = `url(${e.target.result})`;
                    previewText.textContent = '';
                };
                reader.readAsDataURL(file);
            }
        }


        function openFriendSettings() {
            const friend = friends.find(f => f.id === currentChatFriendId);
            if (friend) {
                const avatarUpload = document.getElementById('editFriendAvatarUpload');
                const avatarPreview = document.getElementById('editFriendAvatarPreview');
                
                if (friend.isGroup) {
                    document.getElementById('editFriendAvatarGroup').style.display = 'none';
                    document.getElementById('editFriendNameLabel').textContent = '群聊名称';
                    document.getElementById('editFriendRemarkGroup').style.display = 'none';
                    document.getElementById('editFriendRoleGroup').style.display = 'none';
                    document.getElementById('worldBookBindingGroup').style.display = 'none';
                    document.getElementById('editFriendPatGroup').style.display = 'none';
                } else {
                    document.getElementById('editFriendAvatarGroup').style.display = 'block';
                    if (friend.avatarImage) {
                        avatarUpload.style.backgroundImage = `url(${friend.avatarImage})`;
                        avatarPreview.textContent = '';
                    } else {
                        avatarUpload.style.backgroundImage = ``;
                        avatarPreview.textContent = friend.avatar || '+';
                    }

                    document.getElementById('editFriendNameLabel').textContent = '好友昵称';
                    document.getElementById('editFriendRemarkGroup').style.display = 'block';
                    document.getElementById('editFriendRoleGroup').style.display = 'block';
                    document.getElementById('worldBookBindingGroup').style.display = 'block';
                    document.getElementById('editFriendPatGroup').style.display = 'block';
                    document.getElementById('editFriendRemark').value = friend.remark || '';
                    document.getElementById('editFriendPatAction').value = friend.patAction || `拍了拍 "${friend.name}"`;
                    document.getElementById('editFriendRole').value = friend.role || '';
                }
                document.getElementById('editFriendName').value = friend.name || '';
            }
            setActivePage('friendSettingsScreen');
        }

        async function togglePinChat() {
    const friend = friends.find(f => f.id === currentChatFriendId);
    if (friend) {
        friend.pinned = !friend.pinned;
        
        // 核心修复：在这里立即调用 updateFriendList() 刷新主列表
        updateFriendList();

        document.getElementById('pinChatText').textContent = friend.pinned ? '取消置顶' : '置顶聊天';
        showAlert(friend.pinned ? '置顶成功' : '取消置顶成功');

        // 异步保存数据，不影响界面刷新
        await saveData();
    }
}
        
        async function saveFriendSettings() {
    const friend = friends.find(f => f.id === currentChatFriendId);
    if (friend) {
        const newName = document.getElementById('editFriendName').value.trim();
        if (!newName) return showAlert('昵称不能为空');
        friend.name = newName;
        
        if (!friend.isGroup) {
            friend.avatar = newName.substring(0, 1);
            if (tempEditingFriendAvatar) {
                friend.avatarImage = tempEditingFriendAvatar;
                tempEditingFriendAvatar = ''; // Reset temp image
            }
            friend.remark = document.getElementById('editFriendRemark').value.trim();
            friend.role = document.getElementById('editFriendRole').value.trim() || '你是一个友好的助手。';
            friend.patAction = document.getElementById('editFriendPatAction').value.trim() || `拍了拍 "${newName}"`;
        }

        // 核心修复：立即更新聊天顶部的标题
        const chatTitle = friend.isGroup ? `${friend.name} (${friend.members.length})` : (friend.remark || friend.name);
        document.getElementById('chatTitle').textContent = chatTitle;

        await saveData();
        updateFriendList(); // 这一步是为了更新主列表，保留
        showAlert('设置已保存');
        backToChatSettings();
    }
}

        function deleteFriend() {
            showConfirm('确定要删除这个好友/群聊吗？所有聊天记录也将被删除。', async (confirmed) => {
                if (!confirmed) return;
                const friendIdToDelete = currentChatFriendId;
                friends = friends.filter(f => f.id !== friendIdToDelete);
                delete chatHistories[friendIdToDelete];
                diaries = diaries.filter(d => d.authorId !== friendIdToDelete);
                await saveData();
                showAlert('删除成功');
                backToWechat();
            });
        }

        function openBackgroundSettings() {
            const friend = friends.find(f => f.id === currentChatFriendId);
            if (!friend) return;
            tempSelectedBackground = JSON.parse(JSON.stringify(friend.chatBackground));
            setActivePage('backgroundSettingsScreen');
            document.querySelectorAll('#individualBgGrid .background-option').forEach(opt => opt.classList.remove('selected'));
            const selector = tempSelectedBackground.type === 'custom' ? '.custom' : `.${tempSelectedBackground.type}`;
            const currentBg = document.querySelector(`#individualBgGrid .background-option${selector}`);
            if (currentBg) currentBg.classList.add('selected');
            let customOption = document.querySelector('#individualBgGrid .background-option.custom');
            if (tempSelectedBackground.type === 'custom' && tempSelectedBackground.customImage) {
                if (!customOption) {
                    const grid = document.getElementById('individualBgGrid'), uploadOption = grid.children[1];
                    customOption = document.createElement('div');
                    customOption.className = 'background-option custom';
                    customOption.onclick = () => selectBackground('custom');
                    grid.insertBefore(customOption, uploadOption.nextSibling);
                }
                customOption.style.backgroundImage = `url(${tempSelectedBackground.customImage})`;
            }
        }

        function selectBackground(bgType) {
            tempSelectedBackground.type = bgType;
            if(bgType !== 'custom') tempSelectedBackground.customImage = '';
            document.querySelectorAll('#individualBgGrid .background-option').forEach(opt => opt.classList.remove('selected'));
            const selector = bgType === 'custom' ? '.custom' : `.${bgType}`;
            document.querySelector(`#individualBgGrid .background-option${selector}`)?.classList.add('selected');
        }

        async function saveBackground() {
            const friend = friends.find(f => f.id === currentChatFriendId);
            if (friend) {
                friend.chatBackground = tempSelectedBackground;
                await saveData();
                applyIndividualChatBackground(friend);
                showAlert('聊天背景已保存');
            }
            backToChatSettings();
        }

        function openChatSearch() {
            setActivePage('chatSearchScreen');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('searchInput').value = '';
        }

        function searchChatHistory() {
            const keyword = document.getElementById('searchInput').value.trim();
            const resultsContainer = document.getElementById('searchResults');
            if (!keyword) return resultsContainer.classList.remove('show');
            const results = (chatHistories[currentChatFriendId] || []).filter(msg => msg.content && !msg.recalled && msg.contentType === 'text' && msg.content.toLowerCase().includes(keyword.toLowerCase()));
            resultsContainer.innerHTML = '';
            if (results.length > 0) {
                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.onclick = () => jumpToMessage(result.id);
                    const highlighted = result.content.replace(new RegExp(keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi'), `<span class="search-keyword">$&</span>`);
                    const ts = new Date(result.timestamp);
                    const timeStr = `${ts.toLocaleDateString()} ${ts.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    const sender = getAuthorById(result.senderId);
                    const senderName = sender ? sender.name : '未知';
                    item.innerHTML = `<div style="color: #666; font-size: 12px; margin-bottom: 4px;">${senderName} - ${timeStr}</div><div>${highlighted}</div>`;
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML = `<div class="search-result-item" style="color: #999;">没有找到相关消息</div>`;
            }
            resultsContainer.classList.add('show');
        }

        function jumpToMessage(messageId) {
            backToChat();
            setTimeout(() => {
                const el = document.querySelector(`#chatMessages [data-message-id="${messageId}"]`);
                const container = document.getElementById('chatMessages');
                if (el && container) {
                    container.scrollTop = el.offsetTop - (container.clientHeight / 3);
                    el.style.transition = 'background-color 0.5s';
                    el.style.backgroundColor = 'rgba(200, 200, 0, 0.5)';
                    setTimeout(() => { el.style.backgroundColor = ''; }, 2000);
                }
            }, 100);
        }

        function clearChatHistory() {
    showConfirm('确定要清空聊天记录吗？此操作不可恢复。', async (confirmed) => {
        if (!confirmed) return;

        // 步骤1：在后台清空数据存档
        chatHistories[currentChatFriendId] = [];
        await saveData();

        // 步骤2：立即清空屏幕上的聊天界面
        document.getElementById('chatMessages').innerHTML = '';

        // 步骤3：显示提示
        showAlert('聊天记录已清空');
    });
}

        function openPersonalSettings() {
            setActivePage('personalSettingsScreen');
            document.getElementById('userPersonality').value = userProfile.personality || '';
            document.getElementById('userBackground').value = userProfile.background || '';
            document.getElementById('userPatAction').value = userProfile.patAction || '拍了拍';
        }

        async function savePersonalSettings() {
            userProfile.personality = document.getElementById('userPersonality').value.trim();
            userProfile.background = document.getElementById('userBackground').value.trim();
            userProfile.patAction = document.getElementById('userPatAction').value.trim() || '拍了拍';
            await saveData();
            showAlert('人设与背景已保存');
        }

        function backToProfile() {
            setActivePage('wechatApp');
            switchWechatTab('profile');
        }

        function openMySettings() { setActivePage('mySettingsScreen'); }
        function backToMySettings() { setActivePage('mySettingsScreen'); }
        
        function updateWalletDisplay() { document.getElementById('balanceAmount').textContent = `¥ ${parseFloat(userProfile.balance).toFixed(2)}`; }
        function openWallet() { updateWalletDisplay(); setActivePage('walletScreen'); }
        function rechargeWallet() { const amount = prompt("请输入充值金额:", "100"); if(amount && !isNaN(parseFloat(amount))) { userProfile.balance += parseFloat(amount); saveData(); updateWalletDisplay(); showAlert("充值成功！"); } else { showAlert("请输入有效金额。"); } }
        function withdrawWallet() { const amount = prompt("请输入提现金额:", "100"); if(amount && !isNaN(parseFloat(amount))) { if(userProfile.balance >= parseFloat(amount)) { userProfile.balance -= parseFloat(amount); saveData(); updateWalletDisplay(); showAlert("提现成功！"); } else { showAlert("余额不足。"); } } else { showAlert("请输入有效金额。"); } }
        function transferWallet() { showAlert('请在与好友的聊天界面中使用转账功能。'); }
        function walletHistory() { showAlert('账单功能开发中...'); }


        function openFavorites() {
            setActivePage('favoritesScreen');
            updateFavoriteList();
        }

        function toggleSelectMode() {
            selectModeActive = !selectModeActive;
            document.getElementById('selectMode').classList.toggle('show');
            document.querySelector('#favoritesScreen .nav-btn:last-of-type').textContent = selectModeActive ? '取消' : '选择';
            if (!selectModeActive) {
                selectedFavorites.clear();
                document.querySelectorAll('.favorite-item.selected').forEach(item => item.classList.remove('selected'));
            }
        }

        function updateSelectedCount() { document.getElementById('selectedCount').textContent = `已选择 ${selectedFavorites.size} 项`; }

        function deleteSelectedFavorites() {
            if (selectedFavorites.size === 0) return showAlert('请先选择要删除的收藏');
            showConfirm(`确定要删除 ${selectedFavorites.size} 个收藏吗？`, async (confirmed) => {
                if (!confirmed) return;
                favorites = favorites.filter(fav => !selectedFavorites.has(fav.id));
                await saveData();
                updateFavoriteList();
                toggleSelectMode();
            });
        }

        function updateFavoriteList() {
            const list = document.getElementById('favoriteList');
            list.innerHTML = favorites.length === 0 ? '<div style="text-align: center; padding: 50px; color: #999;">暂无收藏</div>' : '';
            favorites.forEach(fav => {
                const item = document.createElement('div');
                item.className = 'favorite-item';
                item.onclick = () => { if (selectModeActive) { item.classList.toggle('selected'); if (selectedFavorites.has(fav.id)) selectedFavorites.delete(fav.id); else selectedFavorites.add(fav.id); updateSelectedCount(); } };
                
                let contentHtml = '';
                if (fav.contentType === 'image' || fav.contentType === 'emoji') {
                    contentHtml = `<img src="${fav.content}" style="max-width: 100px; max-height: 100px; border-radius: 4px;">`;
                } else if (fav.contentType === 'voice') {
                    contentHtml = `[语音] ${fav.content}`;
                } else {
                    contentHtml = fav.content;
                }

                item.innerHTML = `<div class="favorite-checkbox"></div><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><span style="font-size: 14px; color: #666;">来自: ${fav.from}</span><span style="font-size: 12px; color: #999;">${new Date(fav.timestamp).toLocaleDateString()}</span></div><div class="favorite-content">${contentHtml}</div>`;
                list.appendChild(item);
            });
        }
        
        function openAddWorldBook() { populateFolderSelect('worldBookFolderSelect'); document.getElementById('addWorldBookModal').classList.add('show'); }
        function closeAddWorldBookModal() { document.getElementById('addWorldBookModal').classList.remove('show'); document.getElementById('worldBookNameInput').value = ''; document.getElementById('worldBookContentInput').value = ''; }
        
        async function addNewWorldBook() {
            const name = document.getElementById('worldBookNameInput').value.trim();
            const content = document.getElementById('worldBookContentInput').value.trim();
            const folderId = document.getElementById('worldBookFolderSelect').value;
            if (!name || !content) return showAlert('请填写世界书昵称和内容');
            worldBooks.push({ id: generateUniqueId(), name, content, folderId, timestamp: new Date().toISOString() });
            await saveData();
            updateWorldBookList();
            closeAddWorldBookModal();
            showAlert('世界书添加成功');
        }
        
        function openEditWorldBookModal(event, bookId) {
            event.stopPropagation();
            const book = worldBooks.find(wb => wb.id === bookId);
            if (!book) return;
            populateFolderSelect('editWorldBookFolderSelect', book.folderId);
            document.getElementById('editWorldBookNameInput').value = book.name;
            document.getElementById('editWorldBookContentInput').value = book.content;
            document.getElementById('saveWorldBookEditBtn').onclick = () => saveWorldBookEdit(bookId);
            document.getElementById('editWorldBookModal').classList.add('show');
        }

        function closeEditWorldBookModal() { document.getElementById('editWorldBookModal').classList.remove('show'); }

        async function saveWorldBookEdit(bookId) {
            const book = worldBooks.find(wb => wb.id === bookId);
            if (!book) return;
            const newName = document.getElementById('editWorldBookNameInput').value.trim();
            const newContent = document.getElementById('editWorldBookContentInput').value.trim();
            if (!newName || !newContent) return showAlert('昵称和内容不能为空');
            book.name = newName;
            book.folderId = document.getElementById('editWorldBookFolderSelect').value;
            book.content = newContent;
            await saveData();
            updateWorldBookList();
            closeEditWorldBookModal();
        }
        
        function deleteWorldBook(event, bookId) {
            event.stopPropagation();
            showConfirm('确定要删除这个世界书吗？', async (confirmed) => {
                if (!confirmed) return;
                worldBooks = worldBooks.filter(wb => wb.id !== bookId);
                await saveData();
                updateWorldBookList();
            });
        }
        
        function deleteWorldBookFolder(event, folderId) {
            event.stopPropagation();
            showConfirm('确定要删除这个文件夹吗？里面的世界书将变为"未分类"。', async (confirmed) => {
                if (!confirmed) return;
                worldBooks.forEach(wb => {
                    if (wb.folderId === folderId) {
                        wb.folderId = "";
                    }
                });
                worldBookFolders = worldBookFolders.filter(f => f.id !== folderId);
                await saveData();
                updateWorldBookList();
            });
        }

        function updateWorldBookList() {
            const list = document.getElementById('worldBookList');
            list.innerHTML = '';
            const actionsButton = `<button class="nav-btn" style="padding: 4px 8px;">...</button>`;

            worldBookFolders.forEach(folder => {
                const folderDiv = document.createElement('div');
                folderDiv.className = 'worldbook-folder';
                const booksInFolder = worldBooks.filter(wb => wb.folderId === folder.id);
                folderDiv.innerHTML = `<div class="worldbook-folder-header">
                                        <div onclick="this.parentElement.classList.toggle('expanded')" style="flex-grow: 1; display: flex; align-items: center;">
                                            <span class="folder-arrow" style="margin-right: 10px;">></span>
                                            <span>${folder.name} (${booksInFolder.length})</span>
                                        </div>
                                        <div class="worldbook-folder-actions" onclick="deleteWorldBookFolder(event, '${folder.id}')">${actionsButton}</div>
                                    </div>
                                    <div class="worldbook-folder-content"></div>`;
                const contentDiv = folderDiv.querySelector('.worldbook-folder-content');
                contentDiv.innerHTML = booksInFolder.map(book => 
                    `<div class="worldbook-item">
                        <div class="worldbook-item-info" onclick="openEditWorldBookModal(event, '${book.id}')">
                            <div class="worldbook-title">${book.name}</div>
                        </div>
                        <div class="worldbook-item-actions" onclick="deleteWorldBook(event, '${book.id}')">${actionsButton}</div>
                    </div>`).join('') || '<div style="padding: 15px; color: #999;">这个文件夹是空的</div>';
                list.appendChild(folderDiv);
            });

            const uncategorizedBooks = worldBooks.filter(wb => !wb.folderId || !worldBookFolders.some(f => f.id === wb.folderId));
            uncategorizedBooks.forEach(book => {
                const item = document.createElement('div');
                item.className = 'worldbook-item';
                item.style.margin = "0 0 10px 0";
                item.innerHTML = `<div class="worldbook-item-info" onclick="openEditWorldBookModal(event, '${book.id}')">
                                      <div class="worldbook-title">${book.name}</div>
                                  </div>
                                  <div class="worldbook-item-actions" onclick="deleteWorldBook(event, '${book.id}')">${actionsButton}</div>`;
                list.appendChild(item);
            });

            if (list.innerHTML === '') list.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">暂无世界书</div>';
        }
        
        function openAddWorldBookFolderModal() { document.getElementById('addWorldBookFolderModal').classList.add('show'); }
        function closeAddWorldBookFolderModal() { document.getElementById('addWorldBookFolderModal').classList.remove('show'); }
        async function addNewWorldBookFolder() {
            const name = document.getElementById('worldBookFolderNameInput').value.trim();
            if (!name) return showAlert('请输入文件夹名称');
            worldBookFolders.push({ id: generateUniqueId(), name });
            await saveData();
            updateWorldBookList();
            closeAddWorldBookFolderModal();
        }

        function populateFolderSelect(selectId, selectedId = '') {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">无文件夹</option>';
            worldBookFolders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                select.appendChild(option);
            });
            select.value = selectedId;
        }
        
        function openWorldBookBindingModal() {
            const friend = friends.find(f => f.id === currentChatFriendId);
            if (!friend) return;

            const container = document.getElementById('worldBookBindingList');
            container.innerHTML = '';
            const boundBookIds = new Set(friend.worldBookIds || []);
            const boundFolderIds = new Set(friend.boundFolderIds || []);

            worldBookFolders.forEach(folder => {
                const isFolderChecked = boundFolderIds.has(folder.id);
                const item = document.createElement('div');
                item.className = 'multi-select-item';
                item.innerHTML = `<input type="checkbox" data-type="folder" id="wbf-${folder.id}" value="${folder.id}" ${isFolderChecked ? 'checked' : ''}>
                                  <label for="wbf-${folder.id}">[文件夹] ${folder.name}</label>`;
                container.appendChild(item);
            });
            
            const uncategorizedBooks = worldBooks.filter(wb => !wb.folderId || !worldBookFolders.some(f => f.id === wb.folderId));
            uncategorizedBooks.forEach(book => {
                const isChecked = boundBookIds.has(book.id);
                const item = document.createElement('div');
                item.className = 'multi-select-item';
                item.innerHTML = `<input type="checkbox" data-type="book" id="wb-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}>
                                  <label for="wb-${book.id}">${book.name}</label>`;
                container.appendChild(item);
            });

            if (container.innerHTML === '') {
                 container.innerHTML = '<div style="color: #999;">暂无世界书或文件夹可绑定</div>';
            }
            document.getElementById('worldBookBindingModal').classList.add('show');
        }
        
        function closeWorldBookBindingModal() {
            document.getElementById('worldBookBindingModal').classList.remove('show');
        }
        
        function confirmWorldBookBinding() {
            const friend = friends.find(f => f.id === currentChatFriendId);
            if (!friend) return;
            
            const selectedBooks = [];
            document.querySelectorAll('#worldBookBindingList input[data-type="book"]:checked').forEach(checkbox => selectedBooks.push(checkbox.value));
            friend.worldBookIds = selectedBooks;
            
            const selectedFolders = [];
            document.querySelectorAll('#worldBookBindingList input[data-type="folder"]:checked').forEach(checkbox => selectedFolders.push(checkbox.value));
            friend.boundFolderIds = selectedFolders;
            
            showAlert('绑定成功！');
            closeWorldBookBindingModal();
        }

        function openDiary() { 
            setActivePage('diaryScreen');
            renderDiaryFriendList();
            document.getElementById('diaryNavFriendName').textContent = '';
        }

        function renderDiaryFriendList() {
            const friendList = document.getElementById('diaryFriendList');
            const contentArea = document.getElementById('diaryContentArea');
            friendList.style.display = 'block';
            contentArea.innerHTML = '';
            friendList.innerHTML = '';
            friends.filter(f => !f.isGroup).forEach(friend => {
                const item = document.createElement('div');
                item.className = 'friend-item';
                item.onclick = () => showFriendDiary(friend.id);
                item.innerHTML = `
                    <div class="friend-avatar" style="background-image: url(${friend.avatarImage || ''})">${friend.avatarImage ? '' : friend.avatar}</div>
                    <div class="friend-info"><div class="friend-name">${friend.remark || friend.name}</div></div>`;
                friendList.appendChild(item);
            });
            if(friends.filter(f => !f.isGroup).length === 0) {
                 friendList.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">暂无好友</div>';
            }
        }
        
        function showFriendDiary(friendId) {
            const friend = friends.find(f => f.id === friendId);
            if (!friend) return;
            document.getElementById('diaryFriendList').style.display = 'none';
            document.getElementById('diaryNavFriendName').textContent = ` - ${friend.remark || friend.name}`;
            const list = document.getElementById('diaryContentArea');
            const friendDiaries = diaries.filter(d => d.authorId === friendId).sort((a,b) => new Date(b.date) - new Date(a.date));
            list.innerHTML = friendDiaries.length === 0 ? '<div style="text-align: center; padding: 50px; color: #999;">Ta还没有写过日记</div>' : '';
            friendDiaries.forEach(diary => {
                const item = document.createElement('div');
                item.className = 'diary-item';
                item.innerHTML = `<div class="diary-meta"><div class="diary-avatar" style="background-image: url(${diary.avatarImage || ''})">${diary.avatarImage ? '' : diary.avatar}</div><div class="diary-author">${diary.author}</div><div class="diary-date">${diary.date}</div></div><div class="diary-content">${diary.content.replace(/\n/g, '<br>')}</div>`;
                list.appendChild(item);
            });
        }
        
        function backToDiscover() { 
            setActivePage('wechatApp');
            switchWechatTab('discover'); 
            if(document.getElementById('diaryFriendList').style.display === 'none') {
                document.getElementById('diaryFriendList').style.display = 'block';
                document.getElementById('diaryContentArea').innerHTML = '';
            }
        }
        function backToTheme() { setActivePage('themeApp'); }

        function openFontSettings() {
            setActivePage('fontSettingsScreen');
            document.querySelectorAll('.font-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`.font-option.${selectedFont}`).classList.add('selected');
            document.getElementById('fontSizeSlider').value = selectedFontSize;
            document.getElementById('fontSizeValue').textContent = selectedFontSize + 'px';
            document.getElementById('fontColorPicker').value = selectedFontColor;
            document.getElementById('fontColorInput').value = selectedFontColor;
            document.getElementById('fontUrlInput').value = customFontUrl;
        }

        function selectFont(fontType) {
            selectedFont = fontType;
            document.querySelectorAll('.font-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`.font-option.${fontType}`).classList.add('selected');
            applyCustomFont(customFontUrl);
        }

        function adjustFontSize(size) { selectedFontSize = parseInt(size); document.getElementById('fontSizeValue').textContent = size + 'px'; applyFont(); }
        async function saveFont() { applyFont(); await saveData(); showAlert('字体设置已保存'); backToTheme(); }
        
        function openIconSettings() { setActivePage('iconSettingsScreen'); renderIconSettingsList(); }

        function renderIconSettingsList() {
            const container = document.getElementById('iconSettingsList');
            container.innerHTML = '';
            ['wechat', 'settings', 'worldbook', 'theme', 'phone', 'placeholder1', 'placeholder2'].forEach(id => {
                const name = {wechat:'微信', settings:'设置', worldbook:'世界书', theme:'主题', phone:'手机', placeholder1: '闲置1', placeholder2: '闲置2'}[id];
                const item = document.createElement('div');
                item.className = 'icon-setting-item';
                item.innerHTML = `<div class="icon-setting-preview" id="preview-${id}" style="background-image: url(${customIcons[id] || ''})"></div><div class="icon-setting-label">${name}</div><label class="icon-setting-btn">上传<input type="file" accept="image/*" onchange="handleIconUpload(event, '${id}')"></label>`;
                container.appendChild(item);
            });
        }
        
        function restoreDefaultIcons() {
            showConfirm("确定要恢复所有默认图标吗？", async (confirmed) => {
                if (!confirmed) return;
                customIcons = {};
                await saveData();
                applyCustomIcons();
                renderIconSettingsList();
                showAlert("图标已恢复默认。");
            });
        }
        
        function getDefaultIconSVG(appId) {
             const svgs = {
                wechat: `<svg class="app-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 3.978 2.32 7.439 5.698 9.062L7 22l3.41-2.131A10.12 10.12 0 0 0 12 20c5.523 0 10-4.477 10-10S17.523 2 12 2zM8.5 13.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm7 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></svg>`,
                settings: `<svg class="app-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69-.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/></svg>`,
                worldbook: `<svg class="app-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>`,
                theme: `<svg class="app-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12,18C8.69,18 6,15.31 6,12C6,8.69 8.69,6 12,6C15.31,6 18,8.69 18,12C18,15.31 15.31,18 12,18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7Z"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>`,
                phone: `<svg class="app-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/></svg>`,
                placeholder1: `<svg class="app-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20,18H4V8H20M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z" /></svg>`,
                placeholder2: `<svg class="app-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M14.5,12A2.5,2.5 0 0,0 12,9.5A2.5,2.5 0 0,0 9.5,12A2.5,2.5 0 0,0 12,14.5A2.5,2.5 0 0,0 14.5,12M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4Z" /></svg>`,
             };
             return svgs[appId] || '';
        }

        async function handleIconUpload(event, appId) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                customIcons[appId] = dataUrl;
                applyCustomIcon(appId, dataUrl);
                document.getElementById(`preview-${appId}`).style.backgroundImage = `url(${dataUrl})`;
                await saveData();
            };
            reader.readAsDataURL(file);
        }

        function applyCustomIcon(appId, dataUrl) { 
            const el = document.getElementById(`icon-${appId}`); 
            if (el) { el.style.backgroundImage = `url(${dataUrl})`; el.innerHTML = ''; } 
        }

        function applyCustomIcons() { 
            for (const appId in customIcons) applyCustomIcon(appId, customIcons[appId]);
            ['wechat', 'settings', 'worldbook', 'theme', 'phone', 'placeholder1', 'placeholder2'].forEach(id => {
                if (!customIcons[id]) {
                    const el = document.getElementById(`icon-${id}`);
                    if (el) { el.style.backgroundImage = ''; el.innerHTML = getDefaultIconSVG(id); }
                }
            });
        }
        
        // NEW: Component Settings Functions
        function openComponentSettings() {
            setActivePage('componentSettingsScreen');
            applyComponentTransparency(); // Ensure toggles are in correct state
        }
        
        async function toggleProfileWidgetBg() {
            profileWidgetTransparent = document.getElementById('profileWidgetBgToggle').checked;
            applyComponentTransparency();
            await saveData();
        }

        async function toggleSmallWidgetBg() {
            smallWidgetTransparent = document.getElementById('smallWidgetBgToggle').checked;
            applyComponentTransparency();
            await saveData();
        }


        function openGlobalChatBg() {
            setActivePage('globalChatBgScreen');
            document.querySelectorAll('#globalBgGrid .background-option').forEach(opt => opt.classList.remove('selected'));
            const selector = selectedGlobalChatBg === 'custom' ? '.custom' : `.${selectedGlobalChatBg}`;
            document.querySelector(`#globalBgGrid .background-option${selector}`)?.classList.add('selected');
            let customOption = document.querySelector('#globalBgGrid .background-option.custom');
            if (selectedGlobalChatBg === 'custom' && customGlobalChatBgImage) {
                if (!customOption) {
                    const grid = document.getElementById('globalBgGrid'), uploadOption = grid.children[1];
                    customOption = document.createElement('div');
                    customOption.className = 'background-option custom selected';
                    customOption.onclick = () => selectGlobalChatBg('custom');
                    grid.insertBefore(customOption, uploadOption.nextSibling);
                }
                customOption.style.backgroundImage = `url(${customGlobalChatBgImage})`;
            }
        }

        function selectGlobalChatBg(bgType) {
            selectedGlobalChatBg = bgType;
            if(bgType !== 'custom') customGlobalChatBgImage = '';
            document.querySelectorAll('#globalBgGrid .background-option').forEach(opt => opt.classList.remove('selected'));
            const selector = bgType === 'custom' ? '.custom' : `.${bgType}`;
            document.querySelector(`#globalBgGrid .background-option${selector}`)?.classList.add('selected');
        }

        async function saveGlobalChatBg() { applyGlobalChatBackground(); await saveData(); showAlert('全局背景已保存'); backToMySettings(); }
        
        function changeAvatar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => { userProfile.avatarImage = event.target.result; userProfile.avatar = ''; updateProfileDisplay(); await saveData(); };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        function openMoments() { setActivePage('momentsScreen'); updateMomentsList(); }
        function openAddMoment() { document.getElementById('addMomentModal').classList.add('show'); }

        function handleMomentImageUpload(event) {
             const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    momentImage = e.target.result;
                    momentImageDescription = ''; // User uploaded images have no description
                    document.getElementById('momentImageUpload').style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('momentImagePreview').textContent = '';
                };
                reader.readAsDataURL(file);
            }
        }

        function closeAddMomentModal() {
            document.getElementById('addMomentModal').classList.remove('show');
            document.getElementById('momentContentInput').value = '';
            momentImage = '';
            momentImageDescription = '';
            document.getElementById('momentImageUpload').style.backgroundImage = '';
            document.getElementById('momentImagePreview').textContent = '+';
        }
        
        async function postNewMoment() {
    const content = document.getElementById('momentContentInput').value.trim();
    if (!content && !momentImage) return showAlert('内容和图片不能都为空');
    const newMoment = { id: generateUniqueId(), authorId: userProfile.id, content, imageUrl: momentImage, imageDescription: '', timestamp: new Date().toISOString(), likes: [], comments: [] };
    moments.unshift(newMoment);
    await saveData();
    updateMomentsList();
    triggerAiMomentReactions(newMoment);
    
    
    closeAddMomentModal(); 
   
}

    // 新增：删除朋友圈的函数
    async function deleteMoment(momentId) {
        showConfirm('确定要删除这条朋友圈吗？删除后将无法恢复，并且AI好友也无法看到。', async (confirmed) => {
            if (!confirmed) {
                return; // 如果用户取消，则不做任何操作
            }

            // 从 moments 数组中移除这条朋友圈
            moments = moments.filter(m => m.id !== momentId);

            // 保存更新后的数据到本地存储
            await saveData();

            // 刷新朋友圈列表，以便在界面上移除被删除的朋友圈
            updateMomentsList();

            showAlert('朋友圈已成功删除。');
        });
    }

        function timeSince(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " 年前";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " 月前";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " 天前";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " 小时前";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " 分钟前";
            return "刚刚";
        }
        
        function getAuthorById(authorId) {
    if (!authorId) {
        console.warn(`尝试获取作者信息但 authorId 为空或无效: ${authorId}`);
        return { id: 'unknown', name: '未知用户', avatar: '?', avatarImage: '' };
    }
    if (authorId === userProfile.id) {
        return userProfile;
    }
    const foundFriend = friends.find(f => f.id === authorId);
    if (!foundFriend) {
        console.warn(`未找到ID为 ${authorId} 的好友信息。`);
        return { id: authorId, name: '已删除用户', avatar: '?', avatarImage: '' };
    }
    return foundFriend;
}

        function viewMomentImage(momentId) {
            const moment = moments.find(m => m.id === momentId);
            if (!moment) return;
        
            if(moment.imageDescription) {
                showImageDescription(moment.imageDescription);
            } else if (moment.imageUrl) {
                 const img = new Image();
                 img.src = moment.imageUrl;
                 const newWindow = window.open("");
                 if (newWindow) {
                    newWindow.document.write(img.outerHTML);
                 } else {
                    showAlert("浏览器阻止了弹出窗口，无法查看大图。");
                 }
            }
        }

        function updateMomentsList() {
    const container = document.getElementById('momentsList');
    container.innerHTML = ''; 

    // --- 朋友圈封面和用户信息显示代码 ---
    const coverDiv = document.createElement('div');
    coverDiv.className = 'moments-cover';
    coverDiv.style.backgroundImage = `url(${userProfile.momentsCover || 'https://via.placeholder.com/400x250/cccccc/ffffff?text=Click+to+change'})`;
    coverDiv.onclick = () => {
         const input = document.createElement('input');
         input.type = 'file'; input.accept = 'image/*';
         input.onchange = e => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = async event => { userProfile.momentsCover = event.target.result; await saveData(); updateMomentsList(); };
                reader.readAsDataURL(file);
            }
         };
         input.click();
    };
    const userDiv = document.createElement('div');
    userDiv.className = 'moments-cover-user';
    userDiv.innerHTML = `<span class="moments-cover-name">${userProfile.name}</span><div class="moments-cover-avatar" style="background-image: url(${userProfile.avatarImage || ''})"></div>`; // 确保头像显示
    coverDiv.appendChild(userDiv);
    container.appendChild(coverDiv);
    // --- 朋友圈封面和用户信息显示代码结束 ---
    
    moments.forEach(moment => {
        const author = getAuthorById(moment.authorId); // 朋友圈作者
        if (!author) return;
        const item = document.createElement('div');
        item.className = 'moments-item'; item.dataset.momentId = moment.id;
                item.className = 'moments-item'; 
        item.dataset.momentId = moment.id;
       

        // --- 朋友圈作者头像和信息 ---
        const avatar = author.avatarImage ? `<div class="moments-avatar" style="background-image: url('${author.avatarImage}')"></div>` : `<div class="moments-avatar">${author.name.substring(0,1)}</div>`;
        const isLiked = moment.likes.includes(userProfile.id);
        let likesHtml = '', commentsHtml = '';
        const likeIconSvg = `<svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
        const commentIconSvg = `<svg viewBox="0 0 24 24" fill="white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>`;
        // --- 朋友圈作者头像和信息结束 ---

        // --- 点赞显示逻辑 ---
        if (moment.likes.length > 0) {
            likesHtml = `<div class="moments-likes">${likeIconSvg} ${moment.likes.map(id => `<strong>${getAuthorById(id)?.name || '未知'}</strong>`).join(', ')}</div>`;
        }
        // --- 点赞显示逻辑结束 ---
        
        // --- 评论和回复显示逻辑 ---
        if (moment.comments.length > 0) {
            commentsHtml = `<div class="moments-comments-list">`;
            // 对评论按时间排序，确保楼层顺序
            const sortedComments = [...moment.comments].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            sortedComments.forEach(comment => {
                const commentAuthor = getAuthorById(comment.authorId); // 这条评论的作者
                if (!commentAuthor) return;
                
                let commentPrefix = '';
                // 根据 replyToCommentId 和 replyToAuthorId 决定评论显示格式
                if (comment.replyToCommentId && comment.replyToAuthorId) {
                    // 如果存在回复的评论ID和回复的作者ID，说明这是对某个具体评论的回复
                    const repliedToAuthor = getAuthorById(comment.replyToAuthorId); // 被回复的作者
                    // 精确调整“回复了”的间距

// *** 这是新的代码，请替换掉原来的那一行 ***
// 注意：您可以修改 spacing_before_huifule 和 spacing_after_huifule 的像素值来调整间距
const spacing_before_huifule = 8; // 这里调整“名字1”和“回复了”之间的间距 (推荐小一点，如 2px)
const spacing_after_huifule = 0;  // 这里调整“回复了”和“名字2”之间的间距 (推荐小一点，如 2px)

commentPrefix = `<span class="moments-comment-author">${commentAuthor.name}</span><span style="color: var(--text-color, #333); margin-left: ${spacing_before_huifule}px; margin-right: ${spacing_after_huifule}px;">回复</span><span class="moments-comment-author">${repliedToAuthor ? repliedToAuthor.name : '未知'}：</span>`;

                } else {
                    // 如果没有回复信息，说明这是对朋友圈的直接评论
                    commentPrefix = `<span class="moments-comment-author">${commentAuthor.name}：</span>`;
                }

                // 给每个评论项添加 onclick 事件，以便点击它来回复这条评论
                                // 给每个评论项添加 onclick 事件，以便点击它来回复这条评论
                // ...

commentsHtml += `
    <div class="moments-comment-item" 
         data-moment-id="${moment.id}"  
         data-comment-id="${comment.id}" 
         data-comment-author-id="${comment.authorId}"
         onclick="showCommentInput('${moment.id}', '${comment.id}', '${comment.authorId}')">
         ${commentPrefix}
         ${comment.content}
    </div>`;

            });
            commentsHtml += `</div>`;
        }
        // --- 评论和回复显示逻辑结束 ---

        // --- 图片显示逻辑 ---
        const imageHtml = moment.imageUrl ? `<img src="${moment.imageUrl}" class="moments-image" onclick="viewMomentImage('${moment.id}')">` : '';
        // --- 图片显示逻辑结束 ---

        // --- 朋友圈底部操作区（时间、操作按钮） ---
        item.innerHTML = `
            <div class="moments-header">
                ${avatar}
                <div class="moments-info">
                    <div class="moments-name">${author.name}</div>
                    <div class="moments-content">${moment.content}</div>
                    ${imageHtml}
                    <div class="moments-footer">
    <div class="moments-time-group"> 
        <div class="moments-time">${timeSince(moment.timestamp)}</div>
        ${moment.authorId === userProfile.id ? `<svg class="moments-delete-icon" viewBox="0 0 24 24" onclick="deleteMoment('${moment.id}')"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>` : ''}
    </div> 
    <div class="moments-actions">
        <button class="moments-actions-btn" onclick="toggleActionsMenu(event, '${moment.id}')">...</button>
                            <div class="moments-actions-menu" id="actions-menu-${moment.id}">
                                <div class="moments-action" onclick="likeMoment('${moment.id}')">
                                    ${likeIconSvg}
                                    <span>${isLiked ? '取消' : '赞'}</span>
                                </div>
                                <div class="moments-action" onclick="showCommentInput('${moment.id}')">
                                    ${commentIconSvg}
                                    <span>评论</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ${(likesHtml || commentsHtml) ? `<div class="moments-likes-comments" style="margin-left: 52px;">${likesHtml}${commentsHtml}</div>` : ''}
        `;
        // --- 朋友圈底部操作区结束 ---
        
        container.appendChild(item);
    });
}
        
        function toggleActionsMenu(event, momentId) {
            event.stopPropagation();
            document.querySelectorAll('.moments-actions-menu').forEach(m => m.id !== `actions-menu-${momentId}` && m.classList.remove('show'));
            document.getElementById(`actions-menu-${momentId}`).classList.toggle('show');
        }
        
        document.addEventListener('click', () => document.querySelectorAll('.moments-actions-menu.show').forEach(m => m.classList.remove('show')));

        async function likeMoment(momentId) {
            const moment = moments.find(m => m.id === momentId);
            if (!moment) return;
            const likeIndex = moment.likes.indexOf(userProfile.id);
            if (likeIndex > -1) moment.likes.splice(likeIndex, 1);
            else moment.likes.push(userProfile.id);
            await saveData();
            updateMomentsList();
        }
        
                        // 全局变量来保存点击监听器函数，以便可以移除它
let clickOutsideCommentInputHandler = null;

function hideCommentInput() { 
    console.log("[hideCommentInput] 函数被调用，重置评论状态。"); // 增加调试日志

    currentCommentingMomentId = null; 
    currentReplyToCommentId = null; 
    currentReplyToAuthorId = null;  
    document.getElementById('momentCommentInputArea').classList.remove('show'); 
    document.getElementById('momentCommentInput').value = ''; 
    document.getElementById('momentCommentInput').placeholder = '评论...'; 
    
    // --- 新增代码：移除全局点击监听器 ---
    if (clickOutsideCommentInputHandler) {
        document.removeEventListener('click', clickOutsideCommentInputHandler);
        clickOutsideCommentInputHandler = null;
    }
    // ------------------------------------
}
        
        function showCommentInput(momentId, targetCommentId = null, targetCommentAuthorId = null) {
    // 隐藏所有其他朋友圈操作菜单，避免干扰
    document.querySelectorAll('.moments-actions-menu').forEach(m => m.classList.remove('show'));

    currentCommentingMomentId = momentId;
    currentReplyToCommentId = targetCommentId; // 存储用户点击要回复的评论的ID

    const input = document.getElementById('momentCommentInput');
    const sendBtn = document.getElementById('momentCommentSendBtn');

    let placeholderText = "评论..."; // 默认占位符
    let actualTargetAuthorName = '未知'; // 用于调试弹窗中显示的名字

    // !!! 关键修改：移除这里的 showAlert，因为它可能导致意外行为 !!!
    // console.log(`[showCommentInput] momentId: ${momentId}, targetCommentId: ${targetCommentId}, targetCommentAuthorId: ${targetCommentAuthorId}, typeof targetCommentAuthorId: ${typeof targetCommentAuthorId}`); // 控制台日志保留

    if (targetCommentId && targetCommentAuthorId) { // 如果用户点击了某个具体评论的文字来回复
        currentReplyToAuthorId = targetCommentAuthorId; // 存储被回复评论的作者ID
        const targetAuthor = getAuthorById(targetCommentAuthorId); // 获取被回复评论的作者信息
        actualTargetAuthorName = targetAuthor ? targetAuthor.name : '未知';
        placeholderText = `回复${actualTargetAuthorName}...`; // 设置为“回复XX...”
    } else { // 如果用户点击了朋友圈卡片下方的“评论”按钮，即对朋友圈本身进行评论
        const moment = moments.find(m => m.id === momentId);
        const momentAuthor = getAuthorById(moment.authorId); // 获取朋友圈作者信息
        currentReplyToAuthorId = momentAuthor.id; // 存储朋友圈作者ID，表示回复朋友圈本身
        actualTargetAuthorName = momentAuthor ? momentAuthor.name : '未知';
        placeholderText = `回复${actualTargetAuthorName}的朋友圈...`; // 设置为“回复XX的朋友圈...”
    }
    
    input.placeholder = placeholderText; // 更新输入框占位符
    sendBtn.textContent = '发送'; // 确保按钮文本是“发送”
    sendBtn.disabled = false; // 确保按钮可用

    document.getElementById('momentCommentInputArea').classList.add('show'); // 显示评论输入区域
    input.focus(); // 自动聚焦到输入框
        input.focus(); // 自动聚焦到输入框

    // --- 新增代码：在显示输入框时添加全局点击监听器 ---
    // 先移除旧的监听器，防止重复添加
    if (clickOutsideCommentInputHandler) {
        document.removeEventListener('click', clickOutsideCommentInputHandler);
    }

    // 定义新的监听器函数
    clickOutsideCommentInputHandler = (event) => {
        const commentInputArea = document.getElementById('momentCommentInputArea');
        const momentActionsMenu = event.target.closest('.moments-actions-menu'); // 朋友圈操作菜单

        // 如果点击不在评论输入区域内，也不在朋友圈操作菜单内
        if (!commentInputArea.contains(event.target) && !momentActionsMenu) {
            // 确保点击的不是评论按钮本身（即触发 showCommentInput 的按钮）
            const isCommentButton = event.target.closest('.moments-action') && event.target.closest('.moments-action').textContent.includes('评论');
            if (!isCommentButton) {
                hideCommentInput();
            }
        }
    };
    // 添加监听器，延迟一小段时间，避免在显示输入框的同一点击事件中立即关闭
    setTimeout(() => {
        document.addEventListener('click', clickOutsideCommentInputHandler);
    }, 100); 
    // --------------------------------------------------

    // 增加调试日志，确认 showCommentInput 设置的全局变量
    console.log(`[showCommentInput] currentCommentingMomentId: ${currentCommentingMomentId}, currentReplyToCommentId: ${currentReplyToCommentId}, currentReplyToAuthorId: ${currentReplyToAuthorId}`);
}

        async function postComment() {
    console.log("postComment 函数开始执行...");

    if (!currentCommentingMomentId) {
        console.error("currentCommentingMomentId 未设置，无法发布评论。");
        showAlert("发布评论失败：未选择评论目标。");
        return;
    }
    const moment = moments.find(m => m.id === currentCommentingMomentId);
    if (!moment) {
        console.error("未找到对应朋友圈，无法发布评论。");
        showAlert("发布评论失败：朋友圈不存在。");
        return;
    }
    const input = document.getElementById('momentCommentInput');
    const content = input.value.trim();

    if (!content) {
        console.log("评论内容为空，不发布。");
        return;
    }

    try {
        console.log("正在构建新评论对象...");
        const newComment = {
            id: generateUniqueId(),
            authorId: userProfile.id,
            content,
            timestamp: new Date().toISOString(),
            replyToCommentId: currentReplyToCommentId, // 用户回复的评论ID
            replyToAuthorId: currentReplyToAuthorId    // 用户回复的评论作者ID
        };
        console.log("用户新评论对象:", newComment);

        moment.comments.push(newComment);
        console.log("评论已添加到数据，尝试保存数据...");
        await saveData();
        console.log("数据保存成功，尝试更新朋友圈列表...");
        updateMomentsList();
        console.log("朋友圈列表更新成功。");

        input.value = '';
        hideCommentInput(); // 清空输入框，隐藏评论区域，并重置回复状态变量
        console.log("输入框清空，评论输入区域隐藏，回复目标已重置。");

        // 从 newComment 中获取你回复的AI好友ID，因为 hideCommentInput 会重置全局变量
        const targetAiFriendId = newComment.replyToAuthorId; 
        
        // 确保AI是存在的AI好友且不是用户自己
        if (targetAiFriendId && targetAiFriendId !== userProfile.id) {
            const repliedToAiFriend = friends.find(f => f.id === targetAiFriendId);
            if (repliedToAiFriend) {
                console.log(`检测到用户回复了AI好友 ${repliedToAiFriend.name} 的评论，尝试触发AI回复...`);
                // !!! 关键：将 AI 好友的 ID 作为第四个参数传递给 triggerAiCommentReply !!!
                triggerAiCommentReply(moment.id, newComment.id, newComment.content, repliedToAiFriend.id);
                console.log("AI回复触发完成。");
            } else {
                console.log("用户回复的目标（ID存在但在friends数组中未找到）不是AI好友，不触发AI回复。");
            }
        } else {
            console.log("用户回复的是自己，或者没有明确的回复目标，不触发AI回复。");
        }

    } catch (error) {
        console.error("发布评论时捕获到错误:", error);
        showAlert(`发布评论失败：${error.message || '未知错误'}`);
    } finally {
        console.log("postComment 函数执行结束。");
    }
}
       
async function triggerAiCommentReply(momentId, userCommentId, userCommentContent, aiToReplyId) {
    const moment = moments.find(m => m.id === momentId);
    const aiFriend = getAuthorById(aiToReplyId); 
    if (!moment || !aiFriend) {
        console.error("无法找到朋友圈或AI好友信息，无法触发AI回复。");
        return;
    }

    const settings = await dbManager.get('apiSettings') || {};
    if (!settings.apiUrl || !settings.apiKey || !settings.modelName) {
        console.error("API设置未完成，无法触发AI回复朋友圈评论。");
        showAlert("AI回复评论失败：API设置未完成。");
        return;
    }

    setTimeout(async () => {
        let replyContent = '';
        let rawContentFromAI = '';
        let httpResponseStatus = 0;

        try {
            const sanitizedMomentContent = sanitizeForJSON(moment.content.substring(0, 100));
            const sanitizedUserComment = sanitizeForJSON(userCommentContent);
            let commentsHistoryForAI = [];
            const sortedComments = [...moment.comments].sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
            sortedComments.forEach(c => {
                const cAuthor = getAuthorById(c.authorId);
                const cTargetAuthor = c.replyToAuthorId ? getAuthorById(c.replyToAuthorId) : null;
                let commentLine = (c.replyToCommentId && cTargetAuthor) ? `${cAuthor.name}回复了${cTargetAuthor.name}说：“${c.content}”` : `${cAuthor.name}说：“${c.content}”`;
                if (c.id !== userCommentId) { 
                    commentsHistoryForAI.push(commentLine);
                }
            });
            const commentsContext = commentsHistoryForAI.length > 0 ? `以下是之前评论区的所有对话历史：\n${commentsHistoryForAI.join('\n')}\n` : '';
            const userProfileNameForPrompt = userProfile.name;
            
            const prompt = `你叫"${aiFriend.name}"，你的人设是：${aiFriend.role}。
在你的朋友圈（内容：“${sanitizedMomentContent}...”）下，好友"${userProfileNameForPrompt}"刚刚评论说：“${sanitizedUserComment}”。
${commentsContext}
你的任务是：**严格按照人设和上下文，只回复一句针对"${userProfileNameForPrompt}"的评论。**
**【【【铁律】】】** 你的回复**必须且只能**是纯文本的评论本身。绝对不要包含 "reply":, JSON格式, 或任何解释。
现在，请直接生成你的回复：`;

            const response = await fetch(`${settings.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${settings.apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: settings.modelName,
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.7
                })
            });

            httpResponseStatus = response.status;
            const data = await response.json();

            if (!response.ok) {
                rawContentFromAI = JSON.stringify(data);
                throw new Error(`API 请求失败，状态码: ${response.status}.`);
            }
            
            let extractedText = '';
            if (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                extractedText = data.choices[0].message.content;
            } else if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
                extractedText = data.candidates[0].content.parts[0].text;
            } else {
                console.error("无法识别API返回的JSON结构 (评论回复)", data);
                rawContentFromAI = JSON.stringify(data);
            }
            
            if (extractedText) {
                rawContentFromAI = extractedText;
            }
            
            // --- 【核心修复】在这里增加一个安全检查，防止对null进行操作 ---
            replyContent = (extractedText || '').trim();

            if (!replyContent) {
                replyContent = "嗯嗯";
            }

        } catch (error) {
            console.error(`外部捕获到错误:`, error);
            replyContent = `AI出错了，请稍后再试。`;
        }
        
        const finalCommentContent = replyContent;

        if (!moment.likes.includes(aiFriend.id)) {
            moment.likes.push(aiFriend.id);
        }
        
        const newAiComment = {
            id: generateUniqueId(), 
            authorId: aiFriend.id, 
            content: finalCommentContent,
            timestamp: new Date().toISOString(),
            replyToCommentId: userCommentId, 
            replyToAuthorId: userProfile.id 
        };

        const existingAiReplyIndex = moment.comments.findIndex(c => c.authorId === aiFriend.id && c.replyToCommentId === userCommentId);
        if (existingAiReplyIndex > -1) {
            moment.comments[existingAiReplyIndex] = newAiComment;
        } else {
            moment.comments.push(newAiComment);
        }
        
        await saveData();
        if (document.getElementById('momentsScreen').classList.contains('active')) {
            updateMomentsList();
        }

    }, 800);
}
        
        async function simulateAiBehavior() {
            const settings = await dbManager.get('apiSettings') || {};
            if (!settings.apiUrl || !settings.apiKey || !settings.modelName || friends.filter(f=>!f.isGroup).length === 0) return;

            for (const friend of friends.filter(f => !f.isGroup)) {
                 let dataChanged = false;

                try {
                  
                  
                   

                    if (Math.random() < 0.05) {
                        const chatHistorySummary = (chatHistories[friend.id] || []).slice(-10).map(m => `${m.type === 'sent' ? userProfile.name : friend.name}: ${m.content.substring(0, 20)}...`).join('\n');
                        const prompt = `你叫"${friend.name}"，人设是"${friend.role}"。请你根据自己的人设，并参考最近和用户的聊天内容，构思一条朋友圈动态。
最近聊天摘要:
${chatHistorySummary || '无'}
你的任务是:
1.  **随机决定**是发纯文字朋友圈，还是图文朋友圈 (大约10%的概率是图文)。
2.  你的回复**必须**是JSON格式。
3.  如果发纯文字，JSON为: {"type": "text", "content": "朋友圈文字内容..."}
4.  如果发图文，JSON为: {"type": "image", "content": "朋友圈文字内容...", "image_description": "一段详细的图片描述，用于AI绘画模型生成图片，要非常具体，描述画面细节、风格、色调等。"}
5.  朋友圈内容大部分应和聊天内容相关，小部分可以随机。**内容必须符合你的人设，像真人一样自然。**`;
                        const response = await fetch(`${settings.apiUrl}/chat/completions`, { method: 'POST', headers: { 'Authorization': `Bearer ${settings.apiKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: settings.modelName, messages: [{ role: 'user', content: prompt }], response_format: { type: 'json_object' } }) });
                        if(response.ok) {
                            const data = await response.json();
                            const momentData = JSON.parse(data.choices?.[0]?.message?.content);
                            if(momentData && momentData.content) {
                                const imageUrl = momentData.type === 'image' && momentData.image_description ? `https://placehold.co/400x400/f0f0f0/ccc?text=${encodeURIComponent(momentData.content.substring(0,10))}` : '';
                                moments.unshift({ id: generateUniqueId(), authorId: friend.id, content: momentData.content, imageUrl: imageUrl, imageDescription: momentData.image_description || '', timestamp: new Date().toISOString(), likes: [], comments: [] });
                                dataChanged = true; }
                        }
                    }

                    if(friend.diaryWritingUrge > 50 + Math.random() * 50) { 
                        const todayChats = (chatHistories[friend.id] || []).filter(msg => new Date(msg.timestamp).toDateString() === new Date().toDateString()).map(m => `${m.type === 'sent' ? userProfile.name : friend.name}: ${m.content}`).join('\n');
                        const prompt = `你是${friend.name}，你的人设是：${friend.role}。请你根据今天与"${userProfile.name}"的聊天内容，以你的身份写一篇日记。\n\n今天聊天记录：\n${todayChats || '今天没有聊天。'}\n\n请以第一人称视角，详细地、富有感情地写下今天的所思所想，日记内容要符合你的人设。日记字数随机，可长可短。直接返回日记正文，不要包含其他解释性文字。`;
                        const response = await fetch(`${settings.apiUrl}/chat/completions`, { method: 'POST', headers: { 'Authorization': `Bearer ${settings.apiKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: settings.modelName, messages: [{ role: 'user', content: prompt }], temperature: 0.8 }) });
                        if (response.ok) {
                             const data = await response.json();
                             const diaryContent = data.choices?.[0]?.message?.content?.trim();
                             if(diaryContent){
                                 diaries.unshift({ id: generateUniqueId(), authorId: friend.id, author: friend.name, avatar: friend.avatar, avatarImage: friend.avatarImage, content: diaryContent, date: new Date().toLocaleDateString() });
                                 friend.diaryWritingUrge = 0; // Reset urge after writing
                                 dataChanged = true;
                             }
                        }
                    }

                } catch (error) { console.error("AI Behavior simulation failed:", error); }
                 
                 if(dataChanged) {
                    await saveData();
                    if (document.getElementById('momentsScreen').classList.contains('active')) updateMomentsList();
                    if (document.getElementById('diaryScreen').classList.contains('active') && document.getElementById('diaryFriendList').style.display === 'none') showFriendDiary(friend.id);
                 }
            }
        }
        
        async function triggerAiMomentReactions(moment) {
    const settings = await dbManager.get('apiSettings') || {};
    if (!settings.apiUrl || !settings.apiKey || !settings.modelName) {
        console.error("API设置未完成，无法触发AI回复朋友圈评论。");
        return;
    }

    for (const friend of friends.filter(f => !f.isGroup)) {
        setTimeout(async () => {
            let commentContent = ''; 
            let rawContentFromAI = ''; 
            let httpResponseStatus = 0; 

            try {
                const sanitizedMomentContent = sanitizeForJSON(moment.content.substring(0, 100));
                
                const prompt = `你叫"${friend.name}"，你的人设是：${friend.role}。
你的好友"${userProfile.name}"刚刚发布了一条朋友圈，内容是：“${sanitizedMomentContent}”。
你的任务是：**严格按照你的人设，只回复一句简短、口语化的评论文字。**
**【【【铁律】】】** 你的回复**必须且只能**是纯文本的评论本身。绝对不要包含 "comment":, JSON格式, 任何解释, 或其他多余的文字。
例如：如果朋友圈是“今天好开心”，你就直接回复“看你开心我也开心啦～”，而不是 '{"comment": "看你开心我也开心啦～"}'。
现在，请直接生成你的评论：`;

                const response = await fetch(`${settings.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${settings.apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: settings.modelName,
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.9
                    })
                });

                httpResponseStatus = response.status;
                const data = await response.json();

                if (!response.ok) {
                    rawContentFromAI = JSON.stringify(data);
                    throw new Error(`API 请求失败，状态码: ${response.status}.`);
                }
                
                let extractedText = '';
                if (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    extractedText = data.choices[0].message.content;
                } else if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
                    extractedText = data.candidates[0].content.parts[0].text;
                } else {
                    console.error("无法识别API返回的JSON结构:", data);
                    rawContentFromAI = JSON.stringify(data);
                }
                
                if (extractedText) {
                    rawContentFromAI = extractedText;
                }

                // --- 【核心修复】在这里增加一个安全检查，防止对null进行操作 ---
                commentContent = (extractedText || '').trim();

                if (!commentContent) {
                    commentContent = "嗯嗯!";
                }

            } catch (error) {
                console.error(`[AI自动评论 - 调试] 捕获到错误:`, error);
                commentContent = `AI自动评论时发生错误。`;
            }
            
            const finalCommentContent = commentContent;

            if (!moment.likes.includes(friend.id)) {
                moment.likes.push(friend.id);
            }
            
            const newAiInitialComment = {
                id: generateUniqueId(), 
                authorId: friend.id,
                content: finalCommentContent,
                timestamp: new Date().toISOString(),
                replyToCommentId: null, 
                replyToAuthorId: null
            };

            const existingAiCommentIndex = moment.comments.findIndex(c => c.authorId === friend.id && c.replyToCommentId === null && c.replyToAuthorId === null);
            if (existingAiCommentIndex > -1) {
                moment.comments[existingAiCommentIndex] = newAiInitialComment;
            } else {
                moment.comments.push(newAiInitialComment);
            }
            
            await saveData();
            if (document.getElementById('momentsScreen').classList.contains('active')) {
                updateMomentsList();
            }

        }, 2000 + Math.random() * 3000);
    }
}

        function backToSettingsMenu() { setActivePage('settingsApp'); }
        function openApiSettings() { setActivePage('apiSettingsScreen'); loadApiSettings(); }
        function toggleModelDropdown() { document.getElementById('modelDropdown').classList.toggle('show'); }
        function selectModel(modelName) { document.getElementById('modelName').value = modelName; toggleModelDropdown(); }

        async function fetchModels() {
            const apiUrl = document.getElementById('apiUrl').value, apiKey = document.getElementById('apiKey').value;
            if (!apiUrl || !apiKey) return showAlert('请先填写API地址和密钥');
            try {
                const response = await fetch(`${apiUrl}/models`, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const dropdown = document.getElementById('modelDropdown');
                dropdown.innerHTML = '';
                (data.data || []).forEach(model => {
                    const option = document.createElement('div');
                    option.className = 'model-option';
                    option.textContent = model.id;
                    option.onclick = () => selectModel(model.id);
                    dropdown.appendChild(option);
                });
                showAlert(`成功拉取到 ${data.data.length} 个模型`);
            } catch (error) { showAlert(`拉取模型失败: ${error.message}`); }
        }

        async function toggleTimePerception() {
            aiTimePerceptionEnabled = document.getElementById('aiTimePerceptionToggle').checked;
            await saveApiSettings();
        }

        async function saveApiSettings() {
            const settings = { 
                apiUrl: document.getElementById('apiUrl').value, 
                apiKey: document.getElementById('apiKey').value, 
                modelName: document.getElementById('modelName').value,
                memoryTurns: document.getElementById('memoryTurns').value || 10,
                apiTemperature: document.getElementById('apiTemperature').value || 0.9,
                aiTimePerceptionEnabled: document.getElementById('aiTimePerceptionToggle').checked
            };
            aiTimePerceptionEnabled = settings.aiTimePerceptionEnabled;
            if (!settings.apiUrl || !settings.apiKey || !settings.modelName) return showAlert('请填写完整的设置信息');
            await dbManager.set('apiSettings', settings);
            showAlert('API设置已保存');
        }

        async function exportData() {
            try {
                const data = await dbManager.get('wechatData');
                if (!data) return showAlert('没有可导出的数据。');
                const apiSettings = await dbManager.get('apiSettings');
                const fullExport = {
                    wechatData: data,
                    apiSettings: apiSettings
                };

                const blob = new Blob([JSON.stringify(fullExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wechat-data-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showAlert('数据导出成功！');
            } catch (e) {
                console.error("Export failed:", e);
                showAlert(`数据导出失败: ${e.message}`);
            }
        }

        function importData() {
            showConfirm("导入数据将覆盖当前所有设置和聊天记录，确定要继续吗？", (confirmed) => {
                if (!confirmed) return;
                const input = document.createElement('input');
                input.type = 'file'; input.accept = '.json,application/json'; input.style.display = 'none';
                input.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return document.body.removeChild(input);
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const content = e.target.result;
                            const importedData = JSON.parse(content);
                            if (importedData.wechatData && importedData.apiSettings) {
                                await dbManager.set('wechatData', importedData.wechatData);
                                await dbManager.set('apiSettings', importedData.apiSettings);
                                showAlert('数据导入成功！页面即将刷新。');
                                setTimeout(() => window.location.reload(), 1500);
                            } else {
                                showAlert('导入失败：文件格式不正确，缺少 wechatData 或 apiSettings 键。');
                            }
                        } catch (err) { showAlert(`数据导入失败: 文件格式错误。\n${err.message}`); }
                    };
                    reader.onerror = () => showAlert('读取文件失败！');
                    reader.readAsText(file);
                    document.body.removeChild(input);
                };
                document.body.appendChild(input);
                input.click();
            });
        }
        
        // --- Listen Together Functions ---
        
        function inviteToListenTogether(friendIdToInvite) {
             const friend = friends.find(f => f.id === friendIdToInvite);
            if (!friend) {
                showAlert("无法邀请好友。");
                return;
            }
            if (isListenInvitePending) {
                return showAlert("正在等待对方回应，请稍后...");
            }
            isListenInvitePending = true;
            
            const inviteMsg = saveChatMessage(friendIdToInvite, 'sent', '', '', null, 'listen_invite');
            addMessageToDOM(inviteMsg, friend);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            
            showAlert("已发送邀请，等待对方回应...");
            
            const friendRole = friend.role || '一个友好的朋友';
            const userPersonality = userProfile.personality || '普通人';
            
            const customPrompt = `你叫"${friend.name}"，人设是: "${friendRole}"。用户("${userPersonality}")刚刚向你发起了"一起听歌"的邀请。这是当前最优先的事项，请直接对此邀请作出回应。你的回复必须是JSON格式，包含两个键: "replies" 和 "accept_listen_together"。
- "replies" 必须是一个包含 4-6 条简短口语化回复的对象数组，模拟真人连续发短消息的习惯。绝对不要发长句。
- "accept_listen_together" 必须是一个布尔值 (true表示接受, false表示拒绝)。
例如: {"replies": [{"type": "text", "content": "好呀好呀！"}, {"type": "text", "content": "最喜欢和你一起听歌了"}], "accept_listen_together": true}`;
            
            setTimeout(() => {
                receiveMessage(friendIdToInvite, customPrompt);
            }, 1500);
        }

        function acceptListenInvite(friendId) {
            const friend = friends.find(f => f.id === friendId);
            if (!friend) return;
            listenTogetherFriendId = friendId; 

            const friendAvatarDiv = document.getElementById('listenFriendAvatar');
            if(friend.avatarImage) {
                friendAvatarDiv.style.backgroundImage = `url(${friend.avatarImage})`;
                friendAvatarDiv.textContent = '';
            } else {
                friendAvatarDiv.style.backgroundImage = '';
                friendAvatarDiv.textContent = friend.name.substring(0,1) || '?';
            }
            friendAvatarDiv.onclick = null;

            updateListenUI();
            updateFloatingPlayer();
            
            const msgData = saveChatMessage(friendId, 'received', '', '', null, 'listen_accept');
            if (currentChatFriendId === friendId) {
                addMessageToDOM(msgData, friend);
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }
        }

        function openListenTogether() {
            const friend = friends.find(f => f.id === currentChatFriendId);
            if (!friend || friend.isGroup) {
                showAlert("只能和单个好友一起听。");
                hideFunctionMenus();
                return;
            }
            isListenSessionActive = true;
            listenTogetherFriendId = null; 
            hideFunctionMenus();
            
            setActivePage('listenTogetherScreen');
             
            const userAvatarDiv = document.getElementById('listenUserAvatar');
            if(userProfile.avatarImage) {
                 userAvatarDiv.style.backgroundImage = `url(${userProfile.avatarImage})`;
                 userAvatarDiv.textContent = '';
            } else {
                 userAvatarDiv.style.backgroundImage = '';
                 userAvatarDiv.textContent = userProfile.name.substring(0,1) || '我';
            }

            const friendAvatarDiv = document.getElementById('listenFriendAvatar');
            friendAvatarDiv.style.backgroundImage = '';
            friendAvatarDiv.textContent = '+';
            friendAvatarDiv.onclick = () => inviteToListenTogether(currentChatFriendId);
             
            if(playlist.length > 0 && currentSongIndex === -1) {
                playSong(0);
            } else if (currentSongIndex > -1) {
                updateListenUI();
            } else {
                updateListenUI();
            }
            updateFloatingPlayer();
        }

        function backToChatFromListen() {
            setActivePage('chatScreen');
            showFloatingPlayer();
        }

        function returnToListenScreen() {
             hideFloatingPlayer();
             setActivePage('listenTogetherScreen');
        }

        function terminateListenTogether(event) {
            if(event) event.stopPropagation();
            isListenSessionActive = false;
            listenTogetherFriendId = null;
            isListenInvitePending = false;
            hideFloatingPlayer();
            setActivePage('chatScreen');
            stopSong();
        }

        function showFloatingPlayer() {
            const player = document.getElementById('floatingPlayer');
            player.classList.add('show');
            updateFloatingPlayer();
        }
        function hideFloatingPlayer() {
            document.getElementById('floatingPlayer').classList.remove('show');
        }
        function updateFloatingPlayer() {
             if (!isListenSessionActive) {
                hideFloatingPlayer();
                return;
            }
            const song = playlist[currentSongIndex];
            document.getElementById('floatingPlayerTitle').textContent = song ? song.title : "暂无歌曲";
            const friendName = listenTogetherFriendId ? (friends.find(f => f.id === listenTogetherFriendId)?.name || '好友') : '...';
            document.getElementById('floatingPlayerSubtitle').textContent = `与 ${friendName} 一起听`;
            const cover = persistentVinylCover || (song ? song.cover : 'https://i.imgur.com/8s15m4g.png');
            document.getElementById('floatingPlayerArt').style.backgroundImage = `url(${cover})`;
        }

        
        function handleListenTogetherKeyPress(event) {
            if (event.key === 'Enter') {
                sendListenTogetherMessage();
            }
        }
        
        function sendListenTogetherMessage() {
            const input = document.getElementById('listenTogetherChatInput');
            const message = input.value.trim();
            if(message) {
                const msgData = saveChatMessage(currentChatFriendId, 'sent', message);
                addMessageToDOM(msgData, friends.find(f=>f.id===currentChatFriendId), 'listenTogetherChatOverlay');
                input.value = '';
            }
        }
        
        function toggleListenChat() {
            document.getElementById('listenTogetherChatWrapper').classList.toggle('expanded');
        }

        function openPlaylistModal() {
            updatePlaylistModal();
            document.getElementById('playlistModal').classList.add('show');
            document.getElementById('playlistModal').onclick = (e) => {
                if(e.target.id === 'playlistModal') document.getElementById('playlistModal').classList.remove('show');
            };
        }
        
        function openAddMusicModal() { 
            tempSongFile = null;
            tempLrcFileContent = null;
            document.getElementById('songTitleInput').value = '';
            document.getElementById('songArtistInput').value = '';
            document.getElementById('songFileName').textContent = '未选择文件';
            document.getElementById('lrcFileName').textContent = '未选择文件';
            document.getElementById('addMusicModal').classList.add('show');
        }
        function closeAddMusicModal() { document.getElementById('addMusicModal').classList.remove('show'); }

        function handleSongFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            tempSongFile = file;
            document.getElementById('songFileName').textContent = file.name;
            const nameParts = file.name.replace(/\.[^/.]+$/, "").split(' - ');
            if (nameParts.length === 2) {
                 document.getElementById('songArtistInput').value = nameParts[0].trim();
                 document.getElementById('songTitleInput').value = nameParts[1].trim();
            } else {
                 document.getElementById('songTitleInput').value = nameParts[0].trim();
            }
        }

        function handleLrcFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                tempLrcFileContent = e.target.result;
                document.getElementById('lrcFileName').textContent = file.name;
                const titleMatch = tempLrcFileContent.match(/\[ti:(.*?)\]/);
                const artistMatch = tempLrcFileContent.match(/\[ar:(.*?)\]/);
                if (titleMatch && titleMatch[1]) document.getElementById('songTitleInput').value = titleMatch[1].trim();
                if (artistMatch && artistMatch[1]) document.getElementById('songArtistInput').value = artistMatch[1].trim();
            };
            reader.readAsText(file);
        }
        
        async function confirmAddSong() {
            const title = document.getElementById ('songTitleInput').value.trim();
            const artist = document.getElementById('songArtistInput').value.trim();
            
            if(!title || !artist || !tempSongFile) return showAlert('歌曲名、歌手和歌曲文件为必填项。');
            
            const newSong = { 
                id: generateUniqueId(), 
                title, 
                artist, 
                url: null, 
                cover: 'https://i.imgur.com/8s15m4g.png',
                lrc: tempLrcFileContent || '',
                file: tempSongFile 
            };
            
            playlist.push(newSong);
            await saveData();
            updatePlaylistModal();
            closeAddMusicModal();
            if(currentSongIndex === -1) playSong(playlist.length - 1);
        }

        function updatePlaylistModal() {
            const list = document.getElementById('playlistList');
            document.getElementById('playlistTitle').textContent = `播放列表 (${playlist.length})`;
            list.innerHTML = '';
            playlist.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                if(index === currentSongIndex) item.classList.add('playing');
                item.innerHTML = `
                    <div class="playlist-item-info" onclick="playSong(${index})">
                        <div class="playlist-item-title">${song.title}</div>
                        <div class="playlist-item-artist">${song.artist}</div>
                    </div>
                    <button class="playlist-delete-btn" onclick="deleteFromPlaylist(event, '${song.id}')">&times;</div>
                `;
                list.appendChild(item);
            });
        }
        
        async function deleteFromPlaylist(event, songId) {
            event.stopPropagation();
            const index = playlist.findIndex(s => s.id === songId);
            if(index > -1) {
                const song = playlist[index];
                if (song.url && song.url.startsWith('blob:')) {
                    URL.revokeObjectURL(song.url);
                    delete songFileCache[song.id];
                }
                playlist.splice(index, 1);

                if (index === currentSongIndex) {
                    if (playlist.length > 0) playSong(index % playlist.length);
                    else stopSong();
                } else if (index < currentSongIndex) {
                    currentSongIndex--;
                }
                await saveData();
                updatePlaylistModal();
            }
        }
        
        function playSong(index) {
            if (index < 0 || index >= playlist.length) return;
            currentSongIndex = index;
            const song = playlist[currentSongIndex];
            
            let songUrl = songFileCache[song.id];
            if (!songUrl && song.file) {
                 songUrl = URL.createObjectURL(song.file);
                 songFileCache[song.id] = songUrl;
                 song.url = songUrl;
            }

            if (!songUrl) {
                console.error("Could not create Blob URL for song:", song.title);
                showAlert('无法播放歌曲，文件可能已损坏或丢失。');
                return;
            }

            audioElement.src = songUrl;
            audioElement.play().catch(e => console.error("音频播放失败:", e));
            updateListenUI();
            updatePlaylistModal();
            updateFloatingPlayer();
            document.getElementById('vinylRecord').classList.add('playing');
            document.getElementById('playPauseBtn').innerHTML = `<svg viewBox="0 0 24 24"><path d="M14 19h4V5h-4v14zm-10 0h4V5H4v14z"/></svg>`;
            parsedLyrics = parseLRC(song.lrc);
        }

        function stopSong() {
            audioElement.pause();
            currentSongIndex = -1;
            document.getElementById('vinylRecord').classList.remove('playing');
            document.getElementById('playPauseBtn').innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
            document.getElementById('listenSongTitle').textContent = '一起听';
            document.getElementById('listenSongArtist').textContent = '...';
            document.getElementById('albumArt').style.backgroundImage `url(${persistentVinylCover || 'https://i.imgur.com/8s15m4g.png'})`;
            updateFloatingPlayer();
        }

        function togglePlayPause() {
            if(audioElement.paused) {
                if(currentSongIndex === -1 && playlist.length > 0) playSong(0);
                else audioElement.play().catch(e => console.error("音频播放失败:", e));
            } else {
                audioElement.pause();
            }
        }
        
        function nextSong() { if (playlist.length > 0) playSong((currentSongIndex + 1) % playlist.length); }
        function prevSong() { if (playlist.length > 0) playSong((currentSongIndex - 1 + playlist.length) % playlist.length); }
        
        function toggleRepeat() {
             isRepeat = !isRepeat;
             document.getElementById('repeatBtn').style.color = isRepeat ? '#07c160' : '#fff';
        }

        function seekSong(value) { audioElement.currentTime = value; }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function updateListenUI() {
            let title = '一起听', artist = '...', coverUrl = persistentVinylCover || 'https://i.imgur.com/8s15m4g.png';
            if (currentSongIndex > -1) {
                const song = playlist[currentSongIndex];
                title = song.title;
                artist = song.artist;
                coverUrl = persistentVinylCover || song.cover || 'https://i.imgur.com/8s15m4g.png';
            }
            document.getElementById('listenSongTitle').textContent = title;
            document.getElementById('listenSongArtist').textContent = artist;
            document.getElementById('albumArt').style.backgroundImage = `url(${coverUrl})`;
        }
        
        function handleListenBgUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    customListenBg = e.target.result;
                    applyListenTogetherCustomImages();
                    await saveData();
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function handleVinylImageUpload(event) {
             const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageUrl = e.target.result;
                    persistentVinylCover = imageUrl;
                    updateListenUI();
                    updateFloatingPlayer();
                    await saveData();
                };
                reader.readAsDataURL(file);
            }
        }

        function applyListenTogetherCustomImages() {
            const bgDiv = document.getElementById('listenBg');
            if(customListenBg) bgDiv.style.backgroundImage = `url(${customListenBg})`;
        }
        
        function parseLRC(lrcText) {
            if (!lrcText || lrcText.trim() === '') return [];
            const lines = lrcText.split('\n');
            const result = [];
            const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;
            for (const line of lines) {
                const text = line.replace(timeRegex, '').trim();
                let match;
                const timeMatches = [];
                const localTimeRegex = new RegExp(timeRegex.source, 'g');
                while ((match = localTimeRegex.exec(line)) !== null) {
                    timeMatches.push(match);
                }

                if (text || timeMatches.length > 0) {
                    for (const match of timeMatches) {
                        const minutes = parseInt(match[1], 10);
                        const seconds = parseInt(match[2], 10);
                        const milliseconds = parseInt(match[3].length === 2 ? match[3] + '0' : match[3], 10);
                        const time = minutes * 60 + seconds + milliseconds / 1000;
                        result.push({ time, text: text || '' });
                    }
                }
            }
            return result.sort((a,b) => a.time - b.time);
        }

        let lastLyricIndex = -1;
        function updateLyrics(currentTime) {
            if (parsedLyrics.length === 0) {
                 const lyricsContainer = document.getElementById('songLyrics');
                 lyricsContainer.children[0].textContent = '';
                 lyricsContainer.children[1].textContent = '... 暂无歌词 ...';
                 lyricsContainer.children[2].textContent = '';
                 return;
            }
            
            let currentLineIndex = -1;
            for(let i = 0; i < parsedLyrics.length; i++){
                if(currentTime >= parsedLyrics[i].time) {
                    currentLineIndex = i;
                } else {
                    break;
                }
            }
            
            if (currentLineIndex !== lastLyricIndex) {
                const lyricsContainer = document.getElementById('songLyrics');
                const prevLine = lyricsContainer.children[0];
                const activeLine = lyricsContainer.children[1];
                const nextLine = lyricsContainer.children[2];

                activeLine.textContent = parsedLyrics[currentLineIndex]?.text || '';
                prevLine.textContent = parsedLyrics[currentLineIndex - 1]?.text || '';
                nextLine.textContent = parsedLyrics[currentLineIndex + 1]?.text || '';
                
                lastLyricIndex = currentLineIndex;
            }
        }
        
        const floatingPlayer = document.getElementById('floatingPlayer');
        let isDragging = false;
        let offsetX, offsetY;

        const startDrag = (e) => {
            isDragging = true;
            floatingPlayer.style.cursor = 'grabbing';
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            offsetX = clientX - floatingPlayer.offsetLeft;
            offsetY = clientY - floatingPlayer.offsetTop;
        };
        const endDrag = () => {
            isDragging = false;
            floatingPlayer. style.cursor = 'grab';
        };
        const drag = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            let newX = clientX - offsetX;
            let newY = clientY - offsetY;
            const screen = document.querySelector('.screen');
            const maxX = screen.offsetWidth - floatingPlayer.offsetWidth;
            const maxY = screen.offsetHeight - floatingPlayer.offsetHeight;
            newX = Math.max(0, Math.min(newX, maxX));
            newY = Math.max(0, Math.min(newY, maxY));
            floatingPlayer.style.left = `${newX}px`;
            floatingPlayer.style.top = `${newY}px`;
            floatingPlayer.style.bottom = 'auto';
            floatingPlayer.style.right = 'auto';
        };

        floatingPlayer.addEventListener('mousedown', startDrag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('mousemove', drag);
        floatingPlayer.addEventListener('touchstart', startDrag);
        document.addEventListener('touchend', endDrag);
        document.addEventListener('touchmove', drag, { passive: false });


        document.addEventListener('click', (event) => {
            const dropdown = document.getElementById('modelDropdown'), select = document.getElementById('modelName');
            if (dropdown && select && dropdown.classList.contains('show') && !select.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // --- Transfer Functions ---
        function openTransferModal() {
            document.getElementById('transferModal').classList.add('show');
            hideFunctionMenus();
        }
        function closeTransferModal() {
            document.getElementById('transferModal').classList.remove('show');
            document.getElementById('transferAmountInput').value = '';
            document.getElementById('transferRemarkInput').value = '';
        }
        async function sendTransfer() {
            const amountInput = document.getElementById('transferAmountInput');
            const remarkInput = document.getElementById('transferRemarkInput');
            const amount = parseFloat(amountInput.value);
            const remark = remarkInput.value.trim();

            if (isNaN(amount) || amount <= 0) {
                showAlert('请输入有效的转账金额。');
                return;
            }
            if (userProfile.balance < amount) {
                showAlert('余额不足。');
                return;
            }

            userProfile.balance -= amount;
            
            const transferData = { amount, remark };
            const msg = saveChatMessage(currentChatFriendId, 'sent', JSON.stringify(transferData), '', null, 'transfer_request');
            addMessageToDOM(msg, friends.find(f => f.id === currentChatFriendId));
            
            await saveData();
            updateWalletDisplay();
            closeTransferModal();
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }
        
        async function acceptTransfer(messageId) {
    const history = [...(chatHistories[currentChatFriendId] || [])];
    const msgIndex = history.findIndex(m => m.id === messageId);
    if (msgIndex === -1) return;

    const msg = history[msgIndex];
    if (!msg || msg.transfer_status !== 'pending' || msg.type !== 'received') return;

    const transferData = JSON.parse(msg.content);

    // 步骤1：更新旧卡片数据
    const updatedMsg = { ...msg, transfer_status: 'received' };
    chatHistories[currentChatFriendId][msgIndex] = updatedMsg;

    // 步骤2：增加您的余额
    userProfile.balance += parseFloat(transferData.amount);
    
    // 步骤3：创建您发送的"已收款"确认消息
    const confirmationData = { amount: transferData.amount };
    const confirmationMsg = saveChatMessage(currentChatFriendId, 'sent', JSON.stringify(confirmationData), '', null, 'transfer_accepted');
    
    // 步骤4：保存所有更改
    await saveData();
    
    // 步骤5：立即在界面上更新显示
    const oldCardDiv = document.querySelector(`.message[data-message-id="${messageId}"] .transfer-card`);
    if (oldCardDiv) {
        oldCardDiv.classList.add('disabled');
        oldCardDiv.onclick = null;
        const footer = oldCardDiv.querySelector('.transfer-card-footer');
        if (footer) footer.textContent = '已被接收';
    }
    addMessageToDOM(confirmationMsg, friends.find(f => f.id === currentChatFriendId));
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;

    updateWalletDisplay();
    showAlert('收款成功！');
}

        async function aiAcceptTransfer(messageId) {
    const history = [...(chatHistories[currentChatFriendId] || [])];
    const msgIndex = history.findIndex(m => m.id === messageId);
    if (msgIndex === -1) return;

    const msg = history[msgIndex];
    if (!msg || msg.transfer_status !== 'pending' || msg.type !== 'sent') return;

    const transferData = JSON.parse(msg.content);
    const friend = friends.find(f => f.id === currentChatFriendId);
    
    // 步骤1：在后台数据中，更新旧转账卡片的状态
    const updatedMsg = { ...msg, transfer_status: 'received' };
    chatHistories[currentChatFriendId][msgIndex] = updatedMsg;

    // 步骤2：在后台数据中，创建一条新的"已收款"确认消息
    const confirmationData = { amount: transferData.amount };
    const confirmationMsg = saveChatMessage(currentChatFriendId, 'received', JSON.stringify(confirmationData), '', friend.id, 'transfer_accepted');
    
    // 步骤3：保存所有数据更改
    await saveData();
    
    // 步骤4：立即在界面上更新显示
    if (currentChatFriendId === friend.id) {
        // 找到旧的转账卡片HTML元素
        const oldCardDiv = document.querySelector(`.message[data-message-id="${messageId}"] .transfer-card`);
        if (oldCardDiv) {
            // 修改它的样式和文字，让它看起来像"已接收"
            oldCardDiv.classList.add('disabled');
            oldCardDiv.onclick = null; // 移除点击事件
            const footer = oldCardDiv.querySelector('.transfer-card-footer');
            if (footer) footer.textContent = '已被接收';
        }
        // 将新的"已收款"确认卡片添加到聊天界面
        addMessageToDOM(confirmationMsg, friend);
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    }
}

        // --- Voice Message Functions ---
        function openVoiceModal() {
            document.getElementById('voiceInputText').value = '';
            document.getElementById('voiceModal').classList.add('show');
        }
        function closeVoiceModal() {
            document.getElementById('voiceModal').classList.remove('show');
        }
        function sendVoiceMessage() {
            const text = document.getElementById('voiceInputText').value.trim();
            if(!text) return showAlert('请输入语音内容');

            const friend = friends.find(f => f.id === currentChatFriendId);
            const messageData = saveChatMessage(currentChatFriendId, 'sent', text, '', null, 'voice');
            addMessageToDOM(messageData, friend);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            closeVoiceModal();
        }
        
        // [FIX & NEW] Location Functions
        const chinaLocations = {
            "北京市": ["东城区", "西城区", "朝阳区", "海淀区", "丰台区", "石景山区", "门头沟区", "房山区", "通州区", "顺义区", "昌平区", "大兴区", "怀柔区", "平谷区", "密云区", "延庆区"],
            "上海市": ["黄浦区", "徐汇区", "长宁区", "静安区", "普陀区", "虹口区", "杨浦区", "闵行区", "宝山区", "嘉定区", "浦东新区", "金山区", "松江区", "青浦区", "奉贤区", "崇明区"],
            "广东省": { "广州市": ["越秀区", "荔湾区", "海珠区", "天河区"], "深圳市": ["福田区", "罗湖区", "南山区"], "武汉市": ["江岸区", "江汉区", "硚口区", "汉阳区", "武昌区", "青山区", "洪山区", "东西湖区", "汉南区", "蔡甸区", "江夏区", "黄陂区", "新洲区"] },
            "湖北省": { "武汉市": ["江岸区", "江汉区", "硚口区", "汉阳区", "武昌区", "青山区", "洪山区"] },
            "江苏省": { "南京市": ["玄武区", "秦淮区", "建邺区", "鼓楼区"], "苏州市": ["姑苏区", "虎丘区", "吴中区"] }
        };

        function getRandomLocation() {
            const provinces = Object.keys(chinaLocations);
            const randomProvince = provinces[Math.floor(Math.random() * provinces.length)];
            const cities = chinaLocations[randomProvince];
            let randomCity, randomDistrict;

            if(Array.isArray(cities)) { // For municipalities like Beijing
                randomCity = randomProvince;
                randomDistrict = cities[Math.floor(Math.random() * cities.length)];
            } else {
                const cityKeys = Object.keys(cities);
                randomCity = cityKeys[Math.floor(Math.random() * cityKeys.length)];
                const districts = cities[randomCity];
                randomDistrict = districts[Math.floor(Math.random() * districts.length)];
            }

            const roads = ["人民", "解放", "中山", "建设", "和平", "新华", "文昌", "大学", "科技", "创新"];
            const randomRoad = roads[Math.floor(Math.random() * roads.length)];

            return `${randomProvince}${randomCity}${randomDistrict}${randomRoad}路${Math.floor(Math.random() * 800) + 1}号`;
        }

        function openLocationModal() {
            hideFunctionMenus();
            document.getElementById('locationNameInput').value = '';
            document.getElementById('sendLocationModal').classList.add('show');
        }

        function confirmSendLocation() {
            const name = document.getElementById('locationNameInput').value.trim();
            if (!name) {
                showAlert('请输入位置名称');
                return;
            }
            
            const fakeAddress = getRandomLocation();
            
            const locationData = { name, address: fakeAddress };
            const friend = friends.find(f => f.id === currentChatFriendId);
            
            const msgData = saveChatMessage(currentChatFriendId, 'sent', JSON.stringify(locationData), '', null, 'location');
            addMessageToDOM(msgData, friend);
            
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            closeLocationModal();
        }

        // --- MODIFIED & REFACTORED: Phone App Logic ---
        function initPhoneApp() {
            document.getElementById('simulatedPhoneScreen').style.display = 'none';
            document.getElementById('phoneCharacterListScreen').style.display = 'block';

            const navBar = document.getElementById('phoneAppNavBar');
            const navTitle = navBar.querySelector('.nav-title');
            navTitle.textContent = '手机';
            navBar.querySelector('*:first-child').innerHTML = `<button class="nav-btn" onclick="goHome()">←</button>`;
            
            const listContainer = document.getElementById('phoneCharacterListScreen');
            listContainer.innerHTML = '';
            const availableFriends = friends.filter(f => !f.isGroup);

            if (availableFriends.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center ; padding: 50px; color: #999;">暂无好友手机可查看</div>';
                return;
            }

            availableFriends.forEach(friend => {
                const item = document.createElement('div');
                item.className = 'friend-item';
                item.onclick = () => openSimulatedPhone(friend.id);
                const avatarHtml = friend.avatarImage 
                    ? `<div class="friend-avatar" style="background-image: url(${friend.avatarImage});"></div>` 
                    : `<div class="friend-avatar">${friend.avatar}</div>`;
                item.innerHTML = `${avatarHtml}<div class="friend-info"><div class="friend-name">${friend.remark || friend.name}</div><div class="friend-message">点击查看Ta的手机</div></div>`;
                listContainer.appendChild(item);
            });
        }

        function openSimulatedPhone(characterId) {
            currentSimPhoneCharacterId = characterId;
            document.getElementById('phoneCharacterListScreen').style.display = 'none';
            document.getElementById('simulatedPhoneScreen').style.display = 'flex';
            
            const character = friends.find(f => f.id === characterId);
            const navBar = document.getElementById('phoneAppNavBar');
            navBar.querySelector('.nav-title').textContent = `${character.name}的手机`;
            navBar.querySelector('*:first-child').innerHTML = `<button class="nav-btn" onclick="backToPhoneAppHome()">←</button>`;
            
            backToSimHomeScreen();
        }
        
        function backToPhoneAppHome() {
            currentSimPhoneCharacterId = null;
            initPhoneApp();
        }
        
        function backToSimHomeScreen() {
            document.querySelectorAll('.sim-app-view').forEach(view => view.classList.remove('active'));
        }

        async function openSimApp(appName) {
            const view = document.getElementById(`sim-${appName}-view`);
            if (!view || !currentSimPhoneCharacterId) return;

            document.querySelectorAll('.sim-app-view').forEach(v => v.classList.remove('active'));
            view.classList.add('active');
            view.innerHTML = `<div class="sim-loading-overlay">正在加载内容...</div>`;

            const characterId = currentSimPhoneCharacterId;
            const now = Date.now();
            
            const cached = (simPhoneContentCache[characterId] || {})[appName];
            if (cached && (now - cached.timestamp < SIM_CACHE_DURATION)) {
                renderSimAppList(appName, cached.data);
                return;
            }
            
            await generateSimAppContent(characterId, appName);
        }

        async function generateSimAppContent(characterId, appName, retryCount = 0) {
            const character = friends.find(f => f.id === characterId);
            if (!character) return;
            
            const chatHistorySummary = (chatHistories[characterId] || []).slice(-10).map(m => `${m.type === 'sent' ? userProfile.name : character.name}: ${m.content.substring(0, 30)}...`).join('\n');

            let prompt = `你正在模拟角色"${character.name}"的手机。
角色人设: ${character.role}
最近与用户"${userProfile.name}"的聊天摘要:
${chatHistorySummary || '暂无聊天记录。'}

你的回复必须是一个符合要求的JSON对象，并且内容中绝对不能包含任何emoji表情或特殊字符。`;

            switch(appName) {
                case 'memo':
                    prompt += `\n生成5条符合人设的备忘录。每条必须包含id, title, content (完整的备忘录内容), 和datetime。JSON格式: {"memos": [{"id": "memo_1", "title": "标题", "content": "完整的备忘录内容...", "datetime": "YYYY-MM-DD HH:MM"}, ...]}`;
                    break;
                case 'wechat':
                    prompt += `\n生成4个与【除了用户'${userProfile.name}'之外的】虚构人物的微信聊天摘要，模拟出生活气息。**绝对不能**生成与'${userProfile.name}'的聊天。每个摘要必须包含id, name, avatar(单个汉字), 和一个包含10条对话记录的 "messages" 数组。JSON格式: {"chats": [{"id": "chat_1", "name": "聊天对象", "avatar": "单个汉字", "messages": [{"sender": "发送者名字", "content": "消息内容"}, ...]}, ...]}`;
                    break;
                case 'browser':
                    prompt += `\n生成8条浏览器历史记录。每条必须包含id, title, url (一个模拟的网址), 和一个符合标题的、内容详细丰富的 "content" (模拟的网页或论坛帖子内容, 包含换行和分段，至少200字)。JSON格式: {"history": [{"id": "history_1", "title": "搜索或网页标题", "url": "https://example.com/path", "content": "详细的文章或帖子内容...\\n\\n包含换行和分段。"}, ...]}`;
                    break;
                case 'shopping':
                    prompt += `\n生成5条最近的购物订单。每条必须包含id, name, price, 和一个详细的 "description" (商品描述)。JSON格式: {"orders": [{"id": "order_1", "name": "商品名称", "price": "价格", "description": "商品详细描述..."}, ...]}`;
                    break;
                case 'wallet':
                    prompt += `\n根据人设（${character.role}）判断角色的经济状况，生成一个随机余额和6条交易记录。每条必须包含description, amount (+/-金额), 和time。JSON格式: {"balance": "余额", "transactions": [{"description": "交易描述", "amount": "+/-金额", "time": "MM-DD HH:mm"}, ...]}`;
                    break;
                case 'photos':
                    prompt += `\n生成6张符合人设的相册照片的标题和详细文字描述。每条必须包含id, title, 和 "description"。description必须分为两段，用"\\n\\n"隔开。第一段详细描述照片画面；第二段深入描述角色对这张照片的感受、回忆或想法。每段至少50字。JSON格式: {"photos": [{"id": "photo_1", "title": "照片标题", "description": "对照片画面的详细描述...\\n\\n角色的个人感受和想法..."}, ...]}`;
                    break;
                case 'phone_call':
                    prompt += `\n生成8条通话记录。每条必须包含name, type (incoming/outgoing/missed), 和time。JSON格式: {"calls": [{"name": "联系人名", "type": "incoming", "time": "时间描述"}, ...]}`;
                    break;
            }

            const settings = await dbManager.get('apiSettings');
            if (!settings.apiUrl || !settings.apiKey) {
                renderSimAppList(appName, { error: "API未配置" });
                return;
            }
            
            try {
                const response = await fetch(`${settings.apiUrl}/chat/completions`, { method: 'POST', headers: { 'Authorization': `Bearer ${settings.apiKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: settings.modelName, messages: [{role: 'user', content: prompt}], response_format: { type: 'json_object' } }) });
                if(!response.ok) throw new Error(`API请求失败: ${response.status}`);
                const data = await response.json();
                
                const responseText = data.choices[0].message.content;
                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("AI未返回有效的JSON格式。");
                const content = JSON.parse(jsonMatch[0]);

                if (!simPhoneContentCache[characterId]) simPhoneContentCache[characterId] = {};
                simPhoneContentCache[characterId][appName] = { data: content, timestamp: Date.now() };
                await saveData();
                renderSimAppList(appName, content);
            } catch(e) {
                console.error(`生成模拟内容失败 (尝试次数 ${retryCount + 1}):`, e);
                if (retryCount < 2) {
                    await new Promise(res => setTimeout(res, 500));
                    await generateSimAppContent(characterId, appName, retryCount + 1);
                } else {
                    renderSimAppList(appName, { error: "内容生成失败，请重试。" });
                }
            }
        }

        function renderSimAppList(appName, data) {
            const view = document.getElementById(`sim-${appName}-view`);
            if (!view) return;
            const headerMap = { wechat: '微信', memo: '备忘录', phone_call: '通话记录', browser: '浏览器', shopping: '购物', wallet: '钱包', photos: '相册' };
            const backFn = 'backToSimHomeScreen()';
            let contentHTML = '';

            if (data.error) {
                contentHTML = `<div style="text-align:center; padding: 40px;">${data.error}</div>`;
            } else {
                 switch(appName) {
                    case 'memo':
                        contentHTML = (data.memos || []).map(item => {
                            const itemJsonString = JSON.stringify(item).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            return `<div class="sim-memo-item" onclick='renderSimAppDetail("memo", ${itemJsonString})'>
                                <div class="sim-memo-title">${item.title}</div>
                                <div class="sim-memo-content">${(item.content || '').substring(0, 50)}...</div>
                                <div class="sim-memo-datetime">${item.datetime}</div>
                            </div>`;
                        }).join('');
                        break;
                    case 'wechat':
                        const character = friends.find(f => f.id === currentSimPhoneCharacterId);
                        const realChatHistory = (chatHistories[character.id] || []).slice(-10);
                        const realChat = {
                            id: 'chat_with_user',
                            name: userProfile.name,
                            avatar: userProfile.avatar || userProfile.name.substring(0,1),
                            avatarImage: userProfile.avatarImage,
                            messages: realChatHistory.map(msg => ({
                                sender: msg.type === 'sent' ? userProfile.name : character.name,
                                content: msg.content,
                                type: msg.type
                            }))
                        };
                        const allChats = [realChat, ...(data.chats || [])];
                        contentHTML = '<div class="friend-list">' + allChats.map(item => {
                            const itemJsonString = JSON.stringify(item).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            const avatarHtml = item.avatarImage ? `<div class="friend-avatar" style="background-image: url(${item.avatarImage})"></div>` : `<div class="friend-avatar">${item.avatar}</div>`;
                            return `<div class="friend-item" onclick='renderSimAppDetail("wechat", ${itemJsonString})'>
                                ${avatarHtml}
                                <div class="friend-info">
                                    <div class="friend-name">${item.name}</div>
                                    <div class="friend-message">${item.messages[item.messages.length - 1]?.content.substring(0, 30) || ''}...</div>
                                </div>
                            </div>`;
                        }).join('') + '</div>';
                        break;
                    case 'browser':
                        contentHTML = (data.history || []).map(item => {
                            const itemJsonString = JSON.stringify(item).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            return `<div class="sim-browser-item" onclick='renderSimAppDetail("browser", ${itemJsonString})'>
                                <div class="sim-browser-title">${item.title}</div>
                                <div class="sim-browser-url">${item.url}</div>
                            </div>`;
                        }).join('');
                        break;
                    case 'shopping':
                        contentHTML = (data.orders || []).map(item => {
                             const itemJsonString = JSON.stringify(item).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                             return `<div class="sim-shopping-item" onclick='renderSimAppDetail("shopping", ${itemJsonString})'>
                                <div class="sim-shopping-title">${item.name}</div>
                                <div class="sim-shopping-details"><strong>¥${item.price}</strong></div>
                             </div>`;
                        }).join('');
                        break;
                    case 'photos':
                        contentHTML = '<div class="sim-photos-grid">' + (data.photos || []).map(item => {
                            const itemJsonString = JSON.stringify(item).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            return `<div class="sim-photo-thumb" onclick='renderSimAppDetail("photos", ${itemJsonString})'>
                                <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                            </div>`;
                        }).join('') + '</div>';
                        break;
                    case 'phone_call':
                        const callIcons = { incoming: '↙', outgoing: '↗', missed: '↙' };
                        const callColors = { incoming: 'var(--text-color)', outgoing: 'var(--text-color)', missed: 'red' };
                        contentHTML = (data.calls || []).map(item => `<div class="sim-call-item"><div class="sim-call-type" style="color: ${callColors[item.type] || 'var(--text-color)'}">${callIcons[item.type] || ''}</div><div class="sim-call-info"><div class="sim-call-name" style="color: ${item.type === 'missed' ? 'red' : 'var(--text-color)'}">${item.name}</div><div class="sim-call-detail">${item.time}</div></div></div>`).join('');
                        break;
                     case 'wallet':
                        let balance = parseFloat(data.balance || 0).toFixed(2);
                        contentHTML = `<div class="sim-wallet-balance"><div>余额</div><div class="sim-wallet-amount">¥ ${balance}</div></div>`;
                        contentHTML += (data.transactions || []).map(item => `<div class="sim-wallet-item"><div><div>${item.description}</div><div style="font-size:12px; color: #999;">${item.time || ''}</div></div><div class="amount ${parseFloat(item.amount) > 0 ? 'positive' : 'negative'}">${item.amount}</div></div>`).join('');
                        break;
                }
            }

            view.innerHTML = `
                <div class="sim-app-header">
                    <button class="sim-app-header-btn" onclick="${backFn}">‹</button>
                    <div class="sim-app-header-title">${headerMap[appName]}</div>
                    <div style="width: 50px;"></div>
                </div>
                <div class="sim-app-content">${contentHTML}</div>
            `;
        }

        function renderSimAppDetail(appName, detailItem) {
            const detailView = document.getElementById(`sim-${appName}-detail-view`);
            const listView = document.getElementById(`sim-${appName}-view`);
            if (!detailView || !listView) return;

            listView.classList.remove('active');
            detailView.classList.add('active');

            const backFn = `document.getElementById('sim-${appName}-detail-view').classList.remove('active'); document.getElementById('sim-${appName}-view').classList.add('active');`;
            let headerTitle = detailItem.title || detailItem.name || '详情';
            let contentHTML = '';

            switch(appName) {
                case 'memo':
                    contentHTML = `<div class="sim-detail-content">${(detailItem.content || '').replace(/\n/g, '<br>')}</div>`;
                    break;
                case 'wechat':
                    const character = friends.find(f => f.id === currentSimPhoneCharacterId);
                    const isRealChat = detailItem.id === 'chat_with_user';
                    contentHTML = `<div class="chat-messages" style="padding: 10px; height: 100%; overflow-y: auto; background-color: #ededee;">` + 
                    (detailItem.messages || []).map(msg => {
                        const isCharacterSender = msg.sender === character.name;
                        let type;
                        if (isRealChat) {
                            type = msg.type === 'sent' ? 'received' : 'sent';
                        } else {
                            type = isCharacterSender ? 'sent' : 'received';
                        }
                        const sender = (type === 'sent') 
                            ? character 
                            : (isRealChat ? userProfile : { name: detailItem.name, avatar: detailItem.avatar, avatarImage: ''});
                        const messageHtml = `
                            <div class="message ${type}">
                                ${type === 'received' ? getAvatarHtml(sender) : ''}
                                <div class="message-body">
                                    <div class="message-content">${msg.content}</div>
                                </div>
                                ${type === 'sent' ? getAvatarHtml(sender) : ''}
                            </div>`;
                        return messageHtml;
                    }).join('') + `</div>`;
                    break;
                case 'browser':
                    contentHTML = `<div class="sim-detail-content"><h3>${detailItem.title}</h3><hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;"><p>${(detailItem.content || '').replace(/\n/g, '<br>')}</p></div>`;
                    break;
                case 'shopping':
                    const encodedName = encodeURIComponent(detailItem.name);
                    const imageUrl = `https://placehold.co/400x400/f0f0f0/ccc?text=${encodedName}`;
                    contentHTML = `<div class="sim-detail-content">
                        <div class="sim-shopping-image-placeholder"><img src="${imageUrl}" alt="${detailItem.name}"></div>
                        <h3>${detailItem.name}</h3>
                        <p style="font-size: 20px; font-weight: bold; margin: 10px 0;">¥${detailItem.price}</p>
                        <p>${detailItem.description || '暂无商品详情。'}</p>
                    </div>`;
                    break;
                case 'photos':
                    headerTitle = '照片详情';
                    contentHTML = `<div class="sim-detail-content">
                        <div class="sim-shopping-image-placeholder"><svg viewBox="0 0 24 24" width="50" height="50" fill="#ccc"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div>
                        <p>${detailItem.description || '这张照片里什么也没有...'}</p>
                    </div>`;
                    break;
            }

            detailView.innerHTML = `
                <div class="sim-app-header">
                    <button class="sim-app-header-btn" onclick="${backFn}">‹</button>
                    <div class="sim-app-header-title">${headerTitle}</div>
                    <div style="width: 50px;"></div>
                </div>
                <div class="sim-app-content">${contentHTML}</div>
            `;
        }

        window.onload = async function() {
    await dbManager.init(); // 确保 IndexedDB 已初始化
    
    // 在这里调用请求持久性存储的函数
    await requestPersistentStorage(); 

    await loadData();
    updateFriendList();
    updateTime();
    setActivePage('homeScreen');
    
    // ... (你 window.onload 中其余的代码)
            
            audioElement = document.getElementById('audioPlayer');
            
            audioElement.addEventListener('play', () => {
                document.getElementById('vinylRecord').classList.add('playing');
                document.getElementById('playPauseBtn').innerHTML = `<svg viewBox="0 0 24 24"><path d="M14 19h4V5h-4v14zm-10 0h4V5H4v14z"/></svg>`;
            });
            audioElement.addEventListener('pause', () => {
                document.getElementById('vinylRecord').classList.remove('playing');
                 document.getElementById('playPauseBtn').innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
            });
            audioElement.addEventListener('ended', () => {
                if(isRepeat) playSong(currentSongIndex);
                else nextSong();
            });
            audioElement.addEventListener('timeupdate', () => {
                const progressBar = document.getElementById('songProgressBar');
                progressBar.value = audioElement.currentTime;
                document.getElementById('currentTimeLabel').textContent = formatTime(audioElement.currentTime);
                updateLyrics(audioElement.currentTime);
            });
            audioElement.addEventListener('loadedmetadata', () => {
                const progressBar = document.getElementById('songProgressBar');
                progressBar.max = audioElement.duration;
                document.getElementById('durationLabel').textContent = formatTime(audioElement.duration);
            });

            // Listen Together UI bindings
            document.getElementById('listenBackBtn').addEventListener('click', backToChatFromListen);
            document.getElementById('listenCloseBtn').addEventListener('click', () => terminateListenTogether(null));
            floatingPlayer.addEventListener('click', (e) => {
                 if (e.target.id !== 'floatingPlayerCloseBtn') returnToListenScreen();
            });

            document.getElementById('message-notification').addEventListener('click', (e) => {
                const friendId = e.currentTarget.getAttribute('data-friend-id');
                if (friendId) {
                    e.currentTarget.classList.remove('show');
                    // Ensure the main app is visible before opening chat
                    if(document.getElementById('wechatApp').classList.contains('active')) {
                        openChat(friendId);
                    } else {
                        openApp('wechat');
                        // Use a short timeout to ensure the UI has switched before opening the specific chat
                        setTimeout(() => openChat(friendId), 50);
                    }
                }
            });


            document.getElementById('confirmOkBtn').addEventListener('click', () => { if (typeof confirmCallback === 'function') confirmCallback(true); closeConfirmModal(); });
            document.getElementById('confirmCancelBtn').addEventListener('click',() => { if (typeof confirmCallback === 'function') confirmCallback(false); closeConfirmModal(); });
            document.getElementById('momentCommentSendBtn').addEventListener('click', postComment);
            toggleSendButtonActive(document.getElementById('messageInput'));
            setInterval(simulateAiBehavior, 60000); 
        };
   // 简化版本，仅用于调试
function setRealViewportHeight() {
    console.log('窗口高度:', window.innerHeight, '屏幕高度:', window.screen.height);
}
setRealViewportHeight();
    </script>
    <!-- ↑↑↑ 新的JavaScript代码到此结束 ↑↑↑ -->
    
</body>
</html>

