<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙终极测试工具</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 1rem; background-color: #f0f2f5; color: #333; margin: 0; }
        .container { width: 95%; max-width: 500px; text-align: center; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 1.5rem; margin-top: 1rem; }
        button, #connectButton { background-color: #e60073; color: white; border: none; padding: 15px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:hover, #connectButton:hover { background-color: #c20062; }
        #controls { display: none; }
        label { display: block; margin: 1rem 0 0.5rem 0; font-weight: bold; text-align: left; }
        input[type="range"] { width: 100%; margin-top: 10px; }
        #log { margin-top: 1rem; font-size: 14px; color: #555; background-color: #e9ecef; padding: 10px; border-radius: 5px; min-height: 20px; text-align: left; word-break: break-all; }
        .checkbox-container { display: flex; align-items: center; justify-content: flex-start; margin-top: 1rem; }
        .checkbox-container input { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>蓝牙终极测试工具</h1>
        <p id="status">请点击下方按钮连接设备</p>
        <button id="connectButton">连接设备 (QCSW)</button>

        <div id="controls" class="card">
            <h3>测试说明</h3>
            <p style="text-align: left; font-size: 14px;">1. 连接设备。<br>2. <strong>勾选下面的“持续发送”复选框。</strong><br>3. <strong>慢慢地从左到右拖动强度滑块。</strong><br>4. 观察设备是否有反应。</p>
            
            <hr>

            <label for="intensitySlider">强度: <span id="intensityValue">0</span></label>
            <input type="range" id="intensitySlider" min="0" max="100" value="0">
            
            <div class="checkbox-container">
                <input type="checkbox" id="keepSendingCheckbox">
                <label for="keepSendingCheckbox" style="margin: 0;">持续发送指令</label>
            </div>
            
            <button id="stopButton" style="background-color: #dc3545; width: 100%; margin-top: 1.5rem;">紧急停止</button>

            <div id="log">等待操作...</div>
        </div>
    </div>

    <script>
        const SERVICE_UUID = '00001000-0000-1000-8000-008059fb34fb';
        const CHARACTERISTIC_UUID = '00001001-0000-1000-8000-008059fb34fb';

        const connectButton = document.getElementById('connectButton');
        const controls = document.getElementById('controls');
        const statusDisplay = document.getElementById('status');
        const intensitySlider = document.getElementById('intensitySlider');
        const intensityValue = document.getElementById('intensityValue');
        const keepSendingCheckbox = document.getElementById('keepSendingCheckbox');
        const stopButton = document.getElementById('stopButton');
        const log = document.getElementById('log');

        let controlCharacteristic;
        let repeaterInterval = null;

        function logMessage(message) {
            console.log(message);
            log.textContent = message;
        }

        connectButton.addEventListener('click', async () => {
            try {
                logMessage('请求设备...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'QCSW' }],
                    optionalServices: [SERVICE_UUID]
                });
                device.addEventListener('gattserverdisconnected', onDisconnected);
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                controlCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                logMessage('连接成功！请按说明操作。');
                statusDisplay.textContent = '设备已连接';
                connectButton.style.display = 'none';
                controls.style.display = 'block';
            } catch (error) {
                logMessage(`连接失败: ${error}`);
                alert('连接失败: ' + error);
            }
        });

        function onDisconnected() {
            logMessage('设备已断开');
            statusDisplay.textContent = '设备已断开，请重新连接';
            connectButton.style.display = 'block';
            controls.style.display = 'none';
            stopRepeater();
        }

        async function sendCommand(commandArray) {
            if (!controlCharacteristic) return;
            try {
                const command = Uint8Array.from(commandArray);
                await controlCharacteristic.writeValueWithoutResponse(command);
                logMessage(`持续发送: [${command.join(', ')}]`);
            } catch (error) {
                logMessage(`发送失败: ${error}`);
                stopRepeater(); // Stop on error
            }
        }

        function startRepeater() {
            stopRepeater(); // Clear any existing interval first
            const value = parseInt(intensitySlider.value);
            if (value === 0) {
                sendCommand([0]); // Send a single stop command
                return;
            }
            repeaterInterval = setInterval(() => {
                // 我们使用最基础的单字节指令进行持续发送，这是最有可能成功的
                sendCommand([parseInt(intensitySlider.value)]);
            }, 200); // 每200毫秒发送一次
        }

        function stopRepeater() {
            if (repeaterInterval) {
                clearInterval(repeaterInterval);
                repeaterInterval = null;
                sendCommand([0]); // Send a final stop command
                logMessage('持续发送已停止。');
            }
        }
        
        intensitySlider.addEventListener('input', () => {
            const value = parseInt(intensitySlider.value);
            intensityValue.textContent = value;
            if (keepSendingCheckbox.checked) {
                if (value > 0) {
                    startRepeater();
                } else {
                    stopRepeater();
                }
            }
        });

        keepSendingCheckbox.addEventListener('change', () => {
            if (keepSendingCheckbox.checked) {
                startRepeater();
            } else {
                stopRepeater();
            }
        });
        
        stopButton.addEventListener('click', () => {
            intensitySlider.value = 0;
            intensityValue.textContent = 0;
            keepSendingCheckbox.checked = false;
            stopRepeater();
        });

    </script>
</body>
</html>
