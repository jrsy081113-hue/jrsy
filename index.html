<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙指令探索工具</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 1rem; background-color: #f0f2f5; color: #333; margin: 0; }
        .container { width: 95%; max-width: 500px; text-align: center; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 1.5rem; margin-top: 1rem; }
        button, #connectButton { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:hover, #connectButton:hover { background-color: #0056b3; }
        #controls { display: none; }
        label { display: block; margin: 1rem 0 0.5rem 0; font-weight: bold; text-align: left; }
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; margin-top: 0.5rem;}
        .grid button { background-color: #6c757d; padding: 10px 5px; }
        #log { margin-top: 1rem; font-size: 14px; color: #555; background-color: #e9ecef; padding: 10px; border-radius: 5px; min-height: 20px; text-align: left; word-break: break-all; }
    </style>
</head>
<body>
    <div class="container">
        <h1>蓝牙指令探索工具</h1>
        <p id="status">请点击下方按钮连接设备</p>
        <button id="connectButton">连接设备 (QCSW)</button>

        <div id="controls" class="card">
            
            <label for="manualCommand">手动发送指令 (用逗号分隔, 如 85,4,1,50,170)</label>
            <input type="text" id="manualCommand" placeholder="例如: 85, 4, 1, 50, 170">
            <button id="sendCommandButton" style="margin-top: 0.5rem; width: 100%;">发送</button>
            
            <hr style="margin: 2rem 0;">

            <label>单字节快速测试 (0-20)</label>
            <div class="grid" id="byteGrid"></div>

            <div id="log">等待操作...</div>
        </div>
    </div>

    <script>
        // UUIDs
        const SERVICE_UUID = '00001000-0000-1000-8000-00805f9b34fb';
        const CHARACTERISTIC_UUID = '00001001-0000-1000-8000-00805f9b34fb';

        // DOM Elements
        const connectButton = document.getElementById('connectButton');
        const controls = document.getElementById('controls');
        const statusDisplay = document.getElementById('status');
        const manualCommandInput = document.getElementById('manualCommand');
        const sendCommandButton = document.getElementById('sendCommandButton');
        const byteGrid = document.getElementById('byteGrid');
        const log = document.getElementById('log');

        let controlCharacteristic;

        function logMessage(message) {
            console.log(message);
            log.textContent = message;
        }

        // Populate byte grid
        for (let i = 0; i <= 20; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.onclick = () => {
                manualCommandInput.value = i;
                sendCommand([i]);
            };
            byteGrid.appendChild(btn);
        }

        connectButton.addEventListener('click', async () => {
            try {
                logMessage('请求设备...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'QCSW' }],
                    optionalServices: [SERVICE_UUID]
                });
                device.addEventListener('gattserverdisconnected', () => {
                    logMessage('设备已断开');
                    statusDisplay.textContent = '设备已断开，请重新连接';
                    connectButton.style.display = 'block';
                    controls.style.display = 'none';
                });
                logMessage('连接到GATT服务器...');
                const server = await device.gatt.connect();
                logMessage('获取服务...');
                const service = await server.getPrimaryService(SERVICE_UUID);
                logMessage('获取特征...');
                controlCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                logMessage('连接成功！');
                statusDisplay.textContent = '设备已连接';
                connectButton.style.display = 'none';
                controls.style.display = 'block';
            } catch (error) {
                logMessage(`连接失败: ${error}`);
                alert('连接失败: ' + error);
            }
        });

        async function sendCommand(commandArray) {
            if (!controlCharacteristic) {
                logMessage('特征不可用');
                return;
            }
            try {
                // Ensure all elements are numbers
                const numericArray = commandArray.map(val => Number(val.toString().trim())).filter(val => !isNaN(val));
                if(numericArray.length === 0) {
                    logMessage('无效指令，请输入数字');
                    return;
                }
                const command = Uint8Array.from(numericArray);
                await controlCharacteristic.writeValueWithoutResponse(command);
                const hexString = Array.from(command).map(b => '0x' + b.toString(16).padStart(2, '0')).join(', ');
                logMessage(`指令已发送: [${command.join(', ')}] (${hexString})`);
            } catch (error) {
                logMessage(`发送失败: ${error}`);
            }
        }
        
        sendCommandButton.addEventListener('click', () => {
            const commandStr = manualCommandInput.value;
            if (commandStr) {
                const commandArray = commandStr.split(',');
                sendCommand(commandArray);
            }
        });

    </script>
</body>
</html>
